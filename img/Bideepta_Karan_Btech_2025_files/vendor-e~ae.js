"use strict";(self.webpackChunk_grammarly_denali_app=self.webpackChunk_grammarly_denali_app||[]).push([[741],{76035:(e,t,i)=>{i.d(t,{T:()=>v});var n=i(19147),s=i(6922),r=i(23988),o=i(10334),a=i(17171),c=i(58889),d=i(44297),l=i(83293),h=i(29052),u=i(30040),_=i(45116),p=i(87626),g=i(49984),m=i(49361),f=i(48690),v=function(){function e(t,i,s,o,a){(0,n._)(this,e),(0,r._)(this,"_storage",void 0),(0,r._)(this,"_sendStorageMessage",void 0),(0,r._)(this,"_canSaveEntryToStorage",void 0),(0,r._)(this,"getCAPIWSMessageSizeLimit",void 0),(0,r._)(this,"_monitoringHandler",void 0),(0,r._)(this,"_guardStorageServerMessage",void 0),this._storage=t,this._sendStorageMessage=i,this._canSaveEntryToStorage=s,this.getCAPIWSMessageSizeLimit=o,this._monitoringHandler=a,this._guardStorageServerMessage=p.n(_.Schemable)(m.FA.ServerMessageImplementations)}return(0,s._)(e,[{key:"handleMessage",value:function(e){return this._guardStorageServerMessage.is(e)?(this._handleStorageMessage(e),!0):!!m.Hi.is(e)}},{key:"_handleStorageMessage",value:function(e){var t=this;switch(e.action){case"storage:get":return(0,u.pipe)(this._storage.get((0,a._)((0,o._)({},e),{maxResponseSize:(0,u.pipe)(this.getCAPIWSMessageSizeLimit(),d.map((function(e){return e-1e3})),d.toUndefined)})),h.bK((function(i){return(0,u.pipe)(t._sendStorageMessage({id:e.id,action:"storage:entries",data:i.entries}),h.wu((function(e){return new g.aq("Error sending storage:entries",e)}),(function(){return{data:i}})))})),l.map(c.fold((function(i){return t._monitoringHandler.onStorageGetError({request:e,error:i})}),(function(i){var n=i.data;t._monitoringHandler.onStorageGetSuccess({request:e,entriesCount:n.entries.length,entriesDropped:n.entriesDropped})}))))().catch((function(i){return t._monitoringHandler.onStorageGetError({request:e,error:new g.aq("Promise rejection",i)})}));case"storage:clear":return(0,u.pipe)(this._storage.clear(e),l.map(c.fold((function(i){return t._monitoringHandler.onStorageClearError({request:e,error:i})}),(function(){return t._monitoringHandler.onStorageClearSuccess({request:e})}))))().catch((function(i){return t._monitoringHandler.onStorageClearError({request:e,error:new g.aq("Promise rejection",i)})}));case"storage:save":return this._canSaveEntryToStorage.catch((function(){return!1})).then((function(i){return i?(0,u.pipe)(t._storage.save(e),l.map(c.fold((function(i){return t._monitoringHandler.onStorageSaveError({request:e,error:i})}),(function(){return t._monitoringHandler.onStorageSaveSuccess({request:e,bytesCount:(0,f.d)(e.data)})}))))().catch((function(i){return t._monitoringHandler.onStorageSaveError({request:e,error:new g.aq("Promise rejection",i)})})):t._monitoringHandler.onCannotSaveEntry({request:e})}));default:return(0,u.absurd)(e)}}}]),e}()},66919:(e,t,i)=>{i.d(t,{t:()=>n});const n="CHEETAH"},79642:(e,t,i)=>{i.d(t,{v:()=>_});var n=i(44297),s=i(30040),r=i(80837),o=i(78339),a=i(15491),c=i(90405),d=i(36094),l=i(80074),h=i(13448),u=i(7808);class _{constructor(e,t){this._capiService=e,this._genAIFeaturesState=t,this._subs=new r.y.Keeper,this._availability=l.s.create({kind:u.y.Kind.pending,userSettings:{inlineQuickReplyEnabled:!1,inlineRewriteEnabled:!1}}),this.availability=this._availability.view(),this._subs.push(this._genAIFeaturesState.subscribe((e=>{this._availability.set(e.enabled?u.y.fromUserState(e.userState):{kind:u.y.Kind.unavailable})}))),this._subs.push((0,s.pipe)(this._capiService.relevantInboundCAPIMessages,o.p(h.Bw.CheetahInboundCAPIMessage.is),a.T((e=>"cheetah:setUserState"===e.action?n.some(e.state):n.none)),c.oE,a.T(u.y.fromUserState)).subscribe(d.H9(this._availability))),this._subs.push((0,s.pipe)(this._capiService.relevantInboundCAPIMessages,o.p(h.Bw.CheetahInboundCAPIMessage.is),a.T((e=>{switch(e.action){case"cheetah:setContext":case"cheetah:result":return n.some(e.usage);default:return n.none}})),c.oE,a.T((e=>u.y.updateUsage(this._availability.get(),e)))).subscribe(d.H9(this._availability)))}dispose(){this._subs.dispose()}}},71883:(e,t,i)=>{i.d(t,{E:()=>C});var n=i(83531),s=i(19147),r=i(6922),o=i(23988),a=i(10334),c=i(17171),d=i(69384),l=i(91817),h=i(1059),u=i(63336),_=i(58193),p=i(86562),g=i(58889),m=i(44297),f=i(36840),v=i(69063),b=i(52138),S=i(12704),y=i(79622),C=function(){function e(t,i,n){var r=this;(0,s._)(this,e);var h=t.handler,C=t.reconnectHandler,k=void 0===C?b.C.getDefaultReconnect(b.C.ClientType.capi):C,I=t.maxReconnectDelay,A=t.baseReconnectDelay,w=(0,d._)(t,["handler","reconnectHandler","maxReconnectDelay","baseReconnectDelay"]);(0,o._)(this,"_connect",void 0),(0,o._)(this,"_ws",void 0),(0,o._)(this,"_log",void 0),(0,o._)(this,"_contentSource",void 0),(0,o._)(this,"_onConnectionFailed",void 0),(0,o._)(this,"_onConnectionSuccess",void 0),(0,o._)(this,"_capi",void 0),(0,o._)(this,"_conn",void 0),(0,o._)(this,"_isIdle",void 0),(0,o._)(this,"_isStarted",void 0),(0,o._)(this,"_currentSessionId",void 0),(0,o._)(this,"_maxWsMessageSize",void 0),(0,o._)(this,"_handler",void 0),(0,o._)(this,"_getSessionId",void 0),this._connect=i,this._ws=n,this._log=v.Bx.Logging.getLogger("coreclients.capi.connection"),this._isIdle=!1,this._isStarted=!1,this._currentSessionId=_.Ie(),this._maxWsMessageSize=_.Ie(),this._getSessionId=function(){return r._currentSessionId};var R=(0,c._)((0,a._)({},h||{}),{onError:function(e){var t,i,n,s;null===(t=(i=r)._onConnectionFailed)||void 0===t||t.call(i,new Error("Server Error during session start: code(".concat(e.error,") severity(").concat(e.severity,")"))),null===(s=h)||void 0===s||null===(n=s.onError)||void 0===n||n.call(s,e)},onWaitForOT:function(e){var t,i;(0,p.V1)(void 0!==r._onConnectionSuccess&&void 0!==r._onConnectionFailed,"expected initial connect promise to be initialized at this stage"),r._log.trace("sending initial reset Delta to CAPI"),r._capi.pushChanges(r._contentSource())().then(g.fold((function(e){r._onConnectionFailed(e),r._onConnectionFailed=void 0}),m.fold(f.Yi,(function(e){r._onConnectionSuccess(e),r._onConnectionSuccess=void 0})))),null===(i=h)||void 0===i||null===(t=i.onWaitForOT)||void 0===t||t.call(i,e)},onSessionStarted:function(e){var t,i;e.isNewSession||(r._onConnectionSuccess(),r._onConnectionSuccess=void 0),r._currentSessionId=m.some(e.sessionUuid),r._maxWsMessageSize=m.some(e.maxWsMessageSize),null===(i=h)||void 0===i||null===(t=i.onSessionStarted)||void 0===t||t.call(i,e)}});this._handler=Object.assign(new S.T,R),this._ws.onMessage((function(e,t){r._capi.isStable(t)&&E.reset()})).onConnecting((function(){r._isIdle=!1})).onConnect((function(){return r._handler.onConnect({kind:"connect"})})).onDisconnect((function(e){if(r._currentSessionId=m.none,!r._capi.isClosed()){var t={canGoIdle:r._capi.canGoIdle(),isStable:r._capi.isStable()};r._log.debug("calling reconnect handler:",t),(0,u.pipe)(k(e,E,t),(function(t){return r._handler.onDisconnect({kind:"disconnect",reason:e,reconnectCounter:E.retryStatus.iterNumber,reconnectResult:t}),t}),g.fold((function(e){r._log.warn("error reconnecting, closing CAPI:",e.message),r._capi.close("error reconnecting:"+e.message)}),(function(e){"idle"===e.kind&&(r._isIdle=!0)})))}}));var E=new b.C.ReconnectSchedulerImpl((function(){return r.connect(r._contentSource).then((function(e){var t=(0,l._)(e,2),i=t[0];return t[1],i}))}),[b.C.defaultRetryPolicy(A,I)]);this._capi=new y.n0(w,this._handler,this._ws,{getSessionId:this._getSessionId,getMaxWsMessageSize:function(){return r._maxWsMessageSize}})}return(0,r._)(e,[{key:"connect",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this;return(0,n._)((function(){var n;return(0,h.YH)(this,(function(s){switch(s.label){case 0:return(0,p.V1)(!i._capi.isClosed(),"cannot connect when CAPI is closed"),t||i._capi.resetReconnectInfo(),i._isIdle=!1,i._isStarted=!0,i._contentSource=e,i._log.trace("connect: initializing new ws connection"),[4,i._connect(i._ws)];case 1:return n=s.sent(),i._conn=n,[2,new Promise((function(e,t){i._onConnectionFailed=t,i._onConnectionSuccess=function(t){return e(t?[n,t]:[n])},setTimeout((function(){return t("failed to reconnect or connect to new CAPI session")}),5e3)}))]}}))}))()}},{key:"close",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:b.C.WsCodes.NORMAL_CLOSURE,t=arguments.length>1?arguments[1]:void 0,i=this;return(0,n._)((function(){var n;return(0,h.YH)(this,(function(s){switch(s.label){case 0:return n=Boolean(t)?t:"CAPI WS Close called",i._log.trace("close: closing CAPI because: ".concat(n)),[4,i._capi.close(n)];case 1:return s.sent(),i._conn?(i._log.debug("close: closing connection because: ".concat(n)),[4,i._conn.close({code:e,reason:n})]):[3,3];case 2:s.sent(),s.label=3;case 3:return[2]}}))}))()}},{key:"isIdle",get:function(){return this._isIdle}},{key:"isDisconnected",get:function(){return this._ws.isDisconnected()}},{key:"wasStarted",get:function(){return this._isStarted}},{key:"client",get:function(){return this._capi}},{key:"maxWsMessageSize",get:function(){return this._maxWsMessageSize}}]),e}()},79622:(e,t,i)=>{i.d(t,{n0:()=>Y,z7:()=>z});var n,s=i(83531),r=i(19147),o=i(6922),a=i(23988),c=i(10334),d=i(17171),l=i(91817),h=i(1059),u=i(30040),_=i(63336),p=i(58889),g=i(29052),m=i(44297),f=i(36840),v=i(86562),b=i(22835),S=i(77396),y=i(69063),C=i(12486),k=i(30720),I=i(69545),A=i(78044),w=i(49004),R=i(91242),E=i(12704),T=i(66799),x=i(54463),F=i(62228),N=i(9899),M=i(10047),D=i(88105);function O(e,t){var i=e.charCodeAt(t),n=e.charCodeAt(t+1);return i>=55296&&i<57344&&n>=56320&&n<57344}function P(e){return function(e){for(var t,i,n=0,s=e.length,r=0;r<s;r++)(t=e.charCodeAt(r))>=55296&&t<57344&&t<56320&&r+1<s&&(i=e.charCodeAt(r+1))>=56320&&i<57344?(n+=4,r++):n+=t<128?1:t<2048?2:3;return n}(e)/1e3}!function(e){var t=e.transformPosition=function(e,t){var i=T.tI.Position.rebase(e,t);return(!0===e.updatable?T.tI.Position.isSquashed(i):!T.tI.Position.hasEqualLength(e,i))?m.none:m.some(b.yo(e,i))};e.transformAlertChanged=function(e,t){if(0===t.delta.ops.length)return m.some(b.yo(e,{rev:t.revision}));if(void 0!==e.transformJson){var i=T.r5.rebase(e.transformJson,t.delta);return T.r5.isSquashed(i)?m.none:m.some(b.yo(e,{transformJson:i,rev:t.revision}))}return m.some(e)},e.transformAlert=function(e,i){if(0===i.delta.ops.length)return m.some(b.yo(e,{rev:i.revision}));var n=(0,u.pipe)(T.tI.hasPosition(e)?t(e,i.delta):m.some(e),m.map((function(e){return b.yo(e,{rev:i.revision})})));return(0,u.pipe)(n,m.chain(T.tI.matchBy(m.some,(function(e){var t=T.r5.rebase(e.transformJson,i.delta);return(!0===e.updatable?T.r5.isSquashed(t):!0!==T.r5.isValidAfterTransform(e.transformJson,t))?m.none:m.some(b.yo(e,{transformJson:t}))}),(function(e){var t=T.r5.rebase(e.subalerts,i.delta);return T.r5.isSquashed(t)?m.none:m.some(b.yo(e,{subalerts:t}))}))))},e.transformAttentionHeatmap=function(e,t){var i=function(e){return e.map((function(e){return T.J5.Range.rebase(e,t.delta)}))},n=i(e.update),s=n.filter(T.J5.Range.isSquashed).map((function(e){return e.id}));return b.yo(e,{rev:t.revision,add:i(e.add).filter((0,u.not)(T.J5.Range.isSquashed)),update:n.filter((0,u.not)(T.J5.Range.isSquashed)),remove:(0,N._)(e.remove).concat((0,N._)(s))})}}(n||(n={}));var U;!function(e){var t=function(e){return"change"===e.kind},i=function(e){return"change_chunked"===e.kind};e.isChange=(0,f.Ub)(t,i),e.isFullChange=t,e.isChunkedChange=i,e.isCmd=function(e){return"cmd"===e.kind},e.isExternalCmd=function(e){return"externalCmd"===e.kind},e.isCmdIncRevision=function(e){return"cmdIncRevision"===e.kind}}(U||(U={}));var q,B=function(){function e(t,i,s,o,c){var d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:100,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:.1,h=this;(0,r._)(this,e),(0,a._)(this,"_shouldIncreaseRevision",void 0),(0,a._)(this,"_acceptHandler",void 0),(0,a._)(this,"_dropHandler",void 0),(0,a._)(this,"_stateChangeHandler",void 0),(0,a._)(this,"_idGenerator",void 0),(0,a._)(this,"_maxMessageSizeKb",void 0),(0,a._)(this,"_messagePaddingKb",void 0),(0,a._)(this,"_log",void 0),(0,a._)(this,"_changes",void 0),(0,a._)(this,"_staged",void 0),(0,a._)(this,"_stagedOperationId",void 0),(0,a._)(this,"_ackedRevisions",void 0),(0,a._)(this,"_revision",void 0),(0,a._)(this,"_stagedAmount",void 0),(0,a._)(this,"transformChangeAgainstQueue",void 0),(0,a._)(this,"_split",void 0),(0,a._)(this,"_incRevision",void 0),(0,a._)(this,"_acceptMessage",void 0),(0,a._)(this,"_dropMessages",void 0),(0,a._)(this,"_updateCheckedTextSize",void 0),this._shouldIncreaseRevision=t,this._acceptHandler=i,this._dropHandler=s,this._stateChangeHandler=o,this._idGenerator=c,this._maxMessageSizeKb=d,this._messagePaddingKb=l,this._log=y.Bx.Logging.getLogger("coreclients.capi.queue",C.$.DEBUG),this._changes=[],this._staged=[],this._stagedOperationId=null,this._stagedAmount=0,this.transformChangeAgainstQueue=function(e){var t=h._getQueuedDeltaAndLatestRevision(e.rev);return n.transformAlertChanged(e,t)},this._split=function(e){var t=JSON.stringify([e.delta]);return h._log.trace("change delta string",{deltasStr:t,size:P(t)}),function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if((0,v.V1)(i<t,"padding must be less than the max message size"),3*e.length/1e3+i<t)return[e];if(P(e)<t-i)return[e];for(var n=Math.max(2,Math.floor(function(e){return 1e3*e}(t-i)/3)),s=Math.ceil(e.length/n),r=new Array(s),o=0,a=0;o<e.length;){var c=O(e,o+n-1)?n-1:n;r[a++]=e.substr(o,c),o+=c}return r}(t,h._maxMessageSizeKb,h._messagePaddingKb)},this._incRevision=function(){return void 0===h._revision?h._revision=0:h._revision+=1},this._acceptMessage=function(e){h._updateCheckedTextSize(e),h._acceptHandler(e)},this._dropMessages=function(e,t){e.forEach(h._updateCheckedTextSize),h._dropHandler(e,t)},this._updateCheckedTextSize=function(e){U.isChange(e)?h._changeStagedAmount(-e.change.amount):("externalCmd"!==e.kind&&h._shouldIncreaseRevision(e.cmd)||"externalCmd"===e.kind&&e.incrementsRevision)&&h._changeStagedAmount(-T.$A)},this._log.debug("capi queue created",{maxMessageSizeKb:this._maxMessageSizeKb,messagePaddingKb:this._messagePaddingKb}),this.clear("init")}return(0,o._)(e,[{key:"pushChanges",value:function(e){var t=this,i=(0,_.pipe)(this._tail(),m.filter(U.isChange));return(0,_.pipe)(i,m.fold((function(){return t._log.trace("pushChanges() adding new change to queue"),t._enqueueChange(e,t._split(e))}),(function(i){t._log.trace("pushChanges() composing with latest change");var n=i.change.compose(e),s=t._split(n);if(t._replaceChange(t._changes.length-1,n,s),!0===n.isEmpty){var r=t._changes.pop();t._stateChangeHandler(t.isEmpty,t.isStaging),setTimeout((function(){return t._acceptMessage(r)}),0)}return i.id})))}},{key:"pushCommand",value:function(e){var t=this._idGenerator();return this._shouldIncreaseRevision(e)?(this._changeStagedAmount(T.$A),this._changes.push({kind:"cmdIncRevision",cmd:e,id:t,rev:this._incRevision()})):this._changes.push({kind:"cmd",cmd:e,id:t,rev:this.localRevision}),this._stateChangeHandler(this.isEmpty,this.isStaging),t}},{key:"pushExternalCommand",value:function(e,t){var i=this,n=this._idGenerator(),s=!1,r=t({id:n,sessionId:e,currentRevision:this.localRevision,nextRevision:function(){return s=!0,i._incRevision()}});s&&this._changeStagedAmount(T.$A);var o=this.localRevision;return this._changes.push({kind:"externalCmd",cmd:r,id:n,rev:o,incrementsRevision:s}),this._stateChangeHandler(this.isEmpty,this.isStaging),n}},{key:"isStaging",get:function(){return this._staged.length>0}},{key:"isEmpty",get:function(){return 0===this._changes.length}},{key:"hasCommitedChanges",get:function(){return this._changes.length>0}},{key:"localRevision",get:function(){return void 0!==this._revision?this._revision:0}},{key:"stagedAmount",get:function(){return this._stagedAmount}},{key:"hasChanges",get:function(){return this._changes.some(U.isChange)}},{key:"size",get:function(){return this._changes.length}},{key:"poll",value:function(){var e=this;return(0,v.V1)(null===this._stagedOperationId,"Should not be in staging mode"),(0,_.pipe)(m.fromNullable(this._changes.shift()),m.map((function(t){return U.isCmd(t)||U.isExternalCmd(t)&&!t.incrementsRevision||e._staged.push(t),e._stagedOperationId=t.id,e._stateChangeHandler(e.isEmpty,e.isStaging),t})))}},{key:"shift",value:function(){var e=m.fromNullable(this._changes.shift());return this._stateChangeHandler(this.isEmpty,this.isStaging),e}},{key:"peek",value:function(){return this.isEmpty?m.none:m.fromNullable(this._changes[0])}},{key:"ackOperation",value:function(e){(0,v.V1)(!!this._stagedOperationId&&e===this._stagedOperationId,"Cannot ack operation by wrong id. Expected: '".concat(this._stagedOperationId,", got: '").concat(e,"'")),this._stagedOperationId=null}},{key:"ackRevision",value:function(e){this._ackedRevisions.add(e),this._cleanStaged()}},{key:"transformAlertAgainstQueue",value:function(e){var t=this._getQueuedDeltaAndLatestRevision(e.rev);return n.transformAlert(e,t)}},{key:"transformAttentionHeatmapAgainstQueue",value:function(e){var t=this._getQueuedDeltaAndLatestRevision(e.rev);return n.transformAttentionHeatmap(e,t)}},{key:"clear",value:function(e){var t=(0,N._)(this._changes).concat((0,N._)(this._staged));this._changes=[],this._staged=[],this._stagedOperationId=null,this._ackedRevisions=new Set,this._revision=void 0,t.length>0&&this._dropMessages(t,e),this._stateChangeHandler(this.isEmpty,this.isStaging)}},{key:"_tail",value:function(){return this.isEmpty?m.none:m.fromNullable(this._changes[this._changes.length-1])}},{key:"_enqueueChange",value:function(e,t){var i,n=this,s=this._incRevision();if(this._changeStagedAmount(e.amount),1===t.length)i=this._idGenerator(),this._changes.push({kind:"change",change:e,id:i,rev:s,deltasString:t[0]});else{this._log.trace("change is larger than maximum allowed size, splitting to chunks",t.length);var r=t.map((function(e){return{id:n._idGenerator(),chunk:e}}));i=this._idGenerator(),this._changes.push({kind:"change_chunked",change:e,id:i,rev:s,chunks:r})}return this._stateChangeHandler(this.isEmpty,this.isStaging),i}},{key:"_replaceChange",value:function(e,t,i){var n=this,s=this._changes[e];(0,v.V1)(U.isChange(s),"queued change should exist");var r=s;this._changeStagedAmount(-r.change.amount+t.amount),i.length>1?this._changes[e]=(0,d._)((0,c._)({},r),{kind:"change_chunked",chunks:i.map((function(e){return{id:n._idGenerator(),chunk:e}}))}):this._changes[e]=(0,d._)((0,c._)({},r),{kind:"change",change:t,deltasString:i[0]})}},{key:"_cleanStaged",value:function(){for(;void 0!==this._staged[0]&&this._ackedRevisions.has(this._staged[0].rev);){var e=this._staged.shift();this._ackedRevisions.delete(e.rev),this._stateChangeHandler(this.isEmpty,this.isStaging),this._acceptMessage(e)}}},{key:"_changeStagedAmount",value:function(e){this._stagedAmount+=e}},{key:"_getQueuedDeltaAndLatestRevision",value:function(e){var t=this._staged.filter((function(t){return t.rev>e})).concat(this._changes).filter(U.isChange);return{delta:D.E.squash(t.map((function(e){return e.change.delta}))),revision:(0,_.pipe)(M.HV(t),m.map((function(e){return e.rev})),m.getOrElse((function(){return e})))}}},{key:"toJSON",value:function(){return{isEmpty:this.isEmpty,isStaging:this.isStaging,changes:this._changes.map((function(e){return U.isChange(e)?{kind:"change",prevLen:e.change.prevLen,changeDiff:e.change.length,changeAmount:e.change.amount}:e}))}}}]),e}();!function(e){e.fromRaw=function(e){return(0,d._)((0,c._)({},e),{suggestionsCard:(0,_.pipe)(m.fromNullable(e.suggestionsCard),m.map((function(e){return{title:e.title,miniTitle:m.fromNullable(e.miniTitle)}}))),successCard:(0,_.pipe)(m.fromNullable(e.successCard),m.map((function(e){return{title:e.title,miniTitle:m.fromNullable(e.miniTitle)}}))),defaultCard:(0,d._)((0,c._)({},e.defaultCard),{miniTitle:m.fromNullable(e.defaultCard.miniTitle),details:m.fromNullable(e.defaultCard.details)})})}}(q||(q={}));var L,G,W,K=i(78216);!function(e){e[e.DISCONNECTED=0]="DISCONNECTED",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.WAITING_FOR_OT=3]="WAITING_FOR_OT",e[e.WAITING_FOR_ACK=4]="WAITING_FOR_ACK",e[e.SESSION_INBOUND=5]="SESSION_INBOUND",e[e.ANY=6]="ANY",e[e.CLOSED=7]="CLOSED"}(L||(L={})),function(e){e[e.CONNECT=0]="CONNECT",e[e.CONNECTED=1]="CONNECTED",e[e.DISCONNECT=2]="DISCONNECT",e[e.WAIT=3]="WAIT",e[e.READY=4]="READY",e[e.SEND=5]="SEND",e[e.ACK=6]="ACK",e[e.CLOSE=7]="CLOSE"}(G||(G={})),function(e){e.getUnsafe=function(){return(0,u.flow)(u.unsafeCoerce,p.right)}}(W||(W={}));var H,z=function(e){if("string"==typeof e)return e;if("submit_ot"===e.action&&"deltasString"in e){var t=(0,d._)((0,c._)({},e),{deltasString:void 0,deltas:void 0}),i=JSON.stringify(t);return i.substring(0,i.length-1)+',"deltas": '.concat(e.deltasString,"}")}return JSON.stringify(e)},Y=function(){function e(t,i,n,o){var l=t.context,v=void 0===l?void 0:l,b=t.dialect,S=void 0===b?"undefined":b,E=t.client,x=t.clientVersion,N=void 0===x?"":x,M=t.extDomain,D=void 0===M?void 0:M,O=t.sendDelay,P=void 0===O?50:O,q=t.docid,W=void 0===q?"":q,K=t.docIdIsTransient,z=void 0===K?void 0:K,Y=t.clientSupports,Q=void 0===Y?[]:Y,V=t.clientConfigs,j=void 0===V?void 0:V,J=t.isDemoDoc,X=void 0!==J&&J,Z=t.maxMessageSizeKb,ee=t.messagePaddingKb,te=t.startSessionOptions,ie=void 0===te?{}:te,ne=t.idGenerator,se=void 0===ne?new A.C(F.to,0,!1):ne,re=t.shouldSendFeedback,oe=void 0===re?u.constTrue:re,ae=this;(0,r._)(this,e),(0,a._)(this,"_connectionOptions",void 0),(0,a._)(this,"_log",void 0),(0,a._)(this,"_fsm",void 0),(0,a._)(this,"_idGenerator",void 0),(0,a._)(this,"_shouldSendFeedback",void 0),(0,a._)(this,"_queueIdGenerator",void 0),(0,a._)(this,"_changesQueue",void 0),(0,a._)(this,"_conn",void 0),(0,a._)(this,"_timeout",void 0),(0,a._)(this,"_textSize",void 0),(0,a._)(this,"_handler",void 0),(0,a._)(this,"_context",void 0),(0,a._)(this,"_dialect",void 0),(0,a._)(this,"_client",void 0),(0,a._)(this,"_clientVersion",void 0),(0,a._)(this,"_extDomain",void 0),(0,a._)(this,"_sendDelay",void 0),(0,a._)(this,"_docid",void 0),(0,a._)(this,"_docIdIsTransient",void 0),(0,a._)(this,"_asyncChecksManager",void 0),(0,a._)(this,"_clientSupports",void 0),(0,a._)(this,"_clientConfigs",void 0),(0,a._)(this,"_isDemoDoc",void 0),(0,a._)(this,"_startSessionOptions",void 0),(0,a._)(this,"_reconnectInfo",void 0),(0,a._)(this,"_lastPublishedReconnectInfo",void 0),(0,a._)(this,"_cachedSessionUuid",void 0),(0,a._)(this,"_pingsMap",void 0),(0,a._)(this,"_validateAlert",void 0),(0,a._)(this,"_externalHandlers",void 0),(0,a._)(this,"_statsRequester",void 0),(0,a._)(this,"_synonymsRequester",void 0),(0,a._)(this,"_snippetsRequester",void 0),(0,a._)(this,"_getTextRequester",void 0),(0,a._)(this,"_commandsRequester",void 0),(0,a._)(this,"_externalCommandsRequester",void 0),(0,a._)(this,"_otChunksNotifier",void 0),(0,a._)(this,"resetReconnectInfo",void 0),(0,a._)(this,"reportLensFeedback",void 0),(0,a._)(this,"reportSystemFeedback",void 0),(0,a._)(this,"reportEmotionFeedback",void 0),(0,a._)(this,"reportWritingExpertFeedback",void 0),(0,a._)(this,"reportG2UxInteractionFeedback",void 0),(0,a._)(this,"reportEmotionSentenceFeedback",void 0),(0,a._)(this,"reportMuteFeedback",void 0),(0,a._)(this,"reportAutocorrectFeedback",void 0),(0,a._)(this,"reportAutocompleteFeedback",void 0),(0,a._)(this,"reportAutocompleteRejectedFeedback",void 0),(0,a._)(this,"reportSnippetFeedback",void 0),(0,a._)(this,"requestSynonyms",void 0),(0,a._)(this,"requestSnippets",void 0),(0,a._)(this,"shortenItSubmit",void 0),(0,a._)(this,"requestDocStats",void 0),(0,a._)(this,"enablePlagiarismSearch",void 0),(0,a._)(this,"disablePlagiarismSearch",void 0),(0,a._)(this,"enableWritingExpert",void 0),(0,a._)(this,"disableWritingExpert",void 0),(0,a._)(this,"realtimeProofitSubmit",void 0),(0,a._)(this,"realtimeProofitCancel",void 0),(0,a._)(this,"submitRecipients",void 0),(0,a._)(this,"submitScoreSurveyResult",void 0),(0,a._)(this,"submitSurvey",void 0),(0,a._)(this,"ping",void 0),(0,a._)(this,"canGoIdle",void 0),(0,a._)(this,"isStable",void 0),(0,a._)(this,"updateContextInfo",void 0),(0,a._)(this,"published",void 0),(0,a._)(this,"registerExternalMessageHandler",void 0),(0,a._)(this,"enqueueExternalCommand",void 0),(0,a._)(this,"_handleReconnectInfo",void 0),(0,a._)(this,"_setReconnectInfo",void 0),(0,a._)(this,"_setReconnecInfoForNewSession",void 0),(0,a._)(this,"_resetIdGenerators",void 0),(0,a._)(this,"_cleanupOldSession",void 0),(0,a._)(this,"_supportsReconnect",void 0),(0,a._)(this,"_initReconnection",void 0),(0,a._)(this,"_startSession",void 0),(0,a._)(this,"_handleNewSession",void 0),(0,a._)(this,"_handleExistingSession",void 0),(0,a._)(this,"_handleStart",void 0),(0,a._)(this,"_waitForSubmitOt",void 0),(0,a._)(this,"_sessionInbound",void 0),(0,a._)(this,"_canSend",void 0),(0,a._)(this,"_send",void 0),(0,a._)(this,"_processQueueMessage",void 0),(0,a._)(this,"_resetTimer",void 0),(0,a._)(this,"_onQueueMsgAccepted",void 0),(0,a._)(this,"_onQueueStateChanged",void 0),(0,a._)(this,"_onQueueMsgDropped",void 0),this._connectionOptions=o,this._log=y.Bx.Logging.getLogger("coreclients.capi",C.$.TRACE),this._queueIdGenerator=new A.C(F.to,0,!1),this._textSize=0,this._asyncChecksManager=new $,this._cachedSessionUuid=null,this._pingsMap=new Map,this._validateAlert=H.validate,this._externalHandlers=[],this._statsRequester=new R.Wo(15e3,"CAPI.DocStats"),this._synonymsRequester=new R.Wo(15e3,"CAPI.Synonyms"),this._snippetsRequester=new R.Wo(15e3,"CAPI.Snippets"),this._getTextRequester=new R.Wo(15e3,"CAPI.Text"),this._commandsRequester=new R.Wo(15e3,"CAPI.Commands"),this._externalCommandsRequester=new R.Wo(5e3,"CAPI.ExternalCommands"),this._otChunksNotifier=new R.gT(15e3,"CAPI.OT.Chunks"),this.resetReconnectInfo=function(){ae._reconnectInfo=void 0,ae._handleReconnectInfo()},this.reportLensFeedback=function(e,t){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:t,lens:e},ae._commandsRequester)},this.reportSystemFeedback=function(e){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:e},ae._commandsRequester)},this.reportEmotionFeedback=function(e,t,i){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:t,emotion:e,subtype:i},ae._commandsRequester)},this.reportWritingExpertFeedback=function(e,t){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:e,weStage:t},ae._commandsRequester)},this.reportG2UxInteractionFeedback=function(e,t,i){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:e,userAction:i,vbarId:t},ae._commandsRequester)},this.reportEmotionSentenceFeedback=function(e,t){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:t,alertId:e},ae._commandsRequester)},this.reportMuteFeedback=function(e,t,i){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:i,userMuteScope:t,userMuteCategories:e},ae._commandsRequester)},this.reportAutocorrectFeedback=function(e,t){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:e,before:t.before,after:t.after,context:t.context,expected:t.expected},ae._commandsRequester)},this.reportAutocompleteFeedback=function(e,t){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:e,alertId:t.alertId,begin:t.begin,end:t.end,context:t.context,before:t.before,after:t.after,text:t.text,pname:t.pname},ae._commandsRequester)},this.reportAutocompleteRejectedFeedback=function(e){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:T.Sl.COMPLETION_REJECTED,alertId:e.alertId,begin:e.begin,end:e.end,context:e.context,before:e.before,after:e.after,text:e.text,pname:e.pname,subtype:e.subtype},ae._commandsRequester)},this.reportSnippetFeedback=function(e,t){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"feedback",type:e,snippetUuid:t},ae._commandsRequester)},this.requestSynonyms=function(e,t){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"synonyms",begin:e,token:t},ae._synonymsRequester)},this.requestSnippets=function(e){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"get_snippets_list",institutionId:e},ae._snippetsRequester)},this.shortenItSubmit=function(e){return(0,_.pipe)(g.BK((function(){ae._log.trace("shorten-it submit")})),g.cy((function(){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"shorten_it_submit",alertId:e},ae._commandsRequester)})))},this.requestDocStats=this._sendLazyInbandCommand((function(){return{id:ae._idGenerator.newId(),action:"get_text_stats"}}),this._statsRequester),this.enablePlagiarismSearch=(0,_.pipe)(g.BK((function(){ae._log.trace("Enable plagiarism search"),ae._asyncChecksManager.resetCheck("plagiarism")})),g.cy((function(){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"toggle_checks",checks:{plagiarism:!0}},ae._commandsRequester)}))),this.disablePlagiarismSearch=this._sendLazyInbandCommand((function(){return{id:ae._idGenerator.newId(),action:"toggle_checks",checks:{plagiarism:!1}}}),this._commandsRequester),this.enableWritingExpert=(0,_.pipe)(g.BK((function(){ae._log.trace("Enable writing expert"),ae._asyncChecksManager.resetCheck("writing_expert_check")})),g.cy((function(){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"toggle_checks",checks:{writing_expert_check:!0}},ae._commandsRequester)}))),this.disableWritingExpert=this._sendLazyInbandCommand((function(){return{id:ae._idGenerator.newId(),action:"toggle_checks",checks:{writing_expert_check:!1}}}),this._commandsRequester),this.realtimeProofitSubmit=function(e){return ae._log.trace("Submit real-time Proofit job"),ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"realtime_proofit_submit",reconnect:e},ae._commandsRequester)},this.realtimeProofitCancel=(0,_.pipe)(g.BK((function(){ae._log.trace("Cancel real-time Proofit job")})),g.cy((function(){return ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"realtime_proofit_cancel"},ae._commandsRequester)}))),this.submitRecipients=function(e){return ae._log.trace("Submit recipients for better suggestions!"),ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"submit_recipients",recipients:e},ae._commandsRequester)},this.submitScoreSurveyResult=function(e,t,i){return ae._log.trace("Submit score survey result:",{placement:e,score:t,detailed_placement:i}),ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"submit_survey_result",type:F.QB.Survey.Data.ScoreSurvey.type,placement:e,score:t,detailed_placement:i},ae._commandsRequester)},this.submitSurvey=function(e){return ae._log.trace("Submit survey result:",(0,c._)({},e)),ae._sendInbandCommand((0,c._)({id:ae._idGenerator.newId(),action:"submit_survey_result"},e),ae._commandsRequester)},this.ping=this._sendLazyInbandCommand((function(){return{id:ae._idGenerator.newId(),action:"ping"}}),this._commandsRequester),this.canGoIdle=function(){return ae._changesQueue.isEmpty&&!ae._changesQueue.isStaging},this.isStable=function(e){var t=void 0===e?ae._idGenerator.id:ae._idGenerator.id+1;return(void 0===e||"error"!==e.action)&&t>5},this.updateContextInfo=function(e){return ae._log.trace("Update thread context info"),ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"update_context_info",docContext:e},ae._commandsRequester)},this.published=function(){return ae._log.trace("Send published event"),ae._sendInbandCommand({id:ae._idGenerator.newId(),action:"published"},ae._commandsRequester)},this.registerExternalMessageHandler=function(e){ae._externalHandlers.push(e)};var ce=this;this.enqueueExternalCommand=function(e){return(0,s._)((function(){var t,i,n,s;return(0,h.YH)(this,(function(r){switch(r.label){case 0:return t=ce._connectionOptions.getSessionId(),ce._canSend()?[3,1]:[2,p.left(new R.Xb("Cannot send commands as WS connection is down"))];case 1:return m.isNone(t)?[2,p.left(new R.Xb("Unexpected empty sessionId, while WS connection is up"))]:[3,2];case 2:return i=ce._changesQueue.isEmpty,n=ce._changesQueue.pushExternalCommand(t.value,e),s=ce._externalCommandsRequester.watchRequest(n),i?(ce._log.trace("enqueueExternalCommand: Q.isEmpty, sending command immediately"),ce._send()):(ce._log.trace("enqueueExternalCommand: Q.notEmpty, delaying sending command"),ce._trySend(ce._fsm.current)),[4,s.then(p.map((function(){return n})))];case 3:return[2,r.sent()];case 4:return[2]}}))}))},this._handleReconnectInfo=function(){var e,t;!(null===(e=ae._changesQueue)||void 0===e?void 0:e.isEmpty)||(null===(t=ae._changesQueue)||void 0===t?void 0:t.isStaging)?void 0!==ae._lastPublishedReconnectInfo&&(ae._lastPublishedReconnectInfo=void 0,ae._handler.onReconnectInfo({kind:"reconnect_info_updated"})):ae._lastPublishedReconnectInfo!==ae._reconnectInfo&&(ae._handler.onReconnectInfo({kind:"reconnect_info_updated",reconnectInfo:ae._reconnectInfo}),ae._lastPublishedReconnectInfo=ae._reconnectInfo)},this._setReconnectInfo=function(e){ae._reconnectInfo=e,ae._handleReconnectInfo()},this._setReconnecInfoForNewSession=function(){null!==ae._cachedSessionUuid?ae._setReconnectInfo({sessionUuid:ae._cachedSessionUuid}):ae.resetReconnectInfo()},this._resetIdGenerators=function(){ae._idGenerator.reset(),ae._queueIdGenerator.reset(),ae._queueIdGenerator.newId()},this._cleanupOldSession=function(e){ae._clear(e),ae._commandsRequester.clear(e),ae._externalCommandsRequester.clear(e),ae._statsRequester.clear(e),ae._synonymsRequester.clear(e),ae._getTextRequester.clear(e)},this._supportsReconnect=function(){return ae._clientSupports.includes(F.k9.reconnect)};var de=this;this._initReconnection=(0,s._)((function(){var e,t;return(0,h.YH)(this,(function(i){switch(i.label){case 0:return de._supportsReconnect()?[3,1]:(de._resetIdGenerators(),null!==de._cachedSessionUuid?[2,{sessionUuid:de._cachedSessionUuid}]:[2,void 0]);case 1:return de._reconnectInfo?[3,7]:null===de._cachedSessionUuid?[3,2]:(de._setReconnectInfo({sessionUuid:de._cachedSessionUuid}),[3,6]);case 2:return"function"!=typeof de._startSessionOptions?[3,4]:[4,de._startSessionOptions()];case 3:return t=i.sent(),[3,5];case 4:t=de._startSessionOptions,i.label=5;case 5:(e=t).reconnectInfo&&de._setReconnectInfo(e.reconnectInfo),i.label=6;case 6:return de._resetIdGenerators(),[3,8];case 7:de._changesQueue.isEmpty&&!de._changesQueue.isStaging||(de._setReconnecInfoForNewSession(),de._resetIdGenerators()),i.label=8;case 8:return[2,de._reconnectInfo]}}))}));var le=this;this._startSession=(0,s._)((function(){var e,t,i,n;return(0,h.YH)(this,(function(s){switch(s.label){case 0:return le._log.trace("_startSession"),"function"!=typeof le._startSessionOptions?[3,2]:[4,le._startSessionOptions()];case 1:return t=s.sent(),[3,3];case 2:t=le._startSessionOptions,s.label=3;case 3:return e=t,[4,le._initReconnection()];case 4:return i=s.sent(),n=(0,c._)((0,d._)((0,c._)({id:le._idGenerator.newId(),action:"start",client:le._client.type,clientSubtype:le._client.sub,clientVersion:le._clientVersion,dialect:le._dialect,docid:le._docid,docIdIsTransient:le._docIdIsTransient,extDomain:le._extDomain,documentContext:le._context&&k.T0.serialize(le._context),clientSupports:le._clientSupports,isDemoDoc:le._isDemoDoc},null!==i?{reconnectInfo:i}:{}),{clientConfigs:le._clientConfigs}),e),[4,le._fsm.event(G.SEND)];case 5:return s.sent(),le._sendMessage(n),[2]}}))})),this._handleNewSession=function(e){void 0!==ae._reconnectInfo&&ae._log.debug("Exited old session: ".concat(ae._reconnectInfo.sessionUuid)),ae._log.debug("Starting new session: ".concat(e)),ae._fsm.is(L.CONNECTED)&&(ae._cleanupOldSession("new session"),ae._fsm.event(G.WAIT)),ae._setReconnectInfo({sessionUuid:e,messagesReceived:1,messagesSent:1})},this._handleExistingSession=function(e){ae._log.debug("Continuing session: ".concat(e)),ae._fsm.is(L.CONNECTED)?(ae._fsm.event(G.READY),ae._handler.onReady({kind:"ready"})):ae._fsm.event(G.ACK)},this._handleStart=function(e){ae._log.trace("_handleStart"),ae._fsm.event(G.ACK);var t=e.userMutedCategories,i=e.allowedFeatures,n=e.domainCategory,s=e.domainName,r=e.isEnterprise,o=e.defaultDocumentContext,a=e.sessionUuid,c=e.reconnectedInfo,d=e.cheetahState,l=void 0===ae._reconnectInfo||a!==ae._reconnectInfo.sessionUuid;(null===ae._cachedSessionUuid||ae._supportsReconnect())&&(ae._cachedSessionUuid=a),l?ae._handleNewSession(a):ae._handleExistingSession(a),ae._handler.onSessionStarted({kind:"session_started",userMutedCategories:t,allowedFeatures:i,domainCategory:n,domainName:s,isEnterprise:r,cheetahState:d,defaultDocumentContext:(0,_.pipe)(o,m.fromNullable,m.chain(k.T0.parseDefault)),sessionUuid:a,reconnectedInfo:c,isNewSession:l,maxWsMessageSize:e.maxWsMessageSize})},this._waitForSubmitOt=function(){ae._handler.onWaitForOT({kind:"wait_for_ot"})},this._sessionInbound=function(e){ae._handler.onSessionInbound({kind:"session_inbound"}),ae._trySend(e)},this._canSend=function(){return!ae._fsm.is(L.DISCONNECTED,L.CONNECTING,L.CLOSED)};var he=this;this._send=(0,s._)((function(){var e,t;return(0,h.YH)(this,(function(i){switch(i.label){case 0:return he._resetTimer(),he._fsm.is(L.SESSION_INBOUND)&&he._changesQueue.hasCommitedChanges?[4,he._fsm.event(G.SEND)]:[3,6];case 1:i.sent(),i.label=2;case 2:return i.trys.push([2,4,,5]),e=he._changesQueue.poll(),[4,(0,_.pipe)(e,m.map((n=(0,s._)((function(e){var t;return(0,h.YH)(this,(function(i){switch(i.label){case 0:return t=U.isChange(e),[4,he._sendMessage(he._processQueueMessage(e))];case 1:return i.sent(),t?[3,3]:(he._log.trace("message sent is not Change, firing CAPI FSM ACK immediately"),[4,he._fsm.event(G.ACK)]);case 2:i.sent()?(he._changesQueue.ackOperation(e.id),"externalCmd"===e.kind&&he._externalCommandsRequester.onValue(e.id)):he._log.debug("can not do ack for non change msg because we are in unexpected state",{state:L[he._fsm.current]}),i.label=3;case 3:return[2]}}))})),function(e){return n.apply(this,arguments)})),m.getOrElse((function(){return Promise.resolve()})))];case 3:return i.sent(),[3,5];case 4:return t=i.sent(),he._log.error("unexpected error on sending",t),[3,5];case 5:return[3,7];case 6:he._trySend(he._fsm.current),i.label=7;case 7:return[2]}var n}))})),this._processQueueMessage=function(e){return U.isChange(e)?ae._processSubmitOTMessage(e):"externalCmd"===e.kind?e.cmd:"rev"in e.cmd?(0,d._)((0,c._)({},e.cmd),{rev:e.rev,id:e.id}):(0,d._)((0,c._)({},e.cmd),{id:e.id})},this._resetTimer=function(){void 0!==ae._timeout&&(clearTimeout(ae._timeout),ae._timeout=void 0)},this._onQueueMsgAccepted=function(e){ae._handler.onQueueMsgAccepted({kind:"queue_msg_accepted",message:e})},this._onQueueStateChanged=function(){ae._handleReconnectInfo()},this._onQueueMsgDropped=function(e,t){e.filter(U.isCmd).forEach((function(e){var i=new R.zN("message dropped from queue:"+t);switch(e.cmd.action){case"ping":case"option":case"toggle_checks":case"set_context":case"feedback":ae._commandsRequester.onError(e.id,i);break;case"get_text_stats":ae._statsRequester.onError(e.id,i);break;case"synonyms":ae._synonymsRequester.onError(e.id,i);break;case"get_debug_info":ae._getTextRequester.onError(e.id,i)}})),ae._handler.onQueueMsgDropped({kind:"queue_msgs_dropped",messages:e,reason:t})},this._handler=i,this._context=v,this._dialect=S,this._client=E,this._clientVersion=N,this._extDomain=D,this._sendDelay=P,this._docid=W,this._docIdIsTransient=z,this._clientSupports=Q,this._clientConfigs=j,this._isDemoDoc=X,this._startSessionOptions=ie,this._idGenerator=se,this._shouldSendFeedback=oe,this._changesQueue=new B(this._shouldHaveSeparateRevision,this._onQueueMsgAccepted,this._onQueueMsgDropped,this._onQueueStateChanged,(function(){return ae._queueIdGenerator.newId()}),Z,ee),this._fsm=new I.Z3("capi",L.DISCONNECTED,L.CLOSED).with(L.ANY).parentOf(L.CONNECTED,L.CONNECTING,L.DISCONNECTED,L.WAITING_FOR_OT,L.WAITING_FOR_ACK,L.SESSION_INBOUND).from(L.ANY).to(L.CLOSED).on(G.CLOSE).from(L.DISCONNECTED).to(L.CONNECTING).on(G.CONNECT).from(L.CONNECTING).to(L.CONNECTING).on(G.CONNECT).from(L.CONNECTING).to(L.CONNECTED).on(G.CONNECTED).from(L.CONNECTED,L.WAITING_FOR_OT,L.WAITING_FOR_ACK,L.SESSION_INBOUND,L.CONNECTING).to(L.DISCONNECTED).on(G.DISCONNECT).from(L.CONNECTED).to(L.WAITING_FOR_OT).on(G.WAIT).from(L.CONNECTED,L.WAITING_FOR_OT).to(L.SESSION_INBOUND).on(G.READY).from(L.SESSION_INBOUND).to(L.WAITING_FOR_ACK).on(G.SEND).from(L.WAITING_FOR_ACK).to(L.SESSION_INBOUND).on(G.ACK).on(L.CONNECTED,this._startSession).on(L.WAITING_FOR_OT,this._waitForSubmitOt).on(L.SESSION_INBOUND,(function(e){return ae._sessionInbound(e.to)})),this._log.isEnabled(C.$.TRACE)&&this._fsm.verbose(L,G),n.onConnecting((function(){return ae._handleConnecting()})).onConnect((function(e){return ae._handleConnect(e)})).onDisconnect((function(e){return ae._handleDisconnect(e)})).onMessage((function(e,t){return ae._handleMessage(t)})),(0,f.hJ)("closeCapiSocket",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,t=arguments.length>1?arguments[1]:void 0;null!==ae._conn&&ae._conn._ws.close(e,t)})),(0,f.hJ)("capiState",this),(0,f.hJ)("capiReadyToReceive",(function(){return ae._fsm.is(L.SESSION_INBOUND)&&ae._changesQueue.isEmpty})),(0,f.hJ)("capiRuntimeError",(function(){var e=w.lY.ins(0,"test",100500);ae.pushChanges(e)}))}return(0,o._)(e,[{key:"pushChanges",value:function(e){return this._pushChangesTask(e)}},{key:"checkingState",get:function(){return 0===this._checkedTextSize||1===this._textSize?"idle":this._checkedTextSize>T.$A&&this._textSize>T.$A/3?"full":"checking"}},{key:"asyncChecksState",get:function(){return this._asyncChecksManager.getState()}},{key:"setSessionOption",value:function(e){switch(e.kind){case T.XM.Context:return this.setContext(e.context);case T.XM.GnarContainerId:return this.setOption(e.kind,e.id);default:return(0,v.xb)(e)}}},{key:"setContext",value:function(e){return this._log.debug("setContext(...)"),this._context=e,this._sendInbandCommand({action:"set_context",id:this._idGenerator.newId(),rev:-1,documentContext:k.T0.serialize(e)},this._commandsRequester)}},{key:"setOption",value:function(e,t){return this._log.trace("Set option "+t),this._sendInbandCommand({id:this._idGenerator.newId(),action:"option",name:e,value:t},this._commandsRequester)}},{key:"sendUserAction",value:function(e,t){var i=this;return this._log.debug("sendUserAction",{componentId:e,userAction:t}),this._canSend()?(0,_.pipe)(this._connectionOptions.getSessionId(),p.fromOption((function(){return new Error("Can not sendUserAction because sessionId is empty")})),g.Mr,g.cy((function(n){return(0,_.pipe)(i._sendTrackedInbandCommand({id:i._idGenerator.newId(),action:"user_action",sessionId:n,componentId:e,userAction:t},i._commandsRequester),g.Tj(b.Up("queuedId")))}))):g.kb(new R.Xb("Can not sendUserAction because connection is down"))}},{key:"sendDebugReport",value:function(e,t){return this._log.debug("sendDebugReport",{componentId:e,errorMessage:t}),this._sendInbandCommand({id:this._idGenerator.newId(),action:"debug_report",type:"sdui_decode_error",componentId:e,errorMessage:t},this._commandsRequester)}},{key:"sendFeedback",value:function(e){if(this._log.debug("sendFeedback",e.kind),!this._shouldSendFeedback(e))return this._log.debug("Skip sending ".concat(e.kind," based on CAPI Client configured, see 'shouldSendFeedback'")),g.of(void 0);switch(e.kind){case T.yp.ACCEPTED:return this._sendAlertAcceptedFeedback(e);case T.yp.IGNORE:return this.reportIgnoreFeedback(e.id,e.reason,e.subtype,e.pnameQualifier,e.drilldownSuggestionIds);case T.yp.ACKNOWLEDGED:return this.reportAcknowledgeFeedback(e.id,e.subtype,e.text,e.pnameQualifier);case T.yp.ADD_TO_DICTIONARY:case T.yp.RENDERED:case T.yp.LOOKED:case T.yp.CLOSED:case T.yp.LIKE:case T.yp.DISLIKE:case T.yp.WRONG_SUGGESTION:case T.yp.OFFENSIVE_CONTENT:case T.yp.EXPANDED:case T.yp.IGNORE_BULK_ACCEPTED:case T.yp.HIDE:return this.reportAlertFeedback(e.id,e.kind,e.subtype);case T.yp.USER_SATISFACTION_FEEDBACK:return this.reportAlertSatisfactionFeedback(e.id,e.kind,e.userSatisfactionDescription,e.subtype);case T.ZI.DRILLDOWN:return this._reportDrilldownFeedback(e.id,e.alternativeIndex,e.drilldownSuggestionIds,e.subtype);case T.Fc.SYNONYM_ACCEPTED:return this.reportSynonymFeedback(e.id,e.kind,e.replacementText,e.subtype);case T.Fc.SYNONYM_DISMISSED:return this.reportSynonymFeedback(e.id,e.kind,e.subtype);case T.Zq.EMOTION_LIKE:case T.Zq.EMOTION_DISLIKE:case T.Zq.EMOTION_OFFENSIVE:return this.reportEmotionFeedback(e.emotionName,e.kind,e.subtype);case T.uG.EMOTION_SENTENCE_LIKE:case T.uG.EMOTION_SENTENCE_DISLIKE:return this.reportEmotionSentenceFeedback(e.id,e.kind);case T.DG.MUTE:case T.DG.UNMUTE:return this.reportMuteFeedback(e.userMuteCategories,e.userMuteScope,e.kind);case T.hN.RECHECK_SHOWN:return this.reportSystemFeedback(e.kind);case T.yj.LENS_CLOSE:case T.yj.LENS_OPEN:case T.yj.DISMISS_BY_LENS:return this.reportLensFeedback(e.lensName,e.kind);case T.t5.AUTOCORRECT_ACCEPT:case T.t5.AUTOCORRECT_DISMISS:case T.t5.AUTOCORRECT_REPLACE:return this.reportAutocorrectFeedback(e.kind,e);case T.Sl.COMPLETION_REJECTED:return this.reportAutocompleteRejectedFeedback(e);case T.Sl.COMPLETION_ACCEPTED:case T.Sl.COMPLETION_IGNORED:case T.Sl.COMPLETION_SHOWN:return this.reportAutocompleteFeedback(e.kind,e);case T.l.BULK_ACCEPTED:return this.reportAlertsBatchFeedback(e.alertIds,e.kind,e.subtype);case T.ch.SNIPPET_ACCEPTED:return this.reportSnippetFeedback(e.kind,e.snippetUuid);case T.mq.ASSISTANT_OPENED:return this._reportAssistantFeedback(e.kind);case T.rP.AUTOAPPLY_TRIGGERED:case T.rP.AUTOAPPLY_LOOKED:case T.rP.AUTOAPPLY_REVERTED:case T.rP.AUTOAPPLY_ACCEPT:case T.rP.AUTOAPPLY_AFFECTED_BY_TEXTCHANGE:return this._reportAutoapplyFeedback(e.alertId,e.kind,e.subtype);case T.Sm.WritingExpert:return this.reportWritingExpertFeedback(e.kind,e.weStage);case T.lH.G2_UI:return this.reportG2UxInteractionFeedback(e.kind,e.vbarId,e.userAction);default:return(0,v.xb)(e)}}},{key:"requestWritingExpert",value:function(){return this._sendInbandCommand({id:this._idGenerator.newId(),correlationId:"QWEQWEQWE",action:"disposable_cheetah:invokeCommand",generationMode:"rewrite",textScope:{start:0,end:100},command:{kind:"predefinedAction",actionIdentifier:{kind:"label",value:"Improve it"}}},this._commandsRequester)}},{key:"_reportDrilldownFeedback",value:function(e,t,i,n){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:T.ZI.DRILLDOWN,alertId:e,alternativeIndex:t,drilldownSuggestionIds:i,subtype:n},this._commandsRequester)}},{key:"_reportAssistantFeedback",value:function(e){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:e},this._commandsRequester)}},{key:"_sendAlertAcceptedFeedback",value:function(e){return"replacementText"in e?this._reportTextAlertAcceptedFeedback(e.id,e.replacementText,e.subtype,e.reason,e.gbPrompt):"alternativeIndex"in e?this._reportTransformJsonAlertAcceptedFeedback(e.id,e.alternativeIndex,e.gapValue,e.subtype,e.drilldownSuggestionIds,e.dismissedTransformGroups,e.reason,e.gbPrompt):(0,v.xb)(e)}},{key:"reportIgnoreFeedback",value:function(e,t,i,n,s){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:T.yp.IGNORE,alertId:e,userReason:t,subtype:i,pnameQualifier:n,drilldownSuggestionIds:s},this._commandsRequester)}},{key:"reportAcknowledgeFeedback",value:function(e,t,i,n){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:T.yp.ACKNOWLEDGED,alertId:e,subtype:t,pnameQualifier:n,text:i},this._commandsRequester)}},{key:"reportAlertFeedback",value:function(e,t,i){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:t,alertId:e,subtype:i},this._commandsRequester)}},{key:"reportAlertSatisfactionFeedback",value:function(e,t,i,n){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:t,alertId:e,userSatisfactionDescription:i,subtype:n},this._commandsRequester)}},{key:"reportAlertsBatchFeedback",value:function(e,t,i){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:t,alertIds:e,subtype:i},this._commandsRequester)}},{key:"_reportTextAlertAcceptedFeedback",value:function(e,t,i,n,s){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:T.yp.ACCEPTED,alertId:e,text:t,subtype:i,userReason:n,gbPrompt:s},this._commandsRequester)}},{key:"_reportTransformJsonAlertAcceptedFeedback",value:function(e,t,i,n,s,r,o,a){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:T.yp.ACCEPTED,alertId:e,alternativeIndex:t,gapValue:i,subtype:n,drilldownSuggestionIds:s,dismissedTransformGroups:r,userReason:o,gbPrompt:a},this._commandsRequester)}},{key:"reportSynonymFeedback",value:function(e,t,i,n){switch(t){case T.Fc.SYNONYM_ACCEPTED:var s={id:this._idGenerator.newId(),action:"feedback",type:T.Fc.SYNONYM_ACCEPTED,text:i,alertId:e,subtype:n};return this._sendInbandCommand(s,this._commandsRequester);case T.Fc.SYNONYM_DISMISSED:return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:T.Fc.SYNONYM_DISMISSED,alertId:e,subtype:n},this._commandsRequester);default:return(0,v.xb)(t)}}},{key:"_reportAutoapplyFeedback",value:function(e,t,i){return this._sendInbandCommand({id:this._idGenerator.newId(),action:"feedback",type:t,alertId:e,subtype:i},this._commandsRequester)}},{key:"isClosed",value:function(){return this._fsm.is(L.CLOSED)}},{key:"close",value:function(e){var t=this;return(0,s._)((function(){return(0,h.YH)(this,(function(i){switch(i.label){case 0:return t.isClosed()?(t._log.trace("close: CAPI already closed, skipping"),[2]):(t._log.trace("close: closing CAPI"),[4,t._fsm.event(G.CLOSE,e)]);case 1:return i.sent()?t._clear(e):t._log.error("Cannot go to CLOSED state"),[2]}}))}))()}},{key:"getText",value:function(){return S.hq(this._sendInbandCommand({id:this._idGenerator.newId(),action:"get_debug_info"},this._getTextRequester))}},{key:"_handleConnecting",value:function(){var e=this;return(0,s._)((function(){return(0,h.YH)(this,(function(t){switch(t.label){case 0:return[4,e._fsm.event(G.CONNECT)];case 1:return t.sent()||e._log.error("Can not enter CONNECTING state",{fsmState:L[e._fsm.current]}),[2]}}))}))()}},{key:"_handleConnect",value:function(e){var t=this;return(0,s._)((function(){var i,n;return(0,h.YH)(this,(function(s){switch(s.label){case 0:t._log.trace("_handleConnect(".concat(L[t._fsm.current],"): received new ws connection")),t._conn=e,i=void 0,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,t._fsm.event(G.CONNECTED)];case 2:return s.sent()||(i="failed to switch to CONNECTED state"),[3,4];case 3:return n=s.sent(),i=n,[3,4];case 4:if(Boolean(i))throw t._log.warn("Connection cannot be finalized.",i),i;return[2]}}))}))()}},{key:"_handleDisconnect",value:function(e){var t=this;return(0,s._)((function(){var i,n;return(0,h.YH)(this,(function(s){switch(s.label){case 0:return t._log.trace("_handleDisconnect(".concat(L[t._fsm.current],")"),e),[4,t._fsm.event(G.DISCONNECT,e.reason)];case 1:return i=s.sent(),n=t._fsm.is(L.CLOSED)?C.$.WARN:C.$.ERROR,i||t._log.log(n,"Can not enter DISCONNECTED state",{reason:e,fsmState:L[t._fsm.current]}),[2]}}))}))()}},{key:"_handleMessage",value:function(e){var t,i,n=null===(i=this._clientConfigs)||void 0===i||null===(t=i.sdui)||void 0===t?void 0:t.config;if(void 0!==this._reconnectInfo){var s,r=null!==(s=this._reconnectInfo.messagesReceived)&&void 0!==s?s:0;this._setReconnectInfo((0,d._)((0,c._)({},this._reconnectInfo),{messagesReceived:r+1}))}if(this._handler.onMessageReceived({kind:"message_received",message:e}),this._log.isEnabled(C.$.TRACE)&&this._log.trace("Message <<< "+JSON.stringify(e).replace("\n"," ").substring(0,300)),this._externalHandlers.some((function(t){return t(e)===E.Q.Result.STOP_HANDLING})))this._log.trace("Message was handled by external handler",e.action);else switch(e.action){case"start":this._handleStart(e);break;case"alert":this._handleAlert(e);break;case"remove":this._handler.onRemove({kind:"alert_removed",alertId:T.tI.Id.create(e.id),hint:(0,_.pipe)(m.fromNullable(e.hint),m.filter((function(e){return e===x.Q.NotFixed}))),mergedIn:(0,_.pipe)(m.fromNullable(e.mergedIn),m.map((function(e){return T.tI.Id.create(e)})))});break;case"alert_changes":this._handleAlertChange(e);break;case"finished":this._handleFinish(e);break;case"async_check_finished":this._handleAsyncCheckFinished(e);break;case"async_check_progress":this._handleAsyncCheckProgress(e);break;case"complete":this._handleComplete(e);break;case"heatmap":this._handleAttentionHeatmap(e);break;case"attention_widget":this._handleAttentionInfo(e);break;case"submit_ot":this._handleSubmitOtAck(e);break;case"submit_ot_chunk":this._handleSubmitOtChunkAck(e);break;case"feedback":case"option":case"toggle_checks":case"set_context":case"submit_recipients":case"user_action":case"debug_report":case"shorten_it_submit":case"update_context_info":case"submit_survey_result":this._handleCommandAck(e);break;case"perfstats":this._handleAck(e);break;case"error":this._handleError(e);break;case"pong":this._handlePong(e);break;case"synonyms":this._handleSynonyms(e);break;case"get_snippets_list_response":this._handleSnippets(e);break;case"text_stats":this._handleTextStats(e);break;case"text_maps":this._handleTextMaps(e);break;case"text_info":this._handleTextInfo(e);break;case"emotions":this._handleEmotions(e);break;case"debug_info":this._handler.onDebugInfo({kind:"debug_info",info:e}),this._getTextRequester.onValue(e.id,e.text);break;case"realtime_proofit_availability":this._handleProofitAvailability(e);break;case"realtime_proofit_submit_resp":this._handleProofitSubmit(e);break;case"realtime_proofit_progress":this._handleProofitProgress(e);break;case"realtime_proofit_cancel_resp":this._handleProofitCancelled(e);break;case"shorten_it_finished":this._handleShortenItFinished(e);break;case"published":this._handlePublishedAck(e);break;case"sdui:add":var o,a,l,h;null!=(null===(a=n)||void 0===a||null===(o=a[e.viewId])||void 0===o?void 0:o.dslParser)?this._handleSDUIAdd(e,null===(h=n)||void 0===h||null===(l=h[e.viewId])||void 0===l?void 0:l.dslParser):this._handleUnexpectedSDUIMessage(e);break;case"sdui:update":var u,p,g,f;null!=(null===(p=n)||void 0===p||null===(u=p[e.viewId])||void 0===u?void 0:u.dslParser)?this._handleSDUIUpdate(e,null===(f=n)||void 0===f||null===(g=f[e.viewId])||void 0===g?void 0:g.dslParser):this._handleUnexpectedSDUIMessage(e);break;case"sdui:remove":var b,S;null!=(null===(S=n)||void 0===S||null===(b=S[e.viewId])||void 0===b?void 0:b.dslParser)?this._handleSDUIRemove(e):this._handleUnexpectedSDUIMessage(e);break;case"gb_rule_created":this._handler.onGbRuleCreated({kind:"gb_rule_created",categoryTitle:e.categoryTitle,styleGuideId:e.styleGuideId,descriptionLength:e.descriptionLength});break;case"show_survey":this._handleShowSurvey(e);break;case"g_debug_event":this._log.debug("g_debug_event",{message:e});break;default:this._log.error("Unknown message",{message:e}),(0,v.xb)(e)}}},{key:"_handleAlert",value:function(e){var t=this;this._handler.beforeAlert({kind:"before_alert"});var i=T.tI.fromAlertMessage(e);this._log.trace("_handleAlert",e.id);var n=this._changesQueue.transformAlertAgainstQueue(i);(0,_.pipe)(n,p.fromOption((function(){return new Error("alert ".concat(i.id," position overlap: ").concat(JSON.stringify(i).substring(0,200)))})),p.chain(this._validateAlert),p.fold((function(e){t._log.isEnabled(C.$.TRACE)&&t._log.trace("OT ALERT: discarding alert due to error",e)}),(function(e){t._handler.onAlert({kind:"alert_received",alert:e})})))}},{key:"_handleAlertChange",value:function(e){return(0,_.pipe)({kind:"alert_changed",alertId:T.tI.Id.create(e.id),rev:e.rev,extraProperties:e.extra_properties&&T.tI.parseExtraProperties(e.extra_properties),transformJson:e.transformJson&&T.EK.toAbs(e.transformJson),muted:e.muted},this._changesQueue.transformChangeAgainstQueue,m.fold(u.constVoid,this._handler.onChange))}},{key:"_handleComplete",value:function(e){this._handler.onAutoComplete({kind:"autocomplete_received",complete:e})}},{key:"_handleAttentionHeatmap",value:function(e){var t=T.J5.fromAttentionHeatmapMessage(e);this._handler.onAttentionHeatmap({kind:"attention_heatmap_received",heatmap:this._changesQueue.transformAttentionHeatmapAgainstQueue(t)})}},{key:"_handleAttentionInfo",value:function(e){var t;2===e.version?this._handler.onAttentionInfo({kind:"attention_info_received",rev:e.rev,wordsCount:e.wordsCount,checklist:e.checklist.map(q.fromRaw),headerMessage:e.headerMessage,predictionMessage:e.predictionMessage,hidden:null!==(t=e.hidden)&&void 0!==t&&t}):this._log.error("Got an unsupported attention_widget message version",e)}},{key:"_handleTextMaps",value:function(e){var t={score:e.score,generalScore:e.generalScore,textMaps:e.textMaps};this._handler.onTextMaps({kind:"text_maps",data:t})}},{key:"_handleTextInfo",value:function(e){var t={wordsCount:e.wordsCount,charsCount:e.charsCount-1,readingTime:K.R.calculateReadingTime(e.wordsCount),speakingTime:K.R.calculateSpeakingTime(e.wordsCount),readabilityScore:e.readabilityScore,messages:m.fromNullable(e.messages),sessionStats:e.sessionStats};this._handler.onTextInfo({kind:"text_info",data:t})}},{key:"_handleEmotions",value:function(e){this._handler.onEmotions({kind:"emotions",emotions:e.emotions,institutionLogo:e.institutionLogo,brandTonesEnabled:e.brandTonesEnabled,brandTonesConfigured:e.brandTonesConfigured,hidden:e.hidden})}},{key:"_handleProofitAvailability",value:function(e){this._handler.onProofitAvailability({id:e.id,kind:"realtime_proofit_availability",available:e.available,quota:e.quota})}},{key:"_handleProofitSubmit",value:function(e){this._handler.onProofitSubmit({id:e.id,kind:"realtime_proofit_submit_resp",status:e.status})}},{key:"_handleProofitProgress",value:function(e){"in_progress"===e.status?this._handler.onProofitProgress((0,c._)({kind:"realtime_proofit_in_progress"},e)):"completed"===e.status?this._handler.onProofitCompleted((0,c._)({kind:"realtime_proofit_completed"},e)):"error"===e.status?this._handler.onProofitProgressProblem((0,c._)({kind:"realtime_proofit_progress_error"},e)):"rejected"===e.status&&this._handler.onProofitProgressProblem((0,c._)({kind:"realtime_proofit_progress_rejected"},e))}},{key:"_handleProofitCancelled",value:function(e){this._handler.onProofitCancelled({id:e.id,kind:"realtime_proofit_cancel_resp",refunded:e.refunded,quota:e.quota})}},{key:"_handleShortenItFinished",value:function(e){this._handler.onShortenItFinished({kind:"shorten_it_finished",alertId:T.tI.Id.create(e.alertId)})}},{key:"_handlePublishedAck",value:function(e){this._handleCommandAck(e),this._handler.onPublishedAck({kind:"published_ack",survey:e.survey})}},{key:"_handleShowSurvey",value:function(e){this._handler.onShowSurvey({kind:"show_survey",survey:e.survey})}},{key:"_handleFinish",value:function(e){this._log.trace("_handleFinish"),this._handler.onBeforeFinish({kind:"before_finish"}),this._changesQueue.ackRevision(e.rev);var t=this._createFinishEvent(e);this._handler.onFinish(t)}},{key:"_handleAsyncCheckProgress",value:function(e){this._handler.onAsyncCheckProgress({kind:"async_check_progress",check:e.check,revision:e.rev,progress:e.progress})}},{key:"_handleAsyncCheckFinished",value:function(e){this._handler.onBeforeAsyncCheckFinish({kind:"before_async_check_finish"}),this._asyncChecksManager.finish(e),this._handler.onAsyncCheckFinish({kind:"async_check_finished",check:e.check,revision:e.rev,outcomeScores:e.outcomeScores})}},{key:"_handleSubmitOtAck",value:function(e){this._log.trace("<<< Acknowledge for "+e.action,{message:e}),this._fsm.is(L.WAITING_FOR_ACK)?(this._handleAck(e),this._changesQueue.ackOperation(e.id),this._fsm.event(G.ACK)):this._log.error("Got an unexpected submit_ot ack",{curentState:L[this._fsm.current]})}},{key:"_sendNextOtChunk",value:function(e){var t=this;if(0===e.chunks.length){this._log.trace("no more chunks, sending final submit_ot message");var i=this;return g.TX((0,s._)((function(){return(0,h.YH)(this,(function(t){switch(t.label){case 0:return[4,i._sendMessage(e.submitOt)];case 1:return[2,t.sent()]}}))})),(function(e){return new Error("failed to send final submit_ot message: ".concat(e))}))}this._log.trace("sending next submit_ot chunk");var n=this;return(0,_.pipe)(g.TX((0,s._)((function(){var t;return(0,h.YH)(this,(function(i){switch(i.label){case 0:return t=e.chunks.splice(0,1)[0],[4,n._sendMessage(t)];case 1:return i.sent(),[2,t]}}))})),(function(e){return new Error("failed to send next chunk message: ".concat(e))})),g.cy((function(i){return t._waitForOtChunkAck(i,e)})))}},{key:"_waitForOtChunkAck",value:function(e,t){var i=this;return(0,_.pipe)(this._otChunksNotifier.waitFor(e.id,t),g.cy(this._sendNextOtChunk.bind(this)),g.qE((function(e){return i._log.error("failed sending OT chunks",e),e})))}},{key:"_handleSubmitOtChunkAck",value:function(e){this._log.trace("<<< Acknowledge for "+e.action,{message:e}),this._otChunksNotifier.notify(e.id)}},{key:"_handleCommandAck",value:function(e){this._log.trace("<<< Acknowledge for "+e.action,{message:e}),this._commandsRequester.onValue(e.id),this._handleAck(e)}},{key:"_handleAck",value:function(e){(0,_.pipe)(Q(e,this._asyncChecksManager),m.fold(u.constNull,this._handler.onAck))}},{key:"_handlePong",value:function(e){var t=window.performance.now();this._handler.onPong({kind:"pong",latency:(0,_.pipe)(m.fromNullable(this._pingsMap.get(e.id)),m.map((function(e){return t-e})))})}},{key:"_handleSynonyms",value:function(e){var t=this._parseSynonymsResult(e);this._handler.onSynonyms({kind:"synonyms",synonyms:t,word:e.token,position:e.synonyms.pos}),this._synonymsRequester.onValue(e.id,t)}},{key:"_handleSnippets",value:function(e){this._handler.onSnippets({kind:"get_snippets_list_response",snippets:e}),this._snippetsRequester.onValue(e.id,e)}},{key:"_handleTextStats",value:function(e){e.readingTime=K.R.calculateReadingTime(e.words),e.speakingTime=K.R.calculateSpeakingTime(e.words),this._handler.onStats({kind:"stats",stats:e}),this._statsRequester.onValue(e.id,e)}},{key:"_handleSDUIAdd",value:function(e,t){var i=this;(0,_.pipe)(this._toSduiIdDslSchemaTuple(e,t),m.map((function(t){var n=(0,l._)(t,2),s=n[0],r=n[1];return i._handler.onSDUI({kind:"sdui_add",sdui:r,sduiRootId:s,rev:e.rev})})))}},{key:"_handleSDUIRemove",value:function(e){this._handler.onSDUI({kind:"sdui_remove",sduiRootId:T.dV.Id.create(e.sduiRootId)})}},{key:"_handleSDUIUpdate",value:function(e,t){var i=this;(0,_.pipe)(this._toSduiIdDslSchemaTuple(e,t),m.map((function(t){var n=(0,l._)(t,2),s=n[0],r=n[1];return i._handler.onSDUI({kind:"sdui_update",sdui:r,sduiRootId:s,rev:e.rev})})))}},{key:"_handleUnexpectedSDUIMessage",value:function(e){var t;(null===(t=this._clientConfigs)||void 0===t?void 0:t.sdui)?this._log.error("skip ".concat(e.id," due to not configured dslParser.")):this.sendDebugReport(String(e.id),"got unexpected sdui message without sending sduiConfig")()}},{key:"_toSduiIdDslSchemaTuple",value:function(e,t){var i=e.sdui,n=e.rev,s=e.id,r=e.sduiRootId,o=this,a=T.dV.Id.create(r);return void 0===i?(this.sendDebugReport(String(s),"got unexpected empty sdui content for ".concat(n))(),this._log.error("skip ".concat(s," due to empty sdui content"),{messageId:s,rev:n}),m.none):(0,_.pipe)(t(i),p.fold((function(e){return o.sendDebugReport(String(s),e.message)(),o._log.error("skip ".concat(s," due to incorrect sdui content"),{messageId:s,message:e.message,rawSdui:i,rev:n}),m.none}),(function(e){return m.some([a,e])})))}},{key:"_createFinishEvent",value:function(e){return{kind:"finish",revision:e.rev,score:(0,_.pipe)(m.fromNullable(e.generalScore),m.filter((function(e){return e>=0})),m.map((function(t){return{errorRateScore:e.score,rank:t}}))),lowestScore:(0,_.pipe)(m.fromNullable(e.lowestGeneralScore),m.filter((function(e){return e>=0})),m.map((function(t){return{errorRateScore:e.score,rank:t}}))),scoreStatus:m.fromNullable(e.scoresStatus),removed:new Set(e.removed),dialect:e.dialect,outcomeScores:F.QB.OutcomeScores.normalize(e.outcomeScores),foreign:e.foreign}}},{key:"_parseSynonymsResult",value:function(e){var t=this,i=function(e){return e.derived};return{id:e.id.toString(),originalWord:e.token,synonymsOrGroups:function(e){return 0===e.synonyms.meanings.length?m.none:1===e.synonyms.meanings.length?m.some(p.left(e.synonyms.meanings[0].synonyms.map(i))):m.some(p.right(e.synonyms.meanings.map((function(n){return void 0===n.meaning&&t._log.warn("Absent meaning in synonyms group.",{token:e.token}),{meaning:Boolean(n.meaning)?n.meaning:"",words:n.synonyms.map(i)}}))))}(e),pname:e.synonyms.pname}}},{key:"_trySend",value:function(e){void 0===this._timeout&&e===L.SESSION_INBOUND?this._timeout=window.setTimeout(this._send,this._sendDelay):e!==L.WAITING_FOR_OT||this._changesQueue.isEmpty?this._log.trace("_trySend(".concat(L[e],") send timeout already set or not waiting for ot, ignoring")):(this._log.trace("_trySend(".concat(L[e],") moving to READY")),this._fsm.event(G.READY),this._handler.onReady({kind:"ready"}))}},{key:"_shouldHaveSeparateRevision",value:function(e){return"set_context"===e.action}},{key:"_pushChangesTask",value:function(e){var t=this;this._log.debug("pushChanges(".concat(L[this._fsm.current],"):"),JSON.stringify(e));var i,n=this,r=(i=(0,s._)((function(){var t;return(0,h.YH)(this,(function(i){switch(i.label){case 0:n._log.debug("pushChanges(".concat(L[n._fsm.current],"): starting new session")),i.label=1;case 1:return i.trys.push([1,3,,4]),n.resetReconnectInfo(),n._resetIdGenerators(),n._cleanupOldSession("new session started by pushing RESET state"),[4,n._startSession()];case 2:return i.sent(),[2,n._pushChanges(e)];case 3:return t=i.sent(),n._log.warn("pushChanges(".concat(L[n._fsm.current],"): failed sending start message: "),t),[2,p.left(t)];case 4:return[2]}}))})),function(){return i.apply(this,arguments)});return w.lY.isReset(e)&&this._fsm.is(L.SESSION_INBOUND,L.WAITING_FOR_ACK)?(this._log.debug("pushChanges(".concat(L[this._fsm.current],"): got reset while active session, starting new session")),r):g.oF((function(){return t._pushChanges(e)}))}},{key:"_pushChanges",value:function(e){var t=this;if(!this._canSend())return this._log.debug("pushChanges: cannot send, rejecting changes",e.kind),p.left(new R.Xb("Cannot accepts changes as WS connection is down"));var i=function(e){t._asyncChecksManager.stage(t._changesQueue.localRevision);var i=t._changesQueue.pushChanges(e);return t._textSize=e.prevLen+e.length,t._trySend(t._fsm.current),p.right(m.some(i))};return w.lY.isDelta(e)?this._fsm.is(L.WAITING_FOR_OT)?p.left(new R.r1("Capi is waiting for reset change but got a delta, dropping change")):i(e):w.lY.isReset(e)?i(w.lY.delta(e.delta)):(this._changesQueue.isEmpty||this.ping(),p.right(m.none))}},{key:"_sendInbandCommand",value:function(e,t){return this._sendLazyInbandCommand((function(){return e}),t)}},{key:"_sendTrackedInbandCommand",value:function(e,t){return this._sendLazyTrackedInbandCommand((function(){return e}),t)}},{key:"_sendLazyInbandCommand",value:function(e,t){return(0,_.pipe)(this._sendLazyTrackedInbandCommand(e,t),g.Tj(b.Up("result")))}},{key:"_sendLazyTrackedInbandCommand",value:function(e,t){var i=this;return function(){var n=e();if(i._log.trace("_sendInbandCommand(".concat(L[i._fsm.current],"): "),n.action),i._canSend()){var s=i._changesQueue.isEmpty,r=i._changesQueue.pushCommand(n),o=t.watchRequest(r);return s?(i._log.trace("_sendInbandCommand: Q.isEmpty, sending command immediately"),i._send()):(i._log.trace("_sendInbandCommand: Q.notEmpty, delaying sending command"),i._trySend(i._fsm.current)),o.then(p.map((function(e){return{result:e,queuedId:r}})))}return i._log.debug("_sendInbandCommand: cannot send, rejecting command",n.action),Promise.resolve(p.left(new R.Xb("Cannot send commands as WS connection is down")))}}},{key:"_processSubmitOTMessage",value:function(e){if(U.isChunkedChange(e)){var t=e.chunks.map((function(e){return{id:e.id,action:"submit_ot_chunk",chunk:e.chunk}})),i=t.splice(0,1)[0],n={chunks:t,submitOt:{id:e.id,action:"submit_ot",rev:e.rev,doc_len:e.change.prevLen,chunked:!0}};return this._waitForOtChunkAck(i,n)(),i}return{id:e.id,action:"submit_ot",rev:e.rev,doc_len:e.change.prevLen,deltas:[e.change.delta],deltasString:e.deltasString,chunked:!1}}},{key:"_sendMessage",value:function(e){var t=this;return this._log.isEnabled(C.$.TRACE)&&this._log.trace("Sending >>>> "+JSON.stringify(e).replace("\n"," ").substring(0,300)),this._handler.onMessageSent({kind:"message_sent",message:e}),"ping"===e.action&&this._pingsMap.set(e.id,window.performance.now()),(0,v.Y0)(this._conn,"_sendMessage should never be called without a connection").send(e).catch((function(e){return t._log.debug("fail on send",e)})).then((function(){if(void 0!==t._reconnectInfo){var e,i=null!==(e=t._reconnectInfo.messagesSent)&&void 0!==e?e:0;t._setReconnectInfo((0,d._)((0,c._)({},t._reconnectInfo),{messagesSent:i+1}))}}))}},{key:"_checkedTextSize",get:function(){return this._changesQueue.stagedAmount}},{key:"_clear",value:function(e){this._log.debug("clearing message queue, reason: "+e),this._pingsMap.clear(),this._changesQueue.isEmpty||this._log.warn("clean queue with messages",{reason:e,queue:this._changesQueue.toJSON()}),this._changesQueue.clear(e),this._externalCommandsRequester.clear(e),this._asyncChecksManager.reset(),this._resetTimer()}},{key:"_handleError",value:function(e){var t=this;return(0,s._)((function(){return(0,h.YH)(this,(function(i){switch(e.error){case T.O4.CANNOT_GET_TEXT_STATS:t._statsRequester.onError(e.id,new Error("Server Error"));break;case T.O4.CANNOT_FIND_SYNONYM:t._synonymsRequester.onError(e.id,new Error("can not find synonym"));break;case T.O4.RUNTIME_ERROR:t._fsm.is(L.WAITING_FOR_ACK)?(t._log.error("Got runtime_error for submit_ot",{message:e}),t._clear("runtime_error on submit_ot")):(t._handler.onError((0,c._)({kind:"error"},e)),t._clear("runtime_error"));break;default:t._handler.onError((0,c._)({kind:"error"},e)),t._log.error("Error",{message:e})}return[2]}))}))()}}]),e}(),$=function(){function e(){(0,r._)(this,e),(0,a._)(this,"_pendingRevision",void 0),(0,a._)(this,"_finishedRevisions",void 0),(0,a._)(this,"_wasChecked",{plagiarism:!1,ai_detector:!1,writing_expert_check:!1}),(0,a._)(this,"_toggleChecksRequests",new Map),this.reset()}return(0,o._)(e,[{key:"getCheckState",value:function(e){return this._pendingRevision>this._finishedRevisions[e]?this._wasChecked[e]?"checking":"full":"idle"}},{key:"getState",value:function(){return{plagiarism:this.getCheckState("plagiarism"),ai_detector:this.getCheckState("ai_detector"),writing_expert_check:this.getCheckState("writing_expert_check")}}},{key:"stage",value:function(e){this._pendingRevision=Math.max(this._pendingRevision,e)}},{key:"finish",value:function(e){this._finishedRevisions[e.check]=Math.max(this._finishedRevisions[e.check],e.rev),this._wasChecked[e.check]=!0}},{key:"reset",value:function(){this._pendingRevision=0,this._finishedRevisions={plagiarism:-1,ai_detector:-1,writing_expert_check:-1}}},{key:"resetCheck",value:function(e){this._finishedRevisions[e]=-1}},{key:"pushChecksByMessageId",value:function(e,t){this._toggleChecksRequests.set(e,t)}},{key:"popChecksByMessageId",value:function(e){var t=this._toggleChecksRequests.get(e)||{};return this._toggleChecksRequests.delete(e),t}}]),e}(),Q=function(e,t){switch(e.action){case"option":return m.some({kind:"option_ack"});case"set_context":case"submit_ot":return m.some({kind:"set_context_ack",revision:e.rev});case"submit_recipients":return m.some({kind:"submit_recipients_ack"});case"toggle_checks":return m.some({kind:"toggle_checks_ack",checks:t.popChecksByMessageId(e.id)});case"feedback":return m.some({kind:"feedback_ack",outcomeScores:e.scores?F.QB.OutcomeScores.normalize(e.scores):void 0,scoreStatus:e.scoresStatus});case"published":return m.some({kind:"published_ack",survey:e.survey});case"submit_survey_result":return m.some({kind:"submit_survey_result_ack"});case"submit_ot_chunk":case"shorten_it_submit":case"perfstats":case"user_action":case"debug_report":case"update_context_info":return m.none;default:return(0,v.xb)(e)}};!function(e){e.validate=function(e){var t=e.extra_properties.drilldownTree;return void 0===t?p.right(e):(0,_.pipe)(e,p.fromPredicate(T.tI.withTransformJson,(function(){return i("no transformJSON")})),p.chain((function(e){var t=e.transformJson.alternatives;return(0,_.pipe)(t,p.fromOption((function(){return i("no alternatives")})))})),p.chain((function(s){var r=s.alternatives;return t.length>0&&n(r)(t)?p.right(e):p.left(i("incomplete tree"))})));function i(t){return new Error("Incorrect drilldownTree: ".concat(JSON.stringify(e.extra_properties.drilldownTree)," - ").concat(t))}function n(e){return function(t){return t.every((function(t){var i=(0,l._)(t,2),s=i[0],r=i[1];return void 0!==e[s]&&(!!T.cq.isLeaf(r)||n(e)(r))}))}}}}(H||(H={}))},93910:(e,t,i)=>{i.d(t,{Mk:()=>p});var n=i(19147),s=i(6922),r=i(23988),o=i(10334),a=i(17171),c=i(2989),d=i(69063),l=i(58526),h=function(){function e(t,i){(0,n._)(this,e),(0,r._)(this,"_innerCon",void 0),(0,r._)(this,"_addTimer",void 0),this._innerCon=t,this._addTimer=i}return(0,s._)(e,[{key:"send",value:function(e){return this._innerCon.send(this._addTimer(e))}},{key:"close",value:function(e){return this._innerCon.close(e)}},{key:"_ws",get:function(){return this._innerCon._ws}},{key:"state",get:function(){return this._innerCon.state}}]),e}(),u=function(){return Math.trunc(window.performance.now())};function _(e,t){return new l.O2(e,t)}var p=function(){function e(t,i){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:u,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:c.A,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:_,p=this;(0,n._)(this,e),(0,r._)(this,"_innerWs",void 0),(0,r._)(this,"_idGenerator",void 0),(0,r._)(this,"_bufferSize",void 0),(0,r._)(this,"_clientClock",void 0),(0,r._)(this,"_timerIdGenerator",void 0),(0,r._)(this,"_defaultConnection",void 0),(0,r._)(this,"_log",void 0),(0,r._)(this,"_timers",void 0),(0,r._)(this,"_connection",void 0),this._innerWs=t,this._idGenerator=i,this._bufferSize=s,this._clientClock=o,this._timerIdGenerator=a,this._defaultConnection=l,this._log=d.Bx.Logging.getLogger("coreclients.capi.latencyMeasuringWSHandler"),this._timers=[],this._connection=null,this._innerWs=t.onDisconnect((function(){p._timers=[]})).onMessage((function(e,t){p._processTimerResponse(t)})).withConnection((function(e,t){return new h(p._defaultConnection(e,t),(function(e){return p._addTimerToRequest(e)}))})).onConnect((function(e){p._connection=e}))}return(0,s._)(e,[{key:"onConnecting",value:function(e){return this._innerWs.onConnecting(e),this}},{key:"onConnect",value:function(e){return this._innerWs.onConnect(e),this}},{key:"onDisconnect",value:function(e){return this._innerWs.onDisconnect(e),this}},{key:"onMessage",value:function(e){return this._innerWs.onMessage(e),this}},{key:"connect",value:function(e){return this._innerWs.connect(e)}},{key:"isDisconnected",value:function(){return this._innerWs.isDisconnected()}},{key:"_addTimerToRequest",value:function(e){if("string"==typeof e)return e;switch(e.action){case"ping":case"submit_ot":return(0,a._)((0,o._)({},e),{timer:{client_clock:this._clientClock(),id:this._timerIdGenerator()}});default:return e}}},{key:"_processTimerResponse",value:function(e){var t=this;switch(e.action){case"pong":case"finished":return void(e.timer&&(this._timers.push({id:e.timer.id,name:e.timer.name,client_clock:this._clientClock()}),this._timers.length>=this._bufferSize&&setTimeout((function(){return t._flush()}),0)));default:return}}},{key:"_flush",value:function(){this._timers.length>0&&(null===this._connection?this._log.warn("tried flushing when not connected"):(this._connection.send({id:this._idGenerator.newId(),action:"perfstats",timers:this._timers}),this._timers=[]))}}]),e}()},76099:(e,t,i)=>{i.d(t,{D:()=>n});var n,s=i(10334),r=i(17171),o=i(50659),a=i(87574),c=i(19840),d=i(11864);!function(e){e.Top=e=>o.createElement(t,(0,r._)((0,s._)({},e),{where:"top"})),e.Bottom=e=>o.createElement(t,(0,r._)((0,s._)({},e),{where:"bottom"}));const t=e=>o.createElement(a.F.div,(0,r._)((0,s._)({onTransitionEnd:e.onTransitionEnd},(0,c.Ly)(e.className,"top"===e.where?l.fixedTop:l.fixedBottom)),{"aria-label":e["aria-label"],role:e.role}),e.children)}(n||(n={}));const l=d.Ks.stylesheet({fixedTop:[{position:"fixed",top:0,height:0}],fixedBottom:[{position:"fixed",bottom:0}]})},46013:(e,t,i)=>{i.d(t,{h:()=>We});var n=i(98383),s=i(78429),r=i(23988),o=i(63336),a=i(86562),c=i(44297),d=i(58193),l=i(69063),h=i(12486);class u{constructor(){(0,r._)(this,"_log",l.Bx.Logging.getLogger("AlertManager.repository",h.$.DEBUG)),(0,r._)(this,"_allAlerts",new Map),(0,r._)(this,"_capiAlertsIdMapping",new Map),(0,r._)(this,"add",(e=>{this._allAlerts.set(e.id,e)})),(0,r._)(this,"remove",(e=>{this._log.trace("AllAlerts: Clean alert from all alerts",e.toLiteString()),(0,a.V1)(0===e.references,"can not dispose alert in use",(()=>e.toString())),(0,a.V1)(!1===e.isValid,"can not dispose valid alert",(()=>e.toString())),(0,a.V1)(this._allAlerts.delete(e.id),"alert should exist in alerts list",(()=>e.toString())),e.dispose()})),(0,r._)(this,"addToCapiMapping",(e=>{e.isValid||(0,o.pipe)(e.rawId,c.fold((()=>this._log.debug("skip register of local alert in capi mapping",e)),(t=>{this._log.trace("register alert in capi mapping",e.toLiteString()),(0,a.V1)(void 0===this._capiAlertsIdMapping.get(t),"unexpected overlap of rawid alert",(()=>e.toString())),e.validate(),this._capiAlertsIdMapping.set(t,e.id)})))})),(0,r._)(this,"removeFromCapiMapping",(e=>{e.isValid&&((0,o.pipe)(e.rawId,d.Mi((t=>{this._log.trace("clean valid alert capi mapping for: "+e.toLiteString()),(0,a.V1)(this._capiAlertsIdMapping.delete(t),"valid alert should had valid raw id",(()=>e.toString()))}))),e.invalidate())})),(0,r._)(this,"getByAlertId",(e=>c.fromNullable(this._allAlerts.get(e)))),(0,r._)(this,"getByRawAlertId",(e=>(0,o.pipe)(c.fromNullable(this._capiAlertsIdMapping.get(e)),c.chain(this.getByAlertId)))),(0,r._)(this,"swapRaw",((e,t)=>{const i=(0,o.pipe)(e.rawId,c.exists((e=>this._capiAlertsIdMapping.has(e)))),n=(0,o.pipe)(e.rawId,c.exists((e=>this._capiAlertsIdMapping.has(e))));(0,a.V1)(i||n,"At least one of the swapped alerts should be registered in the system");const s=e._raw;e.silentPatchWithRawAlert(t._raw),t.silentPatchWithRawAlert(s),i&&this._capiAlertsIdMapping.set(d.$v(e.rawId),e.id),n&&this._capiAlertsIdMapping.set(d.$v(t.rawId),t.id)})),(0,r._)(this,"toArray",(()=>Array.from(this._allAlerts.values()))),(0,r._)(this,"toMap",(()=>this._allAlerts)),(0,r._)(this,"toJSON",(()=>({allAlerts:Array.from(this._allAlerts.entries()),idMapping:Array.from(this._capiAlertsIdMapping.entries())})))}}var _,p=i(10334),g=i(17171),m=i(31784),f=i(30040),v=i(80074),b=i(66799),S=i(38832),y=i(54463),C=i(36840),k=i(58889),I=i(55172),A=i(96719),w=i(67947),R=i(94386),E=i(42543),T=i(15491),x=i(78339),F=i(19657),N=i(95168),M=i(11298),D=i(12884),O=i(89769),P=i(68533),U=i(36094),q=i(82718),B=i(60269),L=i(24946),G=i(62822),W=i(41139),K=i(22809),H=i(91612),z=i(44277),Y=i(59042),$=i(30186),Q=i(30396),V=i(53987),j=i(41949);!function(e){var t=e.group=j.fn.group;function i(e){return i=>(0,o.pipe)(e,Y.b.foldMap(t)(s,r,n),(0,$.c)(t.concat)(i))}e.eq=j.fn.eq,e.applyDiff=i,e.fromAlerts=function(e){const t=l.Bx.Logging.getLogger("DocumentCounters");return e.pipe(Q.S(((e,t)=>({alerts:t,counters:i(K.A.Diff.toRegistered(K.A.diff(e.alerts,t)))(e.counters)})),{alerts:K.A.empty,counters:j.fn.group.empty}),N.M((({counters:e})=>{j.fn.isValid(e)||t.error("Counters can not be below zero",j.fn.show.show(e))})),T.T((({counters:e})=>e)))};const n=e=>V.K.toUnmutedOnly(e.counters),s=(0,f.flow)(n,t.inverse),r=(e,i)=>t.concat(n(i),s(e))}(_||(_={}));var J,X=i(89606),Z=i(87485),ee=i(45560),te=i(70057),ie=i(74416),ne=i(62597);!function(e){function t(e){const{left:t,right:i}=(0,o.pipe)(e,Z.x1(c.fromNullable),Z.LV((e=>"GeneralScore"!==e)),Z.rO(((e,t)=>{return{lensId:(i=e,i===ne.J.SpecialId.Plagiarism?k.right(ne.J.SpecialId.Plagiarism):ne.J.OutcomeId.toOutcomeId(i)),score:ie.w.fromNumber(t)};var i})),Z.rT((0,X.J)(k.either))),n=(0,o.pipe)(i,Z.Tj((({lensId:e,score:t})=>(0,f.tuple)(e,t))),(e=>new Map(Object.values(e))));return(0,o.pipe)(te.T7(c.fromPredicate((0,f.not)(Z.Im))(t),c.fromPredicate((0,f.not)(ee.Im))(n)),c.getOrElse((()=>te.pG(new Map))))}e.empty=new Map,e.eq=ee.nZ(ne.J.Id.ord,ie.w.ord),e.fromCapi=function(e){return e.pipe(x.p((0,C.Ub)(y.o.is("finish"),y.o.is("async_check_finished"),y.o.is("feedback_ack"))),T.T((e=>e.outcomeScores)),x.p(C.O9),T.T(t),N.M(te.qE((e=>{Z.Im(e)||l.Bx.Logging.getLogger("LensesScores").error("failed to parse capi scores",e)}))),x.p((0,C.Ub)(te.ES,te.FG)),T.T((e=>e.right)))}}(J||(J={}));var se=i(889),re=i(73872),oe=i(97985),ae=i(49004),ce=i(28986),de=i(91242),le=i(77396),he=i(10047),ue=i(80755),_e=i(40711),pe=i(88761),ge=i(57797),me=i(88105),fe=i(63967);const ve=(0,C.Bj)(l.Bx.Logging.getLogger),be=(0,f.flow)(ge.Tj((({beingAppliedAlert:e,undo:t,reversedAlternative:i})=>oe.TX((()=>{const n={action:b.yp.ACCEPTED,commit:()=>ve("AlertManager.ops").debug(`_applyTransformJson(${e.toLiteString()}):commit()`),undo:t,reversedAlternative:e.registerReversedAlternative(i)},s=e.switchToApplied(n),r=fe.vs.create(s.state.from,pe.Y.create(e));return[s.id,r]}),k.toError))),oe.ED);function Se(e){const t=S.EF.compose(e.alternatives.map(m.Tj((e=>e.alternative))),e.currentFullText);return(0,o.pipe)(me.E.nonEmpty(t.composedDelta)?c.some(t):c.none,c.map((({composedDelta:t,reversedAlternatives:i})=>({changeWithFormatting:(0,o.pipe)(t,_e.N.getEnrichedWithFormattingDelta(e.currentFullText),(t=>ae.lY.delta(t,e.originalTextLength))),correctRevAlternatives:(0,o.pipe)(i,A.s.tapFailure((({rejected:e})=>l.Bx.Logging.getLogger("AlertManager.ops").error("failed to generate reverse alternative",e))),A.s.foldSuccess(he.Tj((t=>({reversedAlternative:t.reversedAlternative,alternative:m.Es(e.alternatives[t.alternativeIndex]),alert:e.alerts[t.alternativeIndex].alert})))))}))))}var ye;function Ce(e,t,i){return k.fromPredicate(e,(e=>{const n=new a.zU(t,e.toString());return l.Bx.Logging.getLogger("AlertManager.ops").error(t,{error:n,extra:i}),n}))}!function(e){const t=(0,f.flow)(((e,t)=>k.tryCatch((()=>fe.vs.create(e,t)),k.toError)),k.map((e=>(0,f.tuple)(e[0].id,e))),re.of);e.prepare=re.cy((0,f.tupled)(t)),e.prepareFromAlert=oe.cy((e=>t(e.state.from,pe.Y.create(e))))}(ye||(ye={}));const ke=(e,t)=>Ce(fe.Fc.isNotDisposed,e,t);function Ie(e){return oe.cy(c.fold((0,f.constant)(oe.pG(void 0)),e))}var Ae,we,Re,Ee,Te,xe;!function(e){e.mock={undoApplied:()=>oe.pG(void 0)}}(Ae||(Ae={}));class Fe{_applyFeedbackToAlert(e,t,i,n){return oe.TX((()=>{this._alertsRepo.removeFromCapiMapping(e);const s=this._createFeedbackUndoable(e,t,n);return e.changeState(fe.Fc.State.Applied.create(s,i,fe.Fc.State.Applied.Method.ByCard,pe.Y.create(e)))}),k.toError)}_createFeedbackUndoable(e,t,i){return{action:t,replacement:e.replaceText,commit:i,undo:()=>this._alertsRepo.addToCapiMapping(e)}}_commitFeedbackToCapi(e,t){return(0,o.pipe)(e.rawId,c.fold((0,f.constant)((()=>this._log.debug("skip feedback for local alert",e))),(e=>this._sendFeedback((0,p._)({id:e},t)))))}_sendFeedback(e){return()=>{le.hq(this._capiClient.sendFeedback(e)).catch(this._handleCapiError("alert feedback"))}}_commitShortenItSubmitToCapi(e){return(0,o.pipe)(e.rawId,c.fold((0,f.constant)((()=>this._log.debug("skip shorten-it-submit for local alert",e))),(e=>this._shortenItSubmit(e))))}_shortenItSubmit(e){return()=>{le.hq(this._capiClient.shortenItSubmit(e)).catch(this._handleCapiError("shorten-it-submit"))}}_switchToBeingApplied(e,t,i){return oe.TX((()=>(this._alertsRepo.removeFromCapiMapping(e),e.switchToBeingAppliedState(t,i))),k.toError)}constructor(e,t,i,n){(0,r._)(this,"_positionManager",void 0),(0,r._)(this,"_getContent",void 0),(0,r._)(this,"_capiClient",void 0),(0,r._)(this,"_alertsRepo",void 0),(0,r._)(this,"_log",void 0),(0,r._)(this,"_sendUpdate",void 0),(0,r._)(this,"_sendSingleUpdate",void 0),(0,r._)(this,"_flushChanges",void 0),(0,r._)(this,"changes",void 0),(0,r._)(this,"events",void 0),(0,r._)(this,"undoApplied",void 0),(0,r._)(this,"_dismissBatch",void 0),(0,r._)(this,"_applyAlert",void 0),(0,r._)(this,"_applyTransformJson",void 0),(0,r._)(this,"_alertFeedback",void 0),(0,r._)(this,"_alertBatchFeedback",void 0),(0,r._)(this,"_notifyAlertUpdated",void 0),(0,r._)(this,"_releaseRef",void 0),(0,r._)(this,"_changeMuteState",void 0),(0,r._)(this,"_changeGapValue",void 0),(0,r._)(this,"_confirmApplied",void 0),(0,r._)(this,"_changeTakeawayFeedback",void 0),(0,r._)(this,"_shortenItSummaryNotFound",void 0),(0,r._)(this,"_commitShortenItSummaryRequest",void 0),(0,r._)(this,"_dismissShortenItTransformGroup",void 0),(0,r._)(this,"_changeToneAIToneAlternative",void 0),(0,r._)(this,"_handleCapiError",void 0),(0,r._)(this,"_applyAlertData",void 0),(0,r._)(this,"_sendApplyFeedback",void 0),(0,r._)(this,"_sendApplyTextFeedback",void 0),(0,r._)(this,"_sendApplyTransformJsonFeedback",void 0),this._positionManager=e,this._getContent=t,this._capiClient=i,this._alertsRepo=n,this._log=l.Bx.Logging.getLogger("AlertManager.ops"),this._sendUpdate=e=>oe.TX((()=>this.events.next({updated:new Map(e)})),k.toError),this._sendSingleUpdate=oe.cy((e=>this._sendUpdate([e]))),this._flushChanges=oe.TX((()=>this.changes.next(ae.lY.flush())),k.toError),this.changes=new E.B7,this.events=new E.B7,this.undoApplied=(e,t)=>{return(0,o.pipe)((()=>this._positionManager.getTextLength()),re.cy((t=>{const n={alertsToUpdate:[],reversedDelta:new ce.R,undo:f.constVoid},s=e.filter(fe.Fc.isApplied).reduce(((e,t)=>{const n=t.state.undoable;return fe.Do.isWithAlternative(n)?(0,o.pipe)(n.reversedAlternative,c.fold((()=>{b.tI.withTransformJson(t._raw)&&this._log.error("No reversed delta registered for alert",{alert:t.toLiteString()}),i(e,t)}),(0,f.flow)((e=>e()),k.map((e=>e.delta)),k.fold((e=>{this._log.error("Could not retrieve reversed delta",{e,alert:t.toLiteString()})}),(n=>{i(e,t),(0,o.pipe)(n,S.EF.fromRawDelta,(t=>t.rebase(e.reversedDelta)),c.fold((()=>{e.reversedDelta=e.reversedDelta.compose(n)}),(({delta:t})=>{e.reversedDelta=e.reversedDelta.compose(t)})))}))))):i(e,t),e}),n);return s.alertsToUpdate.length>0?(0,o.pipe)(oe.TX((()=>{const e=(0,o.pipe)(s.reversedDelta,_e.N.getEnrichedWithFormattingDelta(this._getContent()));this.changes.next(ae.lY.delta(e,t))}),k.toError),oe.oW(this._flushChanges),oe.oW((0,o.pipe)(s.undo,re.Tj(k.right))),oe.g$((0,o.pipe)(s.alertsToUpdate,oe.ED,oe.cy(this._sendUpdate)))):oe.pG(void 0)})));function i(e,i){e.undo=(0,f.flow)(e.undo,i.state.undoable.undo),e.alertsToUpdate.push(ye.prepare((()=>[pe.Y.create(i),pe.Y.create(i.changeState(t===fe.Fc.State.Applied.Method.ByCard?fe.Fc.State.init:fe.Fc.State.Removed.create(fe.Fc.State.Removed.Reason.bulkAcceptUserResponse)))])))}},this._dismissBatch=(e,t)=>(0,o.pipe)(this._flushChanges,oe.g$((0,o.pipe)(e,he.Tj((0,f.flow)(re.of,re.Tj(ke("_dismissBatch: Cannot send feedback for already disposed",t)),oe.cy((e=>this._applyFeedbackToAlert(e,b.yp.IGNORE,fe.Kz.sidebar,this._commitFeedbackToCapi(e,{kind:b.yp.IGNORE,subtype:t})))),ye.prepareFromAlert)),oe.ED,oe.cy(this._sendUpdate)))),this._applyAlert=({alert:e,replacementText:t,source:i,method:n,feedbackSubtype:s,reason:r,gbPrompt:a})=>(0,o.pipe)(e,Ce(fe.Fc.isRegistered,"can not apply alert in non registered state"),re.of,oe.oW(this._flushChanges),oe.cy((e=>this._switchToBeingApplied(e,i,n))),oe.cy((({beingAppliedAlert:e,undo:i})=>(0,o.pipe)(e.getReplaceEither.bind(e),oe.wg,oe.wu((()=>new Error("Cannot apply alert with tJSON")),(n=>{this._log.debug(`_applyAlert(${e.toLiteString()}, rrange: ${n})`);const o=n.start,c=n.end-n.start,d=(new ce.R).retain(o).delete(t.length).insert(e.replaceText);return{alert:e,undo:i,reverseDelta:d,replacementText:t,removeLen:c,feedbackSubtype:s,pos:o,reason:r,gbPrompt:a}}))))),oe.cy(this._applyAlertData)),this._applyTransformJson=({alerts:e,source:t,method:i,feedbackSubtype:n,drilldownSuggestionIds:s,reason:r,gbPrompt:a})=>(0,o.pipe)(this._flushChanges,oe.g$((0,o.pipe)(e,oe.bm((e=>(0,o.pipe)(e.alternative,oe.Tj((t=>(0,f.tuple)(t,function(e){switch(e._raw.point){case"AllCapsBoldification":return S.UA.fromAlternativeBoldified;case"Lists":return S.UA.fromAlternativeListified;default:return S.UA.fromAlternative}}(e.alert))))))))),oe.cy((t=>oe.TX((()=>({alternatives:t,alerts:e,originalTextLength:this._positionManager.getTextLength(),currentFullText:this._getContent()})),k.toError))),oe.Tj(Se),Ie((e=>(0,o.pipe)(e.correctRevAlternatives,he.Tj((({alert:e,alternative:c,reversedAlternative:d})=>(0,o.pipe)(this._switchToBeingApplied(e,t,i),oe.W6((e=>oe.BK(this._sendApplyTransformJsonFeedback(e.beingAppliedAlert,c.alternativeIndex,n,s,r,a)))),oe.Tj((e=>(0,g._)((0,p._)({},e),{reversedAlternative:d})))))),oe.ED,oe.cy((t=>(0,o.pipe)(oe.TX((()=>this.changes.next(e.changeWithFormatting)),k.toError),oe.oW(this._flushChanges),re.g$((0,o.pipe)(be(t),oe.cy(this._sendUpdate)))))))))),this._alertFeedback=(e,t,i)=>{this._log.debug(`_alertFeedback(${e.toLiteString()}, feedbackType: ${t.kind}, source: ${i})`),fe.Fc.isHidden(e)&&this._log.error("Sending feedback for a hidden alert",{alert:e,feedbackType:t.kind});const n=this._commitFeedbackToCapi(e,t);return(0,o.pipe)(e,ke("_alertFeedback: Cannot send feedback for already disposed",t),re.of,oe.cy((e=>t.kind!==b.yp.LOOKED||e.isRead?b.MW.willRemoveAlert(t.kind)?(0,o.pipe)(this._flushChanges,oe.g$(this._applyFeedbackToAlert(e,t.kind,i,n)),ye.prepareFromAlert,this._sendSingleUpdate):(0,o.pipe)(n,oe.BK):(0,o.pipe)(ye.prepare((()=>[pe.Y.create(e),(e.isRead=!0,pe.Y.create(e))])),this._sendSingleUpdate,re.oW(n)))))},this._alertBatchFeedback=(e,t,i)=>(0,o.pipe)(e,he.x1((e=>e.rawId)),ue.ci,c.fold((0,f.constant)(f.constVoid),(e=>this._sendFeedback({kind:t,alertIds:e,subtype:i})))),this._notifyAlertUpdated=(0,f.flow)((e=>[[e[0].id,e]]),this._sendUpdate),this._releaseRef=(e,t)=>(0,o.pipe)(oe.TX((()=>{this._log.debug(`_releaseRef ${e} on (${t.toLiteString()}) refs: ${t._refNames}`,{shouldBeRemoved:fe.Fc.shouldBeRemoved(t)}),fe.Fc.shouldBeRemoved(t)&&this.events.next({removed:new Map([[t.id,pe.Y.create(t)]])})}),k.toError)),this._changeMuteState=(e,t)=>{const i=(0,o.pipe)(e,A.s.fromArray((0,f.flow)(ke("_changeMuteState: Cannot send Mute feedback for already disposed",t),k.chain(Ce((e=>c.isSome(e.muteCategory)||fe.Fc.belongsToAnySpecialCategory(e)),"Alert is not muting")))));return(0,o.pipe)(i,A.s.foldSuccess(he.Tj((e=>ye.prepare((()=>[pe.Y.create(e),(e.mute=t,pe.Y.create(e))]))))),oe.ED,oe.Tj(ue.ci),Ie(this._sendUpdate),oe.Tj((0,f.constant)(i)))},this._changeGapValue=(e,t)=>(0,o.pipe)(e,Ce(fe.Fc.isOneGap,"can not change gap value for a non one gap alert"),re.of,oe.cy((e=>ye.prepare((()=>[pe.Y.create(e),pe.Y.create(e.changeGapValue(t))])))),this._sendSingleUpdate),this._confirmApplied=(0,f.flow)(he.Tj((e=>ye.prepare((()=>[pe.Y.create(e),pe.Y.create(e.changeState(fe.Fc.State.Removed.create(fe.Fc.State.Removed.Reason.bulkAcceptUserResponse)))])))),oe.ED,oe.cy(this._sendUpdate)),this._changeTakeawayFeedback=(e,t)=>(0,o.pipe)(e,Ce(fe.Fc.isTakeaway,"can not change feedback for non-takeaway alert"),re.of,oe.cy((e=>{const i=pe.Y.create(e),n=e.setFeedback(t),s=pe.Y.create(n);return(0,o.pipe)(ye.prepare((()=>[i,s])),this._sendSingleUpdate,oe.Tj((()=>n)))}))),this._shortenItSummaryNotFound=e=>(0,o.pipe)(e,ke("_shortenItSummaryNotFound: Cannot change state to not-found for already disposed"),k.chain(Ce(fe.Fc.isShortenIt,"cannot change state to not-found for a non shorten-it alert")),re.of,oe.cy((e=>{const t=pe.Y.create(e),i=e.changeSummaryState("notFound"),n=pe.Y.create(i);return(0,o.pipe)(ye.prepare((()=>[t,n])),this._sendSingleUpdate,oe.Tj((()=>i)))}))),this._commitShortenItSummaryRequest=e=>(0,o.pipe)(e,ke("_commitShortenItSummaryRequest: Cannot send shorten_it_submit message for already disposed"),k.chain(Ce(fe.Fc.isShortenIt,"cannot send shorten_it_submit for a non shorten-it alert")),re.of,oe.cy((e=>{const t=pe.Y.create(e),i=e.changeSummaryState("requestSent"),n=pe.Y.create(i);return(0,o.pipe)(ye.prepare((()=>[t,n])),this._sendSingleUpdate,oe.Tj((()=>i)),re.oW(this._commitShortenItSubmitToCapi(e)))}))),this._dismissShortenItTransformGroup=(e,t)=>(0,o.pipe)(e,ke("_dismissShortenItTransformGroup: Cannot dismiss transform group for already disposed",t),k.chain(Ce(fe.Fc.isShortenIt,"cannot dismiss transform group for a non shorten-it alert")),re.of,oe.cy((e=>{const i=pe.Y.create(e),n=e.dismissTransformGroup(t),s=pe.Y.create(n);return(0,o.pipe)(ye.prepare((()=>[i,s])),this._sendSingleUpdate,oe.Tj((()=>n)))}))),this._changeToneAIToneAlternative=(e,t)=>(0,o.pipe)(e,Ce(fe.Fc.isToneAI,"Cannot change tone for a non-ToneAI alert."),re.of,oe.cy((e=>oe.TX((()=>{const i=[(0,f.tuple)(e.id,fe.vs.create(pe.Y.create(e),pe.Y.create(e.setSelectedToneAlternativeIdx(t))))];return this.events.next({updated:new Map(i)}),e}),k.toError)))),this._handleCapiError=e=>t=>{de.zN.isDroppedError(t)?this._log.debug(`Stopped listening for ${e} message acknowledge`,t):de.Xb.isNotConnectedError(t)?this._log.warn(`Failed to send ${e} as CAPI was not connected`,t):this._log.error(`Failed to send ${e}`,t)},this._applyAlertData=({pos:e,removeLen:t,reverseDelta:i,undo:n,replacementText:s,alert:r,feedbackSubtype:a,reason:d,gbPrompt:l})=>(0,o.pipe)(oe.TX((()=>{let o=this._positionManager.getTextLength(),h=!1;const u={action:b.yp.ACCEPTED,replacement:s,commit:()=>{h||this._log.debug(`_applyAlert(${r.toLiteString()}):commit()`)},reversedAlternative:c.none,undo:()=>{h=!0,this._log.debug(`_applyAlert(${r.toLiteString()}):undo()`);const e=this._positionManager.getTextLength();e!==o&&this._log.error(`Text has changed while uncommitted apply is present. Expected: ${o}, actual: ${e}`);const t=ae.lY.delta(i,e);this.changes.next(t),this.changes.next(ae.lY.flush()),n()}};return this._sendApplyTextFeedback(r,s,a,d,l)(),this.changes.next(ae.lY.delta((new ce.R).retain(e).delete(t).insert(s),o)),this.changes.next(ae.lY.flush()),o=this._positionManager.getTextLength(),u}),k.toError),oe.cy((e=>oe.TX((()=>r.switchToApplied(e)),k.toError))),ye.prepareFromAlert,this._sendSingleUpdate),this._sendApplyFeedback=(e,t)=>e.state.method===fe.Fc.State.Applied.Method.ByCard?this._commitFeedbackToCapi(e,t):f.constVoid,this._sendApplyTextFeedback=(e,t,i,n,s)=>this._sendApplyFeedback(e,{kind:b.yp.ACCEPTED,replacementText:t,subtype:i,reason:n,gbPrompt:s}),this._sendApplyTransformJsonFeedback=(e,t,i,n,s,r)=>{const o={kind:b.yp.ACCEPTED,alternativeIndex:t,subtype:i,drilldownSuggestionIds:n,reason:s,gbPrompt:r},a=fe.Fc.isOneGap(e)?(0,g._)((0,p._)({},o),{gapValue:e.gapValue}):fe.Fc.isShortenIt(e)?(0,g._)((0,p._)({},o),{dismissedTransformGroups:Array.from(e.dismissedTransformGroups)}):o;return this._sendApplyFeedback(e,a)}}}!function(e){e.toString=k.fold((({id:e})=>`rid:${e}`),(e=>`aid:${e.toString()}`))}(we||(we={})),function(e){e.match=function(e){return t=>t instanceof fe.Un?e.alertAddOrUpdate(t):t instanceof Map?e.rangeChange(t):"_tag"in t?e.alertRemove(t):e.alertChange(t)}}(Re||(Re={})),function(e){e.defaultValidator=fe.Fc.isDuplicatedBy}(Ee||(Ee={}));class Ne{static _prepareUpdate(e,t){const i=(0,g._)((0,p._)({},e.toRawAlert()),{rev:t.rev});return(0,o.pipe)(t.extraProperties,d.Mi((e=>i.extra_properties=e))),(0,o.pipe)(t.muted,d.Mi((e=>i.muted=e))),b.tI.withTransformJson(i)&&(0,o.pipe)(t.transformJson,d.Mi((e=>i.transformJson=e))),i}_processBatch(e){return e.reduce(((e,t)=>(Re.match({alertAddOrUpdate:t=>{(0,o.pipe)(t.rawId,c.fold((()=>{e.toAdd.set(t.id,t)}),(i=>{(0,o.pipe)(this._alertsRepo.getByRawAlertId(i),c.filter((e=>e.allowUpdate)),c.map((()=>{(0,o.pipe)(c.fromNullable(e.toAddOrUpdate.get(i)),c.map((t=>{this._log.debug("got overlap in batch on update"),e.toUpdate.delete(t.id),e.toDispose.set(t.id,t)}))),e.toUpdate.set(t.id,t)})),c.getOrElse((()=>{(0,o.pipe)(c.fromNullable(e.toAddOrUpdate.get(i)),c.map((t=>{this._log.info("got overlap in batch on add"),e.toAdd.delete(t.id),e.toDispose.set(t.id,t)}))),e.toAdd.set(t.id,t)}))),e.toAddOrUpdate.set(i,t)})))},rangeChange:t=>{(0,a.V1)(void 0===e.rangeChanges,"unexpected rangeChanges duplicate"),e.rangeChanges=t},alertRemove:t=>{e.toRemoveUnfiltered.push(t)},alertChange:t=>{e.toChangeUnfiltered.push(t)}})(t),e)),{toAdd:new Map,toRemoveUnfiltered:[],toChangeUnfiltered:[],toUpdate:new Map,toAddOrUpdate:new Map,rangeChanges:void 0,toDispose:new Map})}_getMergeTarget(e,t){return(0,o.pipe)(e,k.swap,c.fromEither,c.chain((e=>e.mergedIn)),c.chain((e=>{const i=(0,o.pipe)(this._alertsRepo.getByRawAlertId(e),c.map((e=>k.right(e))),c.alt((()=>(0,o.pipe)(c.fromNullable(t.get(e)),c.map((e=>k.left(e)))))));return c.isNone(i)&&this._log.warn("Merge from CAPI: Cannot find alert to merge into.",{capiId:e}),i})),c.filter(Me((e=>!!e.allowUpdate||(this._log.warn("Merge from CAPI: Trying to merge in a non-updatable alert, skipping. ",{target:e.toLiteString()}),!1)))))}_addAlerts(e,t){return e.length>0&&this._log.debug("_addAlerts, count = "+e.length,{alerts:e.map((e=>e.toLiteString()))}),(0,o.pipe)(e,he.pb(this._validateAlertAdd),he.TS({alertsToAdd:new Map,alertsToUpdate:new Map,alertsToRemove:t},((e,t)=>{this._log.trace("Adding alert: "+t.toLiteString());const i=this._getAlertsWithMatchingRanges(t.getNotEnclosingHighlightRanges()[0]),n=this._tryToMatchInvalid(t,i);switch(this._log.trace("Adding alert match result",{inc:t.id,match:n}),n.type){case Te.Type.Merged:{const i=n.result[1];fe.Fc.isNotRegistered(i.alert)?fe.Fc.isRemoved(i.alert)&&this._log.warn("unexpected merge into removed alert",{alert:i,newAlert:t}):this._alertsRepo.addToCapiMapping(i.alert),e.alertsToUpdate.set(i.id,n.result);break}case Te.Type.Restored:{const t=n.result[1];(0,a.V1)(!e.alertsToRemove.has(t.id),"can't update alert which we wanted to remove earlier"),this._alertsRepo.addToCapiMapping(t.alert),e.alertsToUpdate.set(t.id,n.result);break}case Te.Type.Unmatched:{const t=n.result,s=i.filter((i=>fe.Fc.isDuplicateCandidate(i,c.isNone(i.rawId))&&this._alertDuplicateValidator(t,i)&&!e.alertsToRemove.has(i.id)));(0,a.V1)(t.allowDuplicates||fe.Fc.isApplicableAlert(t),"BaseAlertImpl must allow duplicates or be an ApplicableAlert type");const r=t.allowDuplicates?{result:xe.Add,toRemove:c.none}:this._tryAddAlert(t,s);switch(r.result){case xe.Add:case xe.OverwriteExisting:this._log.debug("AllAlerts: Append alert to all alerts",t.toLiteString()),this._alertsRepo.addToCapiMapping(t),(0,a.V1)(!e.alertsToRemove.has(t.id),"can't add alert which we wanted to remove earlier",(()=>t.toLiteString())),this._alertsRepo.add(t),e.alertsToAdd.set(t.id,pe.Y.create(t)),(0,o.pipe)(r.toRemove,d.Mi((t=>{if(e.alertsToAdd.has(t.id)){this._alertsRepo.removeFromCapiMapping(t);const e=t.changeState(fe.Fc.State.Removed.create(fe.Fc.State.Removed.Reason.canceled));this._terminateAlertChecking(e),this._alertsRepo.remove(e)}else this._log.debug("schedule to remove duplicate",t.toLiteString()),e.alertsToRemove.set(t.id,{alert:t,reason:fe.Fc.State.Removed.Reason.duplicated});e.alertsToAdd.delete(t.id),e.alertsToUpdate.delete(t.id)})));break;case xe.Skip:this._log.debug("Skip alert with low priority",t.id);break;default:(0,a.xb)(r.result)}break}default:(0,a.xb)(n)}return e})))}_updateAlerts(e,t){this._log.debug(`_updateAlerts, to update = ${e.length}`,{alerts:e.map((e=>e.toLiteString()))}),(0,o.pipe)(e,he.TS(t,((e,t)=>(this._log.trace("Updating alert: "+t.toLiteString()),(0,o.pipe)(this._alertsRepo.getByRawAlertId(d.$v(t.rawId)),c.fold((()=>this._log.warn("tried to update unknown alert",t)),(i=>{const n=t._raw;t.dispose();const s=e.has(i.id)?e.get(i.id)[0]:pe.Y.create(i);i.enqueueRawAlertForUpdate(n),e.set(i.id,fe.vs.create(s,pe.Y.create(i)))}))),e))))}_startAlertsChecking(e,t,i){this._log.debug(`_startAlertsChecking, to update = ${e.length}`,{alerts:e.map((([e,t])=>[e.toLiteString(),t]))});const n=(e,t)=>{const i=e.changeState(fe.Fc.State.Registered.create(fe.Fc.CheckingState.CHECKING));return this._recheckedAlerts.add(e.id),pe.Y.create(t.size>0?i.enqueueRangesRemove(t):i)};(0,o.pipe)(e,he.TS({updatedAlerts:t,addedAlerts:i},((e,[t,i])=>((0,o.pipe)(this._alertsRepo.getByAlertId(t.id),c.fold((()=>{this._log.warn("tried to start checking unknown alert",{alert:t,ranges:i})}),(()=>{if(e.addedAlerts.has(t.id))e.addedAlerts.set(t.id,n(t,i));else{const s=e.updatedAlerts.has(t.id)?e.updatedAlerts.get(t.id)[0]:pe.Y.create(t);e.updatedAlerts.set(t.id,fe.vs.create(s,n(t,i)))}}))),e))))}_removeAlerts(e,t){e.forEach(((e,i)=>{(0,o.pipe)(this._alertsRepo.getByAlertId(i),c.fold((()=>{this._log.warn("tried to remove unknown alert",e)}),(()=>(0,o.pipe)(t.get(i),c.fromNullable,c.map(m.Es),c.filter((e=>fe.Fc.isNotDisposed(e.alert))),c.alt((()=>(0,o.pipe)(e.alert,c.fromPredicate(fe.Fc.isNotDisposed),c.map(pe.Y.create)))),d.Mi((n=>{const s=this._applyRemoveToAlert(e);this._terminateAlertChecking(s),t.set(i,fe.vs.create(n,pe.Y.create(s)))}))))))}))}_getAlertsWithMatchingRanges(e){return(0,o.pipe)(this._positionManager.findIntersections(e),he.pb((0,C.M4)(se.a.is,se.l.isVisible)),he.pb((0,C.AU)(se.l.isEnclosingView)),he.x1((e=>this._alertsRepo.getByAlertId(e.meta.alertId))),he.pb((e=>!(fe.Fc.isApplied(e)&&e.getAppliedRanges().length>0))))}_tryToMatchInvalid(e,t){return(0,a.V1)(!e.isValid,"added alert should be invalid"),(0,a.V1)(fe.Fc.isRegistered(e),"added alert should be in registered state",(()=>e.toString())),(0,o.pipe)(c.fromNullable(t.find((t=>!t.isValid&&t.canBeMergedWith(e)))),c.fold((()=>({result:e,type:Te.Type.Unmatched})),(t=>{(0,a.V1)((0,o.pipe)(t.rawId,d.Lw((0,f.flow)(this._alertsRepo.getByRawAlertId,c.isNone))),"CAPI mapping should not contain invalid alerts"),this._log.debug(`Merging new alert (${e}) into the existing one aid(${t})`);const i=pe.Y.create(t);return t.patchWithRawAlert(e._raw),e.dispose(),t.allowUpdate&&fe.Fc.isCapiDone(t)?{result:fe.vs.create(i,pe.Y.create(t.changeState(fe.Fc.State.init))),type:Te.Type.Restored}:{result:fe.vs.create(i,pe.Y.create(t)),type:Te.Type.Merged}})))}_tryAddAlert(e,t){return(0,o.pipe)(ue.ci(t),c.map((t=>{(0,a.V1)(1===t.length,"Only one visible alert to one range is expected while _tryEnqueueAlert",`got ${t.map((e=>e.toString()))} with input (${e.toString()})`);const i=t[0];return i.extraProperties.priority<=e.extraProperties.priority?{result:xe.OverwriteExisting,toRemove:c.some(i)}:(e.dispose(),{result:xe.Skip,toRemove:c.none})})),c.getOrElse((()=>({result:xe.Add,toRemove:c.none}))))}_cleanupPendingAlerts(e){e.removed.forEach((e=>{this._heuristicallyRemovedAlerts.delete(e)&&this._log.info("unexpected alert remove from finish msg",e)})),this._heuristicallyRemovedAlerts.size>0&&this._log.debug("we had heuristically removed alerts which were not confirmed by capi",{size:this._heuristicallyRemovedAlerts.size}),this._heuristicallyRemovedAlerts.clear()}_finishAlertsChecking(){return(0,o.pipe)(Array.from(this._recheckedAlerts.values()),he.x1((e=>{const t=this._alertsRepo.getByAlertId(e);c.isNone(t)&&(this._log.error("tried to finish checking on missing alert",e),this._recheckedAlerts.delete(e));const i=(0,o.pipe)(t,c.filter((e=>fe.Fc.isRegistered(e))),c.map((e=>(0,f.tuple)(e.id,this._finishAlertChecking(e)))));return c.isNone(i)&&this._log.error("tried to update checking state on non-registered alert",e),i})),(e=>({updated:new Map(e)})))}constructor(e,t,i){(0,r._)(this,"_positionManager",void 0),(0,r._)(this,"_alertsRepo",void 0),(0,r._)(this,"_alertDuplicateValidator",void 0),(0,r._)(this,"_log",void 0),(0,r._)(this,"_heuristicallyRemovedAlerts",void 0),(0,r._)(this,"process",void 0),(0,r._)(this,"reset",void 0),(0,r._)(this,"_processAlertsBatch",void 0),(0,r._)(this,"_collectChanges",void 0),(0,r._)(this,"_validateAlertAdd",void 0),(0,r._)(this,"_recheckedAlerts",void 0),(0,r._)(this,"_terminateAlertChecking",void 0),(0,r._)(this,"_applyRemoveToAlert",void 0),(0,r._)(this,"_finishAlertChecking",void 0),this._positionManager=e,this._alertsRepo=t,this._alertDuplicateValidator=i,this._log=l.Bx.Logging.getLogger("AlertManager.pipeline",h.$.DEBUG),this._heuristicallyRemovedAlerts=new Map,this.process=e=>(this._log.trace(`process, to process = ${e.length}`),this._collectChanges(this._processAlertsBatch(e))),this.reset=e=>(this._cleanupPendingAlerts(e),this._finishAlertsChecking()),this._processAlertsBatch=e=>{const{toAdd:t,toUpdate:i,toAddOrUpdate:n,toRemoveUnfiltered:s,toChangeUnfiltered:r,toDispose:l,rangeChanges:h}=this._processBatch(e),u=e=>(0,o.pipe)(this._alertsRepo.getByAlertId(e),c.getOrElse((()=>t.get(e)||i.get(e)||l.get(e))));r.forEach((e=>(0,o.pipe)(c.fromNullable(n.get(e.id)),c.fold((()=>(0,o.pipe)(this._alertsRepo.getByRawAlertId(e.id),c.map((t=>{const s=t.copy(!1),r=Ne._prepareUpdate(s,e);c.isSome(e.transformJson)?s.updateAlertWithManagedData(r):s.patchWithRawAlert(r),i.set(s.id,s),n.set(e.id,s)})),c.getOrElse((()=>this._log.info("Change from CAPI: Cannot find internal AlertId."))))),(t=>{const n=Ne._prepareUpdate(t,e);i.has(t.id)?t.patchWithRawAlert(n):t.updateAlertWithManagedData(n)})))));const _=s.reduce(((e,s)=>{const r=(0,o.pipe)(s,k.fold((({id:e})=>(0,o.pipe)(this._alertsRepo.getByRawAlertId(e),c.map((e=>fe.Fc.isRegistered(e)?e:void 0)),c.getOrElse((()=>this._heuristicallyRemovedAlerts.has(e)?void this._heuristicallyRemovedAlerts.delete(e):n.get(e))))),u));return void 0===r?(k.isLeft(s)?this._log.debug("Remove from CAPI: Cannot find internal AlertId. capiId: #"+JSON.stringify(s.left)):this._log.error("Cannot find existing alert by id",s.right),e):((0,o.pipe)(this._getMergeTarget(s,n),c.filter(Me((e=>e.lensId!==r.lensId?(this._log.warn("Trying to merge alerts from different lenses",{source:r,target:e}),!1):c.isNone(r.rawId)?(this._log.warn("Trying to merge into local alert",{source:r,target:e}),!1):r.references>e.references))),c.fold((()=>{e.set(r.id,{alert:r,reason:(0,o.pipe)(s,k.swap,c.fromEither,c.chain((e=>e.hint)),c.chain((e=>e===y.Q.NotFixed?c.some(fe.Fc.State.Removed.Reason.capiDismiss):c.none)),c.getOrElse((()=>fe.Fc.State.Removed.Reason.capiDone)))})}),k.fold((e=>{this._log.debug("swap raw alerts with new alert",{source:r.toString(),newTarget:e.toString()}),this._alertsRepo.swapRaw(r,e);const s=d.$v(r.rawId);(0,a.V1)(void 0===i.get(e.id),"Added alert should not be present in the updated alerts map",(()=>i.get(e.id).toString()));const o=r.copy();i.set(o.id,o),n.set(s,o),t.delete(e.id),l.set(e.id,e)}),(t=>{this._log.debug("swap raw alerts with existing alert",{source:r.toString(),existingTarget:t.toString()}),this._alertsRepo.swapRaw(r,t),e.set(t.id,{alert:t,reason:fe.Fc.State.Removed.Reason.capiDismiss})})))),e)}),new Map),p=new Map;return h&&h.forEach(((e,t)=>{(0,o.pipe)(t,u,c.fromPredicate((n=>n?fe.Fc.isInteractable(n)?!i.has(n.id)||(this._log.debug("skip range change on updateHolder alert",n.toLiteString()),!1):(this._log.debug("skip range change on non-interactable alert",n.toLiteString()),!1):(this._log.warn("got range changes for unknown alert",{alertId:t,alertRanges:e}),!1))),c.chain((i=>(0,o.pipe)(i.onRangeChange(e),c.map((e=>{switch(e.state){case fe.Fc.Transition.State.Pending:return p.set(i.id,[i,e.removedRanges]);case fe.Fc.Transition.State.Dispose:return(0,o.pipe)(i.rawId,c.fold((()=>this._log.debug("dispose by range change on unknown rid",i.id)),(e=>this._heuristicallyRemovedAlerts.set(e,i)))),_.set(t,{alert:i,reason:fe.Fc.State.Removed.Reason.textChange});default:return(0,a.xb)(e)}}))))))})),_.forEach((({alert:e})=>{this._log.trace("check cancellations from toRemove: "+e.toLiteString()),(0,o.pipe)(e.rawId,c.fold((()=>{t.get(e.id)&&(this._log.debug("cancel add local alert for: "+e.toLiteString()),t.delete(e.id),_.delete(e.id),l.set(e.id,e)),(0,a.V1)(!1===i.has(e.id),"Added local alert should not be present in the updated alerts map",(()=>i.get(e.id).toString()))}),(s=>{const r=n.get(s);r&&(n.delete(s),t.delete(r.id)?(this._log.debug("cancel add for: "+r.toLiteString()),this._log.debug("cancel remove for: "+e.toLiteString()),_.delete(e.id),l.set(e.id,e),l.set(r.id,r)):i.delete(r.id)?(this._log.debug("cancel update for: "+r.toLiteString()),r.id!==e.id&&(this._log.debug("marking update to dispose: "+r.toLiteString()),l.set(r.id,r))):this._log.error("_addOrUpdateAlert toAdd || toUpdate mapping in unsync state!",r))}))),this._log.trace("check if local orphan toRemove: "+e.toLiteString()),(0,o.pipe)(this._alertsRepo.getByAlertId(e.id),c.fold((()=>{this._log.debug("cancel delete for: "+e.toLiteString()),_.delete(e.id)}),f.constVoid))})),l.size>0&&this._log.debug(`_cancelAlerts, to cancel = ${l.size}`,{alerts:Array.from(l.values()).map((e=>e.toLiteString()))}),l.forEach((e=>{p.delete(e.id)&&this._log.debug("cancel startChecking for: "+e.toLiteString());try{e.dispose()}catch(t){this._log.warn("unexpected error on disposing canceled alert",t,e)}})),{toAdd:t,toUpdate:i,toRemove:_,toStartChecking:p}},this._collectChanges=({toAdd:e,toUpdate:t,toRemove:i,toStartChecking:n})=>{const{alertsToAdd:s,alertsToUpdate:r,alertsToRemove:o}=this._addAlerts(Array.from(e.values()),i);return t.size>0&&this._updateAlerts(Array.from(t.values()),r),n.size>0&&this._startAlertsChecking(Array.from(n.values()),r,s),o.size>0&&this._removeAlerts(o,r),{added:s,updated:r}},this._validateAlertAdd=e=>{try{const t=!fe.Fc.isPremium(e)||void 0!==e.categoryHuman;return e._raw.impact!==b.tI.Impact.Critical&&e._raw.impact!==b.tI.Impact.Advanced&&c.isSome(e.rawId)&&this._log.warn("CAPI provides corrupted impact prop",{alert:e,raw:b.tI.clearUserTextFields(e._raw)}),t||(this._log.error("CAPI provides corrupted alert",{alert:e,raw:b.tI.clearUserTextFields(e._raw)}),e.dispose()),(0,o.pipe)(e.rawId,c.exists((e=>c.isSome(this._alertsRepo.getByRawAlertId(e)))))?(this._log.warn("unexpected overlap on rawId for non-updatable alert",{alert:e,raw:b.tI.clearUserTextFields(e._raw)}),e.dispose(),!1):e.lensType===ne.J.Type.Plagiarism&&ie.w.isMax(e.progress)?(this._log.info("CAPI provides a Plagiarism alert with an invalid progress",{alert:e,raw:b.tI.clearUserTextFields(e._raw)}),e.dispose(),!1):t}catch(t){this._log.error("Cannot validate alert",t);try{e.dispose()}catch(e){this._log.warn("Cannot dispose invalid alert",e)}return!1}},this._recheckedAlerts=new Set,this._terminateAlertChecking=({id:e})=>{this._recheckedAlerts.delete(e)&&this._log.debug("Stopped watching checking state for alert",e)},this._applyRemoveToAlert=({alert:e,reason:t})=>(this._alertsRepo.removeFromCapiMapping(e),t!==fe.Fc.State.Removed.Reason.textChange&&t!==fe.Fc.State.Removed.Reason.duplicated&&e.clearCapiId(),e.changeState(fe.Fc.State.Removed.create(t))),this._finishAlertChecking=e=>{(0,a.V1)(this._recheckedAlerts.delete(e.id),"tried to finish checking on alert which had not been marked as checking"),this._log.debug("Stopped watching checking state for alert",e.id);const t=pe.Y.create(e);return fe.vs.create(t,pe.Y.create(e.changeState(fe.Fc.State.Registered.create(fe.Fc.CheckingState.IDLE))))}}}function Me(e){return k.fold(e,e)}!function(e){let t;!function(e){e.Unmatched="Unmatched",e.Merged="Merged",e.Restored="Restored"}(t=e.Type||(e.Type={}))}(Te||(Te={})),function(e){e.Skip="Skip",e.Add="Add",e.OverwriteExisting="OverwriteExisting"}(xe||(xe={}));var De,Oe=i(11783);class Pe{flushAlerts(){this._flush.next()}loadAlerts(e){const t=new Map;return(0,C.z2)(e)&&(this._log.debug(`${e.length} external alert(s) where loaded`),e.map(Oe.P.splitById).map((({id:e,local:t})=>({id:e,alert:fe.Fc.create((0,o.pipe)(t,b.tI.matchBy(f.identity,(e=>(0,g._)((0,p._)({},e),{transformJson:{highlights:e.transformJson.highlights,alternatives:(0,o.pipe)(e.transformJson.alternatives,c.map(S.EF.Group.fromSerialized))}})),f.identity),this._transformRawAlert),this._ops,this._positionManager,this._alternativeManager)}))).forEach((({id:e,alert:i})=>{this._addAlertBuffered(i),e&&t.set(e,i.id)}))),t}toString(){return JSON.stringify(this,void 0,2)}toJSON(){return{repo:this._alertsRepository}}dispose(){this._subs.forEach((e=>e.unsubscribe())),this._subs=[]}_getTypeFilter(e){switch(e){case"alert":return e=>!fe.Fc.isPlagiarism(e);case"plagiarism":return e=>fe.Fc.isPlagiarism(e);default:return(0,a.xb)(e)}}_addAlertBuffered(e){this._log.trace(`_addAlert(${e.toLiteString()})`),this._addAlerts.next(e)}_handleFreePremium(e){this._log.trace(`_handleFreePremium(${e.id})`),Boolean(e.updatable)&&(0,o.pipe)(this._alertsRepository.getByRawAlertId(e.id),c.filter(fe.Fc.isNotDisposed),d.Mi((()=>this._removeAlertBuffered(k.left({id:e.id,mergedIn:c.none,hint:c.none})))));const t=fe.Fc.create(this._transformRawAlert(e),this._ops,this._positionManager,this._alternativeManager);this.flushAlerts(),this._freePremiumAlerts.next(t)}_changeAlertBuffered(e){this._log.trace(`_changeAlert(${e.id})`),this._changeAlerts.next(e)}_removeAlertBuffered(e){this._log.trace(`_removeAlert(${we.toString(e)})`),this._removeAlerts.next(e)}_getAllAlertsAsArray(){return this._alertsRepository.toArray().filter(fe.Fc.isNotRemoved)}constructor(e,t,i,n,s,a,d,p=Ee.defaultValidator,g=new u,b=e.rangeChanged){(0,r._)(this,"_positionManager",void 0),(0,r._)(this,"_alternativeManager",void 0),(0,r._)(this,"_getContent",void 0),(0,r._)(this,"_capiEvents",void 0),(0,r._)(this,"_capiClient",void 0),(0,r._)(this,"_documentCounters",void 0),(0,r._)(this,"_transformRawAlert",void 0),(0,r._)(this,"_alertDuplicateValidator",void 0),(0,r._)(this,"_alertsRepository",void 0),(0,r._)(this,"rangeChanged",void 0),(0,r._)(this,"_state",void 0),(0,r._)(this,"state",void 0),(0,r._)(this,"lensesScores",void 0),(0,r._)(this,"_log",void 0),(0,r._)(this,"_subs",void 0),(0,r._)(this,"_addAlerts",void 0),(0,r._)(this,"_removeAlerts",void 0),(0,r._)(this,"_changeAlerts",void 0),(0,r._)(this,"_freePremiumAlerts",void 0),(0,r._)(this,"_flush",void 0),(0,r._)(this,"_alertsPerRevision",void 0),(0,r._)(this,"_ops",void 0),(0,r._)(this,"_pipeline",void 0),(0,r._)(this,"changes",void 0),(0,r._)(this,"loadScores",void 0),(0,r._)(this,"undoApplied",void 0),(0,r._)(this,"_invalidateAlerts",void 0),(0,r._)(this,"_removeInvalidAlerts",void 0),(0,r._)(this,"_onCapiEvent",void 0),(0,r._)(this,"_emitDomainEvent",void 0),(0,r._)(this,"_prepareDiff",void 0),(0,r._)(this,"_disposeAlert",void 0),this._positionManager=e,this._alternativeManager=t,this._getContent=i,this._capiEvents=n,this._capiClient=s,this._documentCounters=a,this._transformRawAlert=d,this._alertDuplicateValidator=p,this._alertsRepository=g,this.rangeChanged=b,this._state=v.s.create(z.z.empty),this.state=this._state.view(z.z.toCheckingResult),this.lensesScores=v.s.create(J.empty),this._log=l.Bx.Logging.getLogger(Pe.loggerName,h.$.TRACE,h.I.Manager.getColor()),this._subs=[],this._addAlerts=new E.B7,this._removeAlerts=new E.B7,this._changeAlerts=new E.B7,this._freePremiumAlerts=new E.B7,this._flush=new E.B7,this._alertsPerRevision=0,this._pipeline=new Ne(this._positionManager,this._alertsRepository,this._alertDuplicateValidator),this._invalidateAlerts=()=>{this.flushAlerts();const[e,t]=I.jB(this._getAllAlertsAsArray(),(e=>e.isValid));this._log.debug("Invalidate alerts...",{valid:e.length,invalid:t.length}),e.forEach((e=>{this._alertsRepository.removeFromCapiMapping(e),e.clearCapiId()})),t.forEach((e=>e.clearCapiId()))},this._removeInvalidAlerts=e=>{this._log.debug(`Removing invalid alerts by type '${e}'...`);const t=this._getTypeFilter(e),i=this._getAllAlertsAsArray().filter((e=>!e.isValid&&fe.Fc.isNotDisposed(e)&&fe.Fc.isRegistered(e)&&t(e)));i.forEach((e=>this._removeAlertBuffered(k.right(e.id)))),this._log.debug(`${i.length} invalid alerts removed`),this.flushAlerts(),this._log.isEnabled(h.$.TRACE)&&this._log.trace("Removed alerts",i.map((e=>e.toString())))},this._onCapiEvent=e=>{try{switch("alert_received"===e.kind&&this._alertsPerRevision++,e.kind){case"alert_received":case"plagiarism_alert_received":if(!1===e.alert.hidden&&void 0===e.alert.cardLayout)return void this._log.warn("got alert with empty mapping",{pname:e.alert.pname});"unlocked"===e.alert.extra_properties.free_premium?this._handleFreePremium(e.alert):this._addAlertBuffered(fe.Fc.create(this._transformRawAlert(e.alert),this._ops,this._positionManager,this._alternativeManager));break;case"alert_removed":this._log.debug(`Remove from capi #${e.alertId}, merged in #${c.getOrElse((()=>"None"))(e.mergedIn)}, hint: ${c.getOrElse((()=>"None"))(e.hint)}`),(0,o.pipe)(this._alertsRepository.getByRawAlertId(e.alertId),c.exists(fe.Fc.isBulkApplied))||this._removeAlertBuffered(k.left({id:e.alertId,mergedIn:e.mergedIn,hint:e.hint}));break;case"alert_changed":this._log.debug("Alert change from capi #"+e.alertId),this._changeAlertBuffered({id:e.alertId,rev:e.rev,extraProperties:c.fromNullable(e.extraProperties),transformJson:c.fromNullable(e.transformJson),muted:c.fromNullable(e.muted)});break;case"finish":this._log.debug(`Alerts per revision (#${e.revision}): ${this._alertsPerRevision}`),this._alertsPerRevision=0,"idle"===this._capiClient.checkingState&&this._emitDomainEvent(this._pipeline.reset(e))}}catch(t){R.sw.isErrorLike(t)?this._log.error("Cannot handle CAPI event.",t,{capiEvent:e}):this._log.error("Cannot handle CAPI event.",{capiEvent:e,error:t})}},this._emitDomainEvent=e=>{(0,o.pipe)(e,this._prepareDiff,H.z.createDiff,A.s.recover((e=>this._log.error("conflicts on diff creating",e))),(e=>(this._log.debug("_emitDomainEvent",K.A.Diff.show.show(e)),e)),z.z.applyDiff,w.Tj(A.s.recover((e=>this._log.error("conflicts on diff apply",e)))),(e=>this._state.modify(e)))},this._prepareDiff=({added:e,updated:t=new Map,removed:i=new Map})=>(t.forEach(((e,n)=>{(0,o.pipe)(e,m.gp,fe.Fc.fromAlertModel,fe.Fc.shouldBeRemoved)&&(t.delete(n),i.set(n,e[0]))})),i.forEach((0,f.flow)(fe.Fc.fromAlertModel,this._disposeAlert)),{added:e,updated:t,removed:i}),this._disposeAlert=e=>{if(fe.Fc.isApplied(e)&&e.state.undoable.commit(),fe.Fc.isNotRegistered(e))try{this._alertsRepository.remove(e)}catch(t){this._log.error("Cannot remove alert.",t),fe.Fc.isNotDisposed(e)&&e.dispose()}else this._log.error("unexpected remove of registered alert",e.toString())},this._ops=new Fe(this._positionManager,this._getContent,this._capiClient,this._alertsRepository),this.loadScores=e=>{this.lensesScores.set(e)},this.undoApplied=this._ops.undoApplied,this.changes=this._ops.changes;const S=this.rangeChanged.pipe(T.T((({affected:e})=>e)),x.p((e=>e.length>0)),T.T((e=>F.$z((e=>e.meta.alertId),e.filter(se.a.is)))),x.p((e=>e.size>0)),N.M((e=>this._log.debug("Range[s] changed",e))),M.u()),Y=D.Y(250).pipe(O.Z(0),P.h(this._flush)),$=U.uj(this._log);this._subs.push($("_alertsInvalidation",this._capiEvents.pipe(x.p((e=>y.o.is("session_started")(e)&&e.isNewSession)),N.M(this._invalidateAlerts),q.K(B.h(this._capiEvents.pipe(x.p(y.o.is("finish")),L.s(1),G.u("alert")),this._capiEvents.pipe(x.p(y.o.is("async_check_finished")),L.s(1),G.u("plagiarism")))),N.M(this._removeInvalidAlerts))),$("_capiEvents",this._capiEvents.pipe(N.M(this._onCapiEvent))),$("_alertsProccesing",this._addAlerts.pipe(P.h(this._freePremiumAlerts),P.h(this._removeAlerts),P.h(this._changeAlerts),P.h(S),W.r(Y),x.p(C.z2),T.T(this._pipeline.process),N.M(this._emitDomainEvent))),$("_alertsBuffer",S.pipe(P.h(this._capiEvents.pipe(x.p(y.o.is("before_finish","before_async_check_finish","async_check_finished")))),G.u(U.q6),N.M(this._flush))),$("_alertOpsAlertChanges",this._ops.events.pipe(N.M(this._emitDomainEvent))),$("_lensesScoresChanges",J.fromCapi(this._capiEvents).pipe(N.M(U.H9(this.lensesScores)))),$("documentCountersChanges",_.fromAlerts(this._state.view(H.z.iso.wrap)).pipe(N.M(U.H9(this._documentCounters))))),(0,C.hJ)("alerts",(()=>this.toString())),(0,C.hJ)("triggerRemove",(e=>{this._removeAlertBuffered(k.right(e))}))}}(0,r._)(Pe,"loggerName","AlertManager"),function(e){e.create=function(e){const t=t=>(0,o.pipe)(e.get(),K.A.get(t),c.map(fe.Fc.fromAlertModel)),i=e=>(0,o.pipe)(t(e),c.filter(fe.Fc.isInteractable)),n=e=>(0,o.pipe)(t(e),c.filter(fe.Fc.isRegistered)),s=(0,f.flow)(n,c.filter((0,C.M4)(fe.Fc.isNotDisposed,(0,f.not)(fe.Fc.isInPremiumLens),(0,f.not)(fe.Fc.isHidden)))),r=(0,f.flow)(s,c.isSome);return{getById:t,getRegistered:n,getInteractable:i,getValidForFeedback:s,isValidForFeedback:r,isRegistered:e=>(0,o.pipe)(n(e),c.isSome),isInteractable:e=>(0,o.pipe)(i(e),c.isSome)}}}(De||(De={}));var Ue=i(69082),qe=i(23121);class Be{apply(e,t){const{alternativeIndex:i,source:n}=t;return this._log.trace("apply",e),(0,o.pipe)(this._findAlert(e),k.chain(k.fromPredicate(fe.Fc.isApplicableAlert,(()=>new Error("cannot apply not applicable alert")))),k.chain((e=>(0,o.pipe)(qe.zb((()=>e.apply(t))),k.mapLeft((t=>(this._log.error("apply single alert error",{error:t,alert:e.toLiteAlert(),alternativeIndex:i,source:n}),t)))))))}applyBulk(e,t){this._log.trace("applyBulk",e),this.sendBatchFeedback(e,b.l.BULK_ACCEPTED,t);const i=(0,o.pipe)(e,A.s.fromArray((e=>(0,o.pipe)(this._findAlert(e),k.mapLeft((t=>(0,f.tuple)(t,{id:e}))),k.chain(k.fromPredicate(fe.Fc.isRegisteredApplicableAlert,(e=>(0,f.tuple)(new Error("cannot apply not applicable or non-registered alert"),e.toLiteAlert())))),k.chain(k.fromPredicate((e=>b.tI.withTransformJson(e._raw)),(e=>(0,f.tuple)(new Error("Only alerts with transformJSON can be bulk applied"),e.toLiteAlert())))),k.mapLeft((([e,t])=>(this._log.error(e.message,t),e)))))));return(0,o.pipe)(i,A.s.flatMap(he.JI(),(e=>(0,o.pipe)(this._ops._applyTransformJson({alerts:e.map((e=>({alert:e,alternative:fe.Fc.getApplicableAlternative(e,0)}))),source:fe.Kz.api,method:fe.Fc.State.Applied.Method.Bulk,feedbackSubtype:t}),oe.AU((t=>()=>(this._log.error("applyBulk error",t),A.s.of([],e.map((e=>e.id))))),(()=>()=>A.s.of(e.map((e=>e.id))))))())))}confirmApplied(e){return this._log.trace("commitApplied",e),(0,o.pipe)(e,A.s.fromArray((0,f.flow)(this._findAlert,k.map(fe.Un.castApplied))),k.mapLeft((e=>new Error(`Error on trying to confirm applied alerts: ${e.rejected.join(",")}`))),k.chain((e=>this._ops._confirmApplied(e)())))}dismissBatch(e,t){return this._log.trace("dismissBatch",e),(0,o.pipe)(e.map((0,f.flow)(this._findAlert,k.map((e=>[e])))),(0,Ue.fold)(Ge),k.chain((e=>this._ops._dismissBatch(e,t)())))}applyFeedback(e,t,i){return this._log.trace("sendFeedback",{alertId:e,type:t.kind}),(0,o.pipe)(this._findAlert(e),k.chain((e=>this._ops._alertFeedback(e,t,i)())))}sendBatchFeedback(e,t,i){return this._log.trace("sendBatchFeedback",{alertIds:e,type:t}),(0,o.pipe)(e,A.s.fromArray(this._findAlert),A.s.tapFailure((e=>this._log.error("Cannot send batch feedback for alerts",e.rejected))),A.s.foldSuccess((e=>k.right(this._ops._alertBatchFeedback(e,t,i)()))))}takeReference(e,t){return this._log.trace("takeReference",{alertId:e.id,from:t}),(0,o.pipe)(this._findAlert(e.id),k.chain((e=>e.takeReference(t))))}changeMuteState(e,t){return this._log.trace("changeMuteState",e),(0,o.pipe)(e,A.s.fromArray((e=>this._findAlert(e.id))),A.s.flatMap(he.JI(),(e=>(0,o.pipe)(this._ops._changeMuteState(e,t)(),k.mapLeft((e=>(this._log.error("Can not change mute state",e),e))),qe.$v))))}changeGapValue(e,t){return(0,o.pipe)(this._findAlert(e),k.chain((e=>this._ops._changeGapValue(e,t)())))}changeTakeawayFeedback(e,t){return(0,o.pipe)(this._findAlert(e),k.chain((e=>this._ops._changeTakeawayFeedback(e,t)())))}shortenItSummaryNotFound(e){return(0,o.pipe)(this._findAlert(e),k.chain((e=>this._ops._shortenItSummaryNotFound(e)())))}sendShortenItSummaryRequest(e){return(0,o.pipe)(this._findAlert(e),k.chain((e=>this._ops._commitShortenItSummaryRequest(e)())))}dismissShortenItTransformGroup(e,t){return(0,o.pipe)(this._findAlert(e),k.chain((e=>this._ops._dismissShortenItTransformGroup(e,t)())))}changeToneAIToneAlternative(e,t){return(0,o.pipe)(this._findAlert(e),k.chain((e=>this._ops._changeToneAIToneAlternative(e,t)())))}constructor(e,t){(0,r._)(this,"_alertsReader",void 0),(0,r._)(this,"_ops",void 0),(0,r._)(this,"_log",void 0),(0,r._)(this,"_findAlert",void 0),(0,r._)(this,"undoBulk",void 0),(0,r._)(this,"getHighlightRanges",void 0),(0,r._)(this,"hasNewRangesForUpdate",void 0),(0,r._)(this,"applyPendingRangesUpdate",void 0),(0,r._)(this,"getAppliedRanges",void 0),this._alertsReader=e,this._ops=t,this._log=l.Bx.Logging.getLogger("AlertsServiceImpl"),this._findAlert=e=>(0,o.pipe)(e,this._alertsReader.getById,k.fromOption((()=>new Error(`alert ${e} not found in the repo`)))),this.undoBulk=(0,f.flow)(ge.x1((0,f.flow)(this._alertsReader.getById,c.filter(fe.Fc.isBulkApplied))),(e=>this._ops.undoApplied(e,fe.Fc.State.Applied.Method.Bulk)()),k.getOrElse((e=>{throw this._log.error("Could not undo bulk-applied alerts",e),e}))),this.getHighlightRanges=(0,f.flow)(this._findAlert,k.map((e=>e.getHighlightRanges()))),this.hasNewRangesForUpdate=(0,f.flow)(this._findAlert,k.map((e=>e.hasNewRangesForUpdate))),this.applyPendingRangesUpdate=(0,f.flow)(this._findAlert,k.map((e=>e.applyPendingRangesUpdate()))),this.getAppliedRanges=(0,f.flow)(this._alertsReader.getById,k.fromOption((()=>new Error("alert not found in the repo"))),k.filterOrElse(fe.Fc.isApplicableAlert,(e=>new Error(`alert is not applicable: ${e.alertType}`))),k.map((e=>e.getAppliedRanges())))}}const Le=he.JI(),Ge=(0,k.getApplyMonoid)(Le);function We(e,t,i,r,o){const a=new s.hI,c=new n.jQ,d=new u,l=new Pe(a,c,e,r,i,o,t,void 0,d),h=De.create(l.state);return{positionManager:a,altManager:c,alertManager:l,alertsRepository:d,alertsReader:h,alertsService:new Be(h,l._ops)}}},99854:(e,t,i)=>{i.d(t,{F:()=>v});var n=i(23988),s=i(63336),r=i(49004),o=i(88105),a=i(54463),c=i(58889),d=i(44297),l=i(29052),h=i(86562),u=i(69063),_=i(78339),p=i(82718),g=i(24946),m=i(62822),f=i(89769);class v{pushChanges(e){return()=>r.lY.isReset(e)&&!this._capiConnection.wasStarted?(this._log.debug("Got new Reset, triggering connection"),this._initialDelta=e,this._capiConnection.connect(this._connectFromResetSource,!1).then((([e,t])=>c.right(void 0!==t?d.some(t):d.none))).catch((e=>(this._log.warn("failed to connect to CAPI",e),c.left(e))))):this._capiConnection.wasStarted?this._isReady?this._capi.pushChanges(e)():(this._log.debug("Skipped sending change to CAPI as it is not ready yet"),this._initialDelta&&r.lY.isDelta(e)&&(this._log.debug("Got change while establishing new CAPI connection, appending to initial Delta"),(0,s.pipe)(this._initialDelta.compose(e),c.fold((()=>{this._log.error("Got invalid change while establishing new CAPI connection, skiping")}),(e=>{this._initialDelta=e})))),this._capiConnection.isIdle?(this._log.debug("received new change while CAPI is idle, connecting"),this._capiConnection.connect(this._connectFromIdleSource,!1).catch((e=>this._log.warn("failed to connect to CAPI",e))).then((()=>c.right(d.none)))):(this._log.debug("capi is not idle, skip capi reconnect"),Promise.resolve(c.right(d.none)))):(this._log.debug("Skipped sending change to CAPI as it is not started yet, triggering new connection"),this._capiConnection.connect(this._connectFromIdleSource,!1).catch((e=>this._log.warn("failed to connect to CAPI",e))).then((()=>c.right(d.none))))}registerExternalMessageHandler(e){this._capi.registerExternalMessageHandler(e)}get checkingState(){return this._capi.checkingState}get asyncChecksState(){return this._capi.asyncChecksState}_checkConnected(){this._capiConnection.isIdle?(this._log.debug("received new command while CAPI connection is idle, connecting"),this._capiConnection.connect(this._connectFromIdleSource,!1).catch((e=>this._log.warn("failed to connect to CAPI",e)))):this._log.trace("already connected or cannot connect, skipping")}dispose(){this._subs.forEach((e=>e.unsubscribe()))}constructor(e,t,i,r){(0,n._)(this,"_events",void 0),(0,n._)(this,"_capi",void 0),(0,n._)(this,"_ded",void 0),(0,n._)(this,"_capiConnection",void 0),(0,n._)(this,"_log",void 0),(0,n._)(this,"_subs",void 0),(0,n._)(this,"_initialDelta",void 0),(0,n._)(this,"_isReady",void 0),(0,n._)(this,"_connectFromIdleSource",void 0),(0,n._)(this,"_connectFromResetSource",void 0),(0,n._)(this,"setSessionOption",void 0),(0,n._)(this,"sendFeedback",void 0),(0,n._)(this,"requestDocStats",void 0),(0,n._)(this,"requestSynonyms",void 0),(0,n._)(this,"requestSnippets",void 0),(0,n._)(this,"requestWritingExpert",void 0),(0,n._)(this,"shortenItSubmit",void 0),(0,n._)(this,"enablePlagiarismSearch",void 0),(0,n._)(this,"disablePlagiarismSearch",void 0),(0,n._)(this,"enableWritingExpert",void 0),(0,n._)(this,"disableWritingExpert",void 0),(0,n._)(this,"realtimeProofitSubmit",void 0),(0,n._)(this,"realtimeProofitCancel",void 0),(0,n._)(this,"submitRecipients",void 0),(0,n._)(this,"submitScoreSurveyResult",void 0),(0,n._)(this,"submitSurvey",void 0),(0,n._)(this,"sendUserAction",void 0),(0,n._)(this,"sendDebugReport",void 0),(0,n._)(this,"ping",void 0),(0,n._)(this,"getText",void 0),(0,n._)(this,"close",void 0),(0,n._)(this,"isClosed",void 0),(0,n._)(this,"resetReconnectInfo",void 0),(0,n._)(this,"updateContextInfo",void 0),(0,n._)(this,"setContext",void 0),(0,n._)(this,"published",void 0),(0,n._)(this,"enqueueExternalCommand",void 0),this._events=e,this._capi=t,this._ded=i,this._capiConnection=r,this._log=u.Bx.Logging.getLogger("CapiSyncManager"),this._subs=[],this._isReady=!1,this._connectFromIdleSource=()=>{this._ded.flushChanges();const e=this._ded.getContents();return this._log.debug("sending ded current delta",o.E.anonymizeTextAndStringAttrs(e.delta)),e},this._connectFromResetSource=()=>{const e=this._initialDelta?this._initialDelta:this._ded.getContents();return this._initialDelta=void 0,e},this.setSessionOption=e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.setSessionOption(e)))),this.sendFeedback=e=>(0,s.pipe)(this._capi.sendFeedback(e),l.AU((e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.AU(h.xb,(()=>l.kb(e))))),(()=>l.pG(void 0)))),this.requestDocStats=(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.requestDocStats))),this.requestSynonyms=(e,t)=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.requestSynonyms(e,t)))),this.requestSnippets=e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.requestSnippets(e)))),this.requestWritingExpert=()=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.requestWritingExpert()))),this.shortenItSubmit=e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.shortenItSubmit(e)))),this.enablePlagiarismSearch=(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.enablePlagiarismSearch))),this.disablePlagiarismSearch=(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.disablePlagiarismSearch))),this.enableWritingExpert=(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.enableWritingExpert))),this.disableWritingExpert=(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.disableWritingExpert))),this.realtimeProofitSubmit=e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.realtimeProofitSubmit(e)))),this.realtimeProofitCancel=(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.realtimeProofitCancel))),this.submitRecipients=e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.submitRecipients(e)))),this.submitScoreSurveyResult=(e,t)=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.submitScoreSurveyResult(e,t)))),this.submitSurvey=e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.submitSurvey(e)))),this.sendUserAction=(e,t)=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.sendUserAction(e,t)))),this.sendDebugReport=(e,t)=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.sendDebugReport(e,t)))),this.ping=(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.ping))),this.getText=()=>this._capi.getText(),this.close=e=>this._capi.close(e),this.isClosed=()=>this._capi.isClosed(),this.resetReconnectInfo=()=>this._capi.resetReconnectInfo(),this.updateContextInfo=e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.updateContextInfo(e)))),this.setContext=e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.setContext(e)))),this.published=()=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.published()))),this.enqueueExternalCommand=e=>(0,s.pipe)(l.BK((()=>this._checkConnected())),l.cy((()=>this._capi.enqueueExternalCommand(e)))),this._subs.push(this._events.pipe(_.p(a.o.is("ready")),p.K(this._events.pipe(_.p(a.o.is("disconnect")),g.s(1),m.u(!1),f.Z(!0))),f.Z(!1)).subscribe((e=>{this._isReady=e})))}}},85199:(e,t,i)=>{function n(e){const t=t=>{e.next(t)};return{onSessionStarted:t,onWaitForOT:t,onReady:t,onSessionInbound:t,beforeAlert:t,onAlert:t,onRemove:t,onChange:t,onSynonyms:t,onPlagiarism:t,onTextInfo:t,onEmotions:t,onBeforeAsyncCheckFinish:t,onAsyncCheckFinish:t,onAsyncCheckProgress:t,onError:t,onBeforeFinish:t,onFinish:t,onConnect:t,onDisconnect:t,onQueueMsgDropped:t,onAck:t,onPong:t,onMessageReceived:t,onMessageSent:t,onAutoComplete:t,onAttentionHeatmap:t,onAttentionInfo:t,onProofitAvailability:t,onProofitCancelled:t,onProofitCompleted:t,onProofitProgress:t,onProofitProgressProblem:t,onProofitSubmit:t,onShortenItFinished:t,onSDUI:t,onGbRuleCreated:t,onReconnectInfo:t,onShowSurvey:t}}i.d(t,{U:()=>n})},9637:(e,t,i)=>{i.d(t,{u:()=>a});var n=i(23988),s=i(54463),r=i(36840),o=i(80837);class a{dispose(){this._subs.dispose()}constructor(e,t=new Set){(0,n._)(this,"_events",void 0),(0,n._)(this,"_debugTools",void 0),(0,n._)(this,"_subs",void 0),(0,n._)(this,"_allMessages",void 0),this._events=e,this._debugTools=t,this._subs=new o.y.Keeper,this._allMessages=[],this._debugTools.has("captureCapiMessages")&&(this._subs.push(this._events.subscribe((e=>{s.o.is("message_sent")(e)&&this._allMessages.push({direction:"SENT",data:e.message}),s.o.is("message_received")(e)&&this._allMessages.push({direction:"RECEIVED",data:e.message})}))),(0,r.hJ)("popAllMessages",(()=>JSON.stringify(this._allMessages.splice(0,this._allMessages.length)))))}}},64014:(e,t,i)=>{i.d(t,{$:()=>U});var n=i(23988),s=i(10334),r=i(17171),o=i(30040),a=i(63336),c=i(66799),d=i(54463),l=i(91242),h=i(29052),u=i(44297),_=i(58889),p=i(58193),g=i(77396),m=i(69063),f=i(42543),v=i(78339),b=i(15491),S=i(6987),y=i(36094),C=i(21216),k=i(14342),I=i(68594),A=i(82718),w=i(19711),R=i(62822),E=i(89769),T=i(21662),x=i(11298),F=i(68101),N=i(62723),M=i(83541),D=i(60269),O=i(52869),P=i(46669);class U{get checkingState(){return this._capi.checkingState}get asyncChecksState(){return this._capi.asyncChecksState}dispose(){this._subs.forEach((e=>e.unsubscribe()))}_updateAsyncChecksState(){this._sessionChecksState.asyncChecksState.set(this._capi.asyncChecksState)}constructor(e,t,i,U,q,B=0){(0,n._)(this,"_capi",void 0),(0,n._)(this,"events",void 0),(0,n._)(this,"_sessionChecksState",void 0),(0,n._)(this,"_log",void 0),(0,n._)(this,"_subs",void 0),(0,n._)(this,"_checkingStateInt",void 0),(0,n._)(this,"pushChanges",void 0),(0,n._)(this,"setSessionOption",void 0),(0,n._)(this,"resetReconnectInfo",void 0),(0,n._)(this,"sendFeedback",void 0),(0,n._)(this,"requestDocStats",void 0),(0,n._)(this,"requestSynonyms",void 0),(0,n._)(this,"requestSnippets",void 0),(0,n._)(this,"requestWritingExpert",void 0),(0,n._)(this,"shortenItSubmit",void 0),(0,n._)(this,"enablePlagiarismSearch",void 0),(0,n._)(this,"disablePlagiarismSearch",void 0),(0,n._)(this,"enableWritingExpert",void 0),(0,n._)(this,"disableWritingExpert",void 0),(0,n._)(this,"realtimeProofitSubmit",void 0),(0,n._)(this,"realtimeProofitCancel",void 0),(0,n._)(this,"submitRecipients",void 0),(0,n._)(this,"submitScoreSurveyResult",void 0),(0,n._)(this,"submitSurvey",void 0),(0,n._)(this,"sendUserAction",void 0),(0,n._)(this,"sendDebugReport",void 0),(0,n._)(this,"ping",void 0),(0,n._)(this,"getText",void 0),(0,n._)(this,"close",void 0),(0,n._)(this,"isClosed",void 0),(0,n._)(this,"updateContextInfo",void 0),(0,n._)(this,"setContext",void 0),(0,n._)(this,"published",void 0),(0,n._)(this,"enqueueExternalCommand",void 0),(0,n._)(this,"registerExternalMessageHandler",void 0),this._capi=e,this.events=t,this._sessionChecksState=i,this._log=m.Bx.Logging.getLogger("CheckingStateCAPIClient"),this._subs=[],this._checkingStateInt=new f.B7,this.pushChanges=e=>(0,a.pipe)(this._capi.pushChanges(e),h.Tj((e=>(this._checkingStateInt.next(this._capi.checkingState),this._updateAsyncChecksState(),e)))),this.setSessionOption=e=>(0,a.pipe)(h.oF((()=>(e.kind===c.XM.Context&&(this._sessionChecksState.score.set(u.none),this._sessionChecksState.scoreStatus.set(u.none),this._checkingStateInt.next(this._capi.checkingState)),_.right(null)))),h.cy((()=>this._capi.setSessionOption(e)))),this.resetReconnectInfo=()=>this._capi.resetReconnectInfo(),this.sendFeedback=e=>this._capi.sendFeedback(e),this.requestDocStats=()=>this._capi.requestDocStats(),this.requestSynonyms=(e,t)=>this._capi.requestSynonyms(e,t),this.requestSnippets=e=>this._capi.requestSnippets(e),this.requestWritingExpert=()=>this._capi.requestWritingExpert(),this.shortenItSubmit=e=>this._capi.shortenItSubmit(e),this.enablePlagiarismSearch=()=>this._capi.enablePlagiarismSearch(),this.disablePlagiarismSearch=()=>this._capi.disablePlagiarismSearch(),this.enableWritingExpert=()=>this._capi.enableWritingExpert(),this.disableWritingExpert=()=>this._capi.disableWritingExpert(),this.realtimeProofitSubmit=e=>this._capi.realtimeProofitSubmit(e),this.realtimeProofitCancel=()=>this._capi.realtimeProofitCancel(),this.submitRecipients=e=>this._capi.submitRecipients(e),this.submitScoreSurveyResult=(e,t)=>this._capi.submitScoreSurveyResult(e,t),this.submitSurvey=e=>this._capi.submitSurvey(e),this.sendUserAction=(e,t)=>this._capi.sendUserAction(e,t),this.sendDebugReport=(e,t)=>this._capi.sendDebugReport(e,t),this.ping=()=>this._capi.ping(),this.getText=()=>this._capi.getText(),this.close=e=>this._capi.close(e),this.isClosed=()=>this._capi.isClosed(),this.updateContextInfo=e=>this._capi.updateContextInfo(e),this.setContext=e=>this._capi.setContext(e),this.published=()=>this._capi.published(),this.enqueueExternalCommand=e=>this._capi.enqueueExternalCommand(e),this.registerExternalMessageHandler=e=>this._capi.registerExternalMessageHandler(e),this._log.debug("Constructing client with _hasAlertsCache = "+U);const L=d.o.is("session_started"),G=d.o.is("session_started","queue_msgs_dropped");this._subs.push(this.events.subscribe((e=>{"finish"===e.kind&&this._checkingStateInt.next(this._capi.checkingState)})),this.events.pipe(v.p(G),b.T(L),S.n(y.$x(C.of(void 0).pipe(k.c(1e3)))),b.T((()=>this._capi.checkingState))).subscribe(this._checkingStateInt));const W=t.pipe(v.p(L),I.i(1),A.K(t.pipe(v.p(d.o.is("finish")),w.$(),R.u(!1),E.Z(!0))),E.Z(!1)),K=this._checkingStateInt.pipe(T.E(W,((e,t)=>t&&"full"===e?"checking":e)),x.u()),H=K.pipe(F.v((e=>"full"!==e))),z=K.pipe(v.p((e=>"full"===e)),S.n((()=>H.pipe(N.z(M.timer(B),(e=>e)),E.Z("full")))));this._subs.push(t.subscribe((e=>{"text_info"===e.kind?i.textInfo.set(u.some(e.data)):"finish"===e.kind?(i.score.set(e.score),i.scoreStatus.set(e.scoreStatus)):"feedback_ack"===e.kind?((0,a.pipe)(e,u.fromPredicate(d.o.isUserFeedbackWithGeneralScore),u.map((e=>e.outcomeScores.GeneralScore)),u.map((e=>Math.trunc(100*e))),p.Mi((e=>i.score.modify((0,o.flow)(u.map((t=>(0,r._)((0,s._)({},t),{rank:e}))),p.NW(u.some({errorRateScore:0,rank:e}))))))),(0,a.pipe)(e,u.fromPredicate(d.o.isUserFeedbackWithScoreStatus),u.map((e=>e.scoreStatus)),p.Mi((e=>i.scoreStatus.set(u.some(e)))))):"async_check_finished"===e.kind&&this._updateAsyncChecksState()}))),this._subs.push(D.h(H,z).pipe(O.j((e=>U&&"idle"!==e)),E.Z(q>1?U?"checking":"full":"idle"),P.F()).subscribe((e=>{this._log.debug("Switching checking state to "+e),i.checkingState.set(e),"full"===e&&g.hq(this.sendFeedback({kind:c.hN.RECHECK_SHOWN})).catch((e=>{l.Xb.isNotConnectedError(e)?this._log.error("tried to send RECHECK_SHOWN event to Capi when not connected and failed to wait for new connection",e):this._log.error("Failed to send RECHECK_SHOWN event on Capi",e)}))})))}}},77338:(e,t,i)=>{i.d(t,{_:()=>v});var n=i(23988),s=i(63336),r=i(21296),o=i(91242),a=i(66799),c=i(36840),d=i(44297),l=i(77396),h=i(29052),u=i(78339),_=i(24946),p=i(15491),g=i(36094);const m=1e4,f=200;class v{get checkingState(){return this._capi.checkingState}get asyncChecksState(){return this._capi.asyncChecksState}_untilWaitingForOT(e){return this._untilEvent(e,"wait_for_ot")}_untilFinished(e){return this._untilEvent(e,"finish")}_untilEvent(e,t){return o.Xb.isNotConnectedError(e)?(0,s.pipe)(this._events,u.p((e=>e.kind===t)),_.s(1),p.T(c.Yi),g.FM,d.some):d.none}constructor(e,t){(0,n._)(this,"_events",void 0),(0,n._)(this,"_capi",void 0),(0,n._)(this,"retryCommandWhen",void 0),(0,n._)(this,"pushChanges",void 0),(0,n._)(this,"setSessionOption",void 0),(0,n._)(this,"resetReconnectInfo",void 0),(0,n._)(this,"sendFeedback",void 0),(0,n._)(this,"requestSynonyms",void 0),(0,n._)(this,"requestSnippets",void 0),(0,n._)(this,"requestWritingExpert",void 0),(0,n._)(this,"shortenItSubmit",void 0),(0,n._)(this,"requestDocStats",void 0),(0,n._)(this,"enablePlagiarismSearch",void 0),(0,n._)(this,"disablePlagiarismSearch",void 0),(0,n._)(this,"enableWritingExpert",void 0),(0,n._)(this,"disableWritingExpert",void 0),(0,n._)(this,"realtimeProofitSubmit",void 0),(0,n._)(this,"realtimeProofitCancel",void 0),(0,n._)(this,"submitRecipients",void 0),(0,n._)(this,"submitScoreSurveyResult",void 0),(0,n._)(this,"submitSurvey",void 0),(0,n._)(this,"sendUserAction",void 0),(0,n._)(this,"sendDebugReport",void 0),(0,n._)(this,"ping",void 0),(0,n._)(this,"getText",void 0),(0,n._)(this,"close",void 0),(0,n._)(this,"isClosed",void 0),(0,n._)(this,"updateContextInfo",void 0),(0,n._)(this,"setContext",void 0),(0,n._)(this,"published",void 0),(0,n._)(this,"enqueueExternalCommand",void 0),(0,n._)(this,"registerExternalMessageHandler",void 0),this._events=e,this._capi=t,this.retryCommandWhen=(0,c.Ub)(o.zN.isDroppedError,o.MU.isTimeoutError),this.pushChanges=e=>this._capi.pushChanges(e),this.setSessionOption=e=>this._capi.setSessionOption(e),this.resetReconnectInfo=()=>this._capi.resetReconnectInfo(),this.sendFeedback=e=>{switch(e.kind){case a.DG.MUTE:case a.DG.UNMUTE:return(0,s.pipe)(l.NQ(this._capi.sendFeedback(e),(e=>this._untilWaitingForOT(e)),m),(0,o.L5)([r.limitRetries(2),r.exponentialBackoff(f)],this.retryCommandWhen));case a.hN.RECHECK_SHOWN:return(0,s.pipe)(this._capi.sendFeedback(e),h.NW((()=>h.pG((0,c.Yi)()))));default:return this._capi.sendFeedback(e)}},this.requestSynonyms=(e,t)=>(0,s.pipe)(l.NQ(this._capi.requestSynonyms(e,t),(e=>this._untilFinished(e)),m),(0,o.L5)([r.limitRetries(2),r.exponentialBackoff(f)],this.retryCommandWhen)),this.requestSnippets=e=>(0,s.pipe)(l.NQ(this._capi.requestSnippets(e),(e=>this._untilFinished(e)),m),(0,o.L5)([r.limitRetries(2),r.exponentialBackoff(f)],this.retryCommandWhen)),this.requestWritingExpert=()=>(0,s.pipe)(l.NQ(this._capi.requestWritingExpert(),(e=>this._untilFinished(e)),m),(0,o.L5)([r.limitRetries(2),r.exponentialBackoff(f)],this.retryCommandWhen)),this.shortenItSubmit=e=>(0,s.pipe)(l.NQ(this._capi.shortenItSubmit(e),(e=>this._untilFinished(e)),m),(0,o.L5)([r.limitRetries(2),r.exponentialBackoff(f)],this.retryCommandWhen)),this.requestDocStats=(0,s.pipe)(l.NQ(this._capi.requestDocStats,(e=>this._untilFinished(e)),m),(0,o.L5)([r.limitRetries(2),r.exponentialBackoff(f)],this.retryCommandWhen)),this.enablePlagiarismSearch=(0,s.pipe)(l.NQ(this._capi.enablePlagiarismSearch,(e=>this._untilFinished(e)),m),(0,o.L5)([r.limitRetries(2),r.exponentialBackoff(f)],this.retryCommandWhen)),this.disablePlagiarismSearch=()=>this._capi.disablePlagiarismSearch(),this.enableWritingExpert=(0,s.pipe)(l.NQ(this._capi.enableWritingExpert,(e=>this._untilFinished(e)),m),(0,o.L5)([r.limitRetries(2),r.exponentialBackoff(f)],this.retryCommandWhen)),this.disableWritingExpert=()=>this._capi.disableWritingExpert(),this.realtimeProofitSubmit=e=>this._capi.realtimeProofitSubmit(e),this.realtimeProofitCancel=()=>this._capi.realtimeProofitCancel(),this.submitRecipients=e=>(0,s.pipe)(l.NQ(this._capi.submitRecipients(e),(e=>this._untilFinished(e)),m),(0,o.L5)([r.limitRetries(2),r.exponentialBackoff(f)],this.retryCommandWhen)),this.submitScoreSurveyResult=(e,t)=>this._capi.submitScoreSurveyResult(e,t),this.submitSurvey=e=>this._capi.submitSurvey(e),this.sendUserAction=(e,t)=>this._capi.sendUserAction(e,t),this.sendDebugReport=(e,t)=>this._capi.sendDebugReport(e,t),this.ping=()=>this._capi.ping(),this.getText=()=>this._capi.getText(),this.close=e=>this._capi.close(e),this.isClosed=()=>this._capi.isClosed(),this.updateContextInfo=e=>this._capi.updateContextInfo(e),this.setContext=e=>this._capi.setContext(e),this.published=()=>this._capi.published(),this.enqueueExternalCommand=e=>this._capi.enqueueExternalCommand(e),this.registerExternalMessageHandler=e=>this._capi.registerExternalMessageHandler(e)}}},11555:(e,t,i)=>{i.d(t,{d:()=>r});var n=i(77396),s=i(42543);class r{static init(e,t,i,n,o,a){const c=new s.B7;return new r(e,t,i,n,o,a,c),c}constructor(e,t,i,n,s,o,a){const c=r.NamedChangesSink.factory(a),d={pm:c(r.Receiver.PM,n),dm:c(r.Receiver.PM,s),capi:c(r.Receiver.CAPI,i),userTextEcho:c(r.Receiver.UserText,e)};r.Producer.create(r.Producer.UserText,{changes:e.changes})(d.dm,d.pm,d.capi),r.Producer.create(r.Producer.ALERT_APPLY,o)(d.userTextEcho),t.subscribe((t=>{"before_alert"===t.kind&&e.flushChanges()}))}}!function(e){let t,i,s,r;!function(e){e.DEd="denali_editor",e.UserText="user_text",e.DOX="remote_document",e.ALERT_APPLY="alert_synonyms_manager"}(t=e.Producer||(e.Producer={})),function(e){e.create=function(e,t){return(...i)=>t.changes.subscribe((t=>{i.forEach((i=>i.pushChanges(e,t)))}))}}(t=e.Producer||(e.Producer={})),function(e){e.DEd="denali_editor",e.UserText="user_text",e.DOX="remote_document",e.CAPI="checking_service",e.PM="position_manager"}(i=e.Receiver||(e.Receiver={})),function(e){function t(e,t,i){return{pushChanges:(s,r)=>{try{let o=t.pushChanges(r);"function"==typeof o&&(o=n.hq(o)),void 0!==o&&o.catch((t=>i.next({exception:t,details:{from:s,to:e}})))}catch(t){i.next({exception:t,details:{from:s,to:e}})}}}}e.factory=function(e){return(i,n)=>t(i,n,e)},e.create=t}(s=e.NamedChangesSink||(e.NamedChangesSink={})),function(e){e.create=e=>({changes:e.changes,pushChanges(t){e.pushChanges(t,"user")},getContents:()=>e.getContents(),flushChanges:()=>e.flushChanges()})}(r=e.UserTextChangesSync||(e.UserTextChangesSync={}))}(r||(r={}))},21138:(e,t,i)=>{i.d(t,{p:()=>s,v:()=>n});var n,s,r=i(30040),o=i(49004),a=i(88105),c=i(36840),d=i(29052),l=i(60269);!function(e){e.noopSync={pushChanges:c.Yi},e.ignoreResult=function(e){return{pushChanges:t=>{e.pushChanges(t)}}},e.ignoreTEResult=function(e){return{pushChanges:(0,r.flow)(e.pushChanges,d.Tj(c.Yi))}},e.pushDeleteThenInsert=function(e){return{pushChanges:t=>{(o.lY.isDelta(t)?o.lY.fromArrayOfDeltas(a.E.splitToDeleteThenInsert(t.delta).filter(a.E.nonEmpty),t.prevLen):[t]).forEach((t=>e.pushChanges(t)))}}}}(n||(n={})),function(e){e.merge=function(e){return{changes:l.h(...e.map((e=>e.changes)))}}}(s||(s={}))},61606:(e,t,i)=>{i.d(t,{g:()=>s});var n=i(66799);const s={disabledFeedbacks:Object.keys(n.yp).map((e=>n.yp[e])).filter((e=>e!==n.yp.CLOSED))}},49470:(e,t,i)=>{i.d(t,{kr:()=>E,uF:()=>R});var n,s=i(10334),r=i(50659),o=i(87574),a=i(19840),c=i(86562),d=(i(80300),i(86922)),l=i(19967),h=i(76099),u=i(27917),_=i(19772),p=i(46669),g=i(21662),m=i(95168),f=i(62723),v=i(89769),b=i(92141),S=i(79334),y=i(97291),C=i(70751),k=i(36840),I=i(24290),A=i(21216),w=i(15491);!function(e){var t=e.OutcomeContext=r.createContext({navigateToAllAlerts:k.Yi});e.BackToAllAlertsButton=({density:e=A.of("cozy")})=>{const{backToAllAlerts:i}=r.useContext(d.S.Context).sidebar;return r.createElement(t.Consumer,null,(({navigateToAllAlerts:t})=>r.createElement(l.$n.Flat,{name:"to-all-alerts",tag:I.f.div,className:C.j.toAllAlertsButton,onClick:t,"aria-label":e.pipe(w.T((e=>"compact"===e?i:void 0)))},e.pipe(w.T((e=>"cozy"===e&&r.createElement("span",{className:C.j.toAllAlertsText},i)))),r.createElement(u.In.Close,{width:13}))))}}(n||(n={}));const R=n.OutcomeContext;var E;!function(e){e.SeeAlerts=({cardsViewportState:e,actionEvents:t,cardsAmount:i})=>{const n=r.useContext(d.S.Context).sidebar;return _.R.useSubscriptionTo(e.pipe(p.F(),g.E(i),m.M((([e,i])=>{switch(e){case S.X$.above:case S.X$.below:t.next({type:b.X9.Type.moreAlertsButtonShow,position:e,cardsAmount:i});break;case S.X$.hidden:break;default:(0,c.xb)(e)}})))),r.createElement(o.F.Fragment,null,e.pipe(p.F(),f.z(i,((e,i)=>{switch(e){case S.X$.above:return r.createElement("div",{className:C.j.seeAlertsContainer},r.createElement(l.$n.Primary,{name:"top-see-alerts",className:C.j.topSeeAlerts,onClick:()=>t.next({type:b.X9.Type.switchToClosestByViewport,position:e,cardsAmount:i})},n.seeAlerts(i),r.createElement(u.In.Arrow,{width:"12",direction:u.bO.up})),r.createElement("div",{className:C.j.topStack}));case S.X$.below:return r.createElement("div",{className:C.j.seeAlertsContainer},r.createElement(l.$n.Primary,{name:"bottom-see-alerts",className:C.j.bottomSeeAlerts,onClick:()=>t.next({type:b.X9.Type.switchToClosestByViewport,position:e,cardsAmount:i})},n.seeAlerts(i),r.createElement(u.In.Arrow,{width:"12",direction:u.bO.down})),r.createElement("div",{className:C.j.bottomStack}));case S.X$.hidden:return null;default:return(0,c.xb)(e)}})),v.Z(null)))},e.Rechecking=({className:e})=>r.createElement(o.F.div,(0,s._)({key:"lensview-loader"},(0,a.Ly)(e,C.j.rechecking)),r.createElement(y.$6,null)),e.FixedContent=({onTransitionEnd:e,label:t,children:i})=>r.createElement(h.D.Top,{onTransitionEnd:e,className:C.j.fixedLensContent,"aria-label":t,role:"region"},i)}(E||(E={}))},70751:(e,t,i)=>{i.d(t,{j:()=>U});var n=i(13607),s=i(27199),r=i(11864),o=i(43292);const a=4.15,c=n.o1-.5,d="0 3px 7px 0 rgba(129, 137, 169, .2)",l="0 -3px 7px 0 rgba(129, 137, 169, .2)",h={marginTop:0,height:r.Ks.percent(100)},u={position:"absolute",overflow:"hidden",marginTop:0,marginLeft:r.Ks.rem(-1*c),paddingTop:r.Ks.rem(4),paddingRight:r.Ks.rem(2),paddingLeft:r.Ks.rem(c),width:`calc(100% + ${r.Ks.rem(c)})`,height:r.Ks.percent(100)},_={position:"absolute",top:r.Ks.rem(n.xl),visibility:"hidden",height:`calc(100vh - ${r.Ks.rem(n.xl)})`},p={paddingRight:r.Ks.rem(2),width:r.Ks.percent(100),height:r.Ks.percent(100)},g={zIndex:n.k2,width:r.Ks.rem(n.NE),$nest:{[`@media (${n.P9})`]:{width:r.Ks.rem(n.rQ)},[`@media (${n.oB})`]:{width:r.Ks.rem(n.gx)},[`@media (${n.ri})`]:{width:r.Ks.rem(n.Bi)}}},m={width:r.Ks.rem(27)},f={margin:`0 ${r.Ks.rem(.25)} 0 auto`,lineHeight:r.Ks.rem(1.8)},v={marginRight:r.Ks.rem(1)},b={position:"relative",paddingTop:r.Ks.rem(1),height:r.Ks.rem(a),background:`linear-gradient(-180deg, ${s.Q1.CoreNeutral0} 78%, rgba(255, 255, 255, 0) 100%)`,$nest:{"&:before":{position:"absolute",top:0,left:r.Ks.rem(-2),width:r.Ks.rem(2),height:r.Ks.percent(100),background:"inherit",content:"''"}}},S={paddingBottom:r.Ks.rem(.2)},y={maxWidth:r.Ks.rem(11),textAlign:"center",whiteSpace:"normal",lineHeight:r.Ks.rem(1)},C={position:"absolute",right:0,left:0,display:"flex",height:r.Ks.rem(2),background:s.Q1.CoreNeutral0,alignItems:"center",justifyContent:"center"},k={top:r.Ks.rem(-1.15),boxShadow:d,$nest:{"&:before":(0,o.k)(r.Ks.rem(.25),-10,r.Ks.rem(-.4),d,r.Ks.rem(n.OC)),"&:after":(0,o.k)(r.Ks.rem(.5),-20,r.Ks.rem(-.8),d,r.Ks.rem(n.OC))}},I={bottom:0,boxShadow:l,$nest:{"&:before":(0,o.k)(r.Ks.rem(.25),-10,r.Ks.rem(.4),l,r.Ks.rem(n.OC)),"&:after":(0,o.k)(r.Ks.rem(.5),-20,r.Ks.rem(.8),l,r.Ks.rem(n.OC))}},A={position:"absolute",zIndex:n.yg,display:"flex",pointerEvents:"all"},w={top:r.Ks.rem(.15)},R={bottom:r.Ks.rem(1.3)},E={position:"absolute",top:r.Ks.rem(a),display:"flex",width:`calc(100% - ${r.Ks.rem(2)})`,height:`calc(100vh - ${r.Ks.rem(a)})`,pointerEvents:"none",justifyContent:"center"},T=r.Ks.rem(2),x={paddingRight:T},F={display:"flex",marginTop:r.Ks.rem(.8125),marginLeft:r.Ks.rem(2.1875),paddingRight:T,color:s.Q1.CoreNeutral90,textTransform:"none",letterSpacing:0,fontWeight:"bold",fontSize:r.Ks.rem(.875),lineHeight:r.Ks.rem(1.125),justifyContent:"space-between",$nest:{'& div[role="button"]':{marginTop:r.Ks.rem(-.3875),$nest:{"&[data-name='bulk-accept-mini-button']":{marginTop:r.Ks.rem(-.75)}}},'& div[data-role="counter"]':{position:r.Ks.important("absolute")},"& h2":{fontSize:r.Ks.rem(.875),margin:0}}},N={position:"absolute",zIndex:n.k2,overflow:"visible",width:r.Ks.percent(100)},M={position:"absolute",right:r.Ks.rem(3),paddingLeft:r.Ks.rem(1),borderRadius:r.Ks.rem(n.H0),color:s.Q1.CoreNeutral90,letterSpacing:r.Ks.px(.25),fontSize:r.Ks.rem(.75),lineHeight:r.Ks.rem(1),$nest:{"@media (max-width: 840px)":{paddingLeft:0,$nest:{"& > span":{display:"none"}}}}},D={position:"relative",marginTop:r.Ks.rem(.05),fontWeight:300},O={marginLeft:r.Ks.rem(2.5)},P={margin:`${r.Ks.rem(.5)} 0`,backgroundColor:s.Q1.CoreNeutral0,userSelect:"none",$nest:{"&:before":{position:"absolute",left:r.Ks.rem(-.5),width:r.Ks.rem(.5),height:r.Ks.percent(100),backgroundColor:s.Q1.CoreNeutral0,content:"''"}}},U=r.Ks.stylesheet({viewport:[h],lensviewContentWrapper:[u],fakeTop:[_],rechecking:[p],fixedLensContent:[g],splitSharedAssistantsLensContent:[g,m],lensCounter:[f],headerBtn:[v],headerWrapper:[b],infoIcon:[S],infoTooltip:[y],stack:[C],topStack:[C,k],bottomStack:[C,I],seeAlerts:[A],topSeeAlerts:[A,w],bottomSeeAlerts:[A,R],seeAlertsContainer:[E],lensTitle:[F],header:[N],toAllAlertsButton:[M],toAllAlertsText:[D],plagiarismLensTitle:[F,O],cardWrapper:[P],flexContainer:[{display:"flex"}],priorityTitleWrapper:[x]})},12070:(e,t,i)=>{i.d(t,{h:()=>E});var n=i(10334),s=i(17171),r=i(50659),o=i(63336),a=i(80074),c=i(87574),d=i(34980),l=i(44297),h=i(41548),u=i(35098),_=i(19772),p=i(60269),g=i(95168),m=i(68533),f=i(62723),v=i(68594),b=i(6987),S=i(54988),y=i(36094),C=i(78339),k=i(65141),I=i(15491),A=i(39946),w=i(82315);const R=e=>{const t=r.useContext(u.L.Context).pipe(I.T((e=>e.rect))),{visibilityOverlay:i,customStyles:R,onboardingStep:E}=function({stepId:e,onboardingViewModel:t,denaliEditorModel:i,getFirstTargetRect:c,overlay:u,completionTrigger:I},A){const w=r.useContext(h.q.Context),R=a.s.create({display:"none",pointerEvents:"none"}),E=a.s.create(!1),T=t.subscribeForStep(e),x=a.s.create(l.none);return _.R.useSubscriptionTo(p.h(T.state.pipe(g.M((e=>{"popup"!==e&&"popover"!==e||!u||E.set(!0),R.modify((t=>(0,s._)((0,n._)({},t),{pointerEvents:"dot"===e?"all":"none"})))})),m.h(i.changes,A),f.z(w,x.pipe(v.i(1))),g.M((([e,t,r])=>((e,t)=>requestAnimationFrame((()=>{i.flushChanges(),(0,o.pipe)(t,l.map(d.W.relativeToRoot),l.fold((()=>{R.set({display:"none"})}),(({top:t,left:i,width:r,height:o})=>{R.modify((a=>(0,s._)((0,n._)({},a),{position:"absolute",left:i/e+"rem",top:t/e+"rem",width:r/e+"rem",height:o/e+"rem",display:"block"})))})))})))(t,r)))),T.state.view((e=>"dot"===e||"popup"===e||"popover"===e)).pipe(b.n((e=>e?c():S.w)),g.M(y.H9(x))),p.h(y.vh(E.pipe(v.i(1),C.p((e=>!e))))(!!u),I).pipe(g.M(t.getStepCompletionCallback(e))),E.pipe(b.n(y.vh(k.R(document,"click",{capture:!0,passive:!0}))),g.M((()=>E.set(!1)))))),{visibilityOverlay:E,customStyles:R,onboardingStep:T}}(e,t);return r.createElement(r.Fragment,null,e.overlay&&e.overlay(i),r.createElement("div",{className:A.c.editor},r.createElement(c.F.div,{style:R,className:A.c.onboardingPopup},r.createElement(w.UX,(0,s._)((0,n._)({},e),{onboardingStep:E,viewportRect:t,eventType:"none"}),r.createElement(c.F.div,{style:R.view((({width:e,height:t})=>({width:e,height:t})))})))))},E=e=>e.onboardingViewModel.isStepEnabled(e.stepId)?r.createElement(R,e):null},86284:(e,t,i)=>{i.d(t,{G:()=>a});var n=i(19147),s=i(23988),r=i(97772),o=function e(t,i){var r=this;(0,n._)(this,e),(0,s._)(this,"_innerWSHandler",void 0),(0,s._)(this,"_dlpDataSanitizer",void 0),(0,s._)(this,"onConnecting",void 0),(0,s._)(this,"onConnect",void 0),(0,s._)(this,"onDisconnect",void 0),(0,s._)(this,"onMessage",void 0),(0,s._)(this,"connect",void 0),(0,s._)(this,"isDisconnected",void 0),this._innerWSHandler=t,this._dlpDataSanitizer=i,this.onConnecting=function(e){return r._innerWSHandler.onConnecting(e),r},this.onConnect=function(e){return r._innerWSHandler.onConnect(e),r},this.onDisconnect=function(e){return r._innerWSHandler.onDisconnect((function(t){return r._dlpDataSanitizer.clear(),e(t)})),r},this.onMessage=function(e){return r._innerWSHandler.onMessage((function(t,i){e(t,r._dlpDataSanitizer.unsanitizeMessage(i))})),r},this.connect=function(e){return r._innerWSHandler.connect(e)},this.isDisconnected=function(){return r._innerWSHandler.isDisconnected()}},a=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r.Wm,i=arguments.length>1?arguments[1]:void 0,a=this;(0,n._)(this,e),(0,s._)(this,"_dlpDataSanitizer",void 0),(0,s._)(this,"sanitizeWS",(function(e,t){return e.writer((function(e){return t(a._dlpDataSanitizer.sanitizeMessage(e))}))})),(0,s._)(this,"sanitizeStaticWS",(function(e,t){return e.writer((function(e){return t(a._dlpDataSanitizer.sanitizeStaticMessage(e))}))})),(0,s._)(this,"sanitizeWSHandler",(function(e){return new o(e,a._dlpDataSanitizer)})),this._dlpDataSanitizer=new r.oQ(t,i)}},62673:(e,t,i)=>{i.d(t,{r:()=>n});var n="4.0.0"},54111:(e,t,i)=>{var n;i.d(t,{Z:()=>n}),function(e){e.Inline="inline",e.Popover="popover",e.Short="short",e.Long="long",e.StandalonePlagiarism="standalone-plagiarism"}(n||(n={}))},59828:(e,t,i)=>{i.d(t,{c:()=>T});var n=i(30040),s=i(66799),r=i(54463),o=i(63967),a=i(88761),c=i(22809),d=i(80837),l=i(65621),h=i(15491),u=i(78339),_=i(36840),p=i(44297),g=i(59042),m=i(10047),f=i(69063),v=i(12486),b=i(92490),S=i(76807),y=i(57980),C=i(83375),k=i(97997);function I(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function A(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function w(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function R(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var n,s,r=[],o=!0,a=!1;try{for(i=i.call(e);!(o=(n=i.next()).done)&&(r.push(n.value),!t||r.length!==t);o=!0);}catch(e){a=!0,s=e}finally{try{o||null==i.return||i.return()}finally{if(a)throw s}}return r}}(e,t)||E(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function E(e,t){if(e){if("string"==typeof e)return I(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?I(e,t):void 0}}var T=function(){function e(t,i,A){var R=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new k.n,T=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),w(this,"_getByRawAlertId",void 0),w(this,"popoverManager",void 0),w(this,"state",void 0),w(this,"_sduiManager",void 0),w(this,"_subs",void 0),w(this,"_log",void 0),w(this,"alertIdResolver",void 0),w(this,"findFirstCardWithContent",void 0),w(this,"onSessionStarted",void 0),w(this,"onFirstCheckingFinished",void 0),w(this,"notifyAlertsChanged",void 0),w(this,"loadItems",void 0),w(this,"_toRemovedAlertIdsByClient",void 0),this._getByRawAlertId=A,this.popoverManager=R,this._subs=new d.y.Keeper,this._log=f.Bx.Logging.getLogger("SDUIManager",v.$.TRACE,v.I.Manager.getColor()),this.findFirstCardWithContent=function(e){return T._sduiManager.findFirstCardWithContent(e)},this.onSessionStarted=function(){return T._sduiManager.onSessionStarted()},this.onFirstCheckingFinished=function(){return T._sduiManager.onFirstCheckingFinished()},this.notifyAlertsChanged=function(){return T._sduiManager.notifyAlertsChanged()},this.loadItems=function(e){return T._sduiManager.loadItems(e)},this._toRemovedAlertIdsByClient=function(e){var t=function(e,t,i){return(0,_.Ub)(o.Fc.isRemovedByTextChange,o.Fc.isDuplicated)(t.alert)?(0,n.pipe)(i,p.fromNullable,p.chain((function(e){return e.alert.rawId})),p.alt((function(){return t.alert.rawId})),p.fold((function(){return e}),(function(i){var n,s,r=o.Fc.isRemovedByTextChange(t.alert)?S.BG.TextChange:S.BG.RemoveDuplicate;return T._log.debug("[Optimistic update] alert ".concat(o.Fc.State.Type.REMOVED," by ").concat(r," ").concat(a.Y.show.show(t))),e.set(r,(s=null!==(n=e.get(r))&&void 0!==n?n:[],function(e){if(Array.isArray(e))return I(e)}(s)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(s)||E(s)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()).concat([y.W.AlertId.from(i)]))}))):e};return e.pipe(l.J(),h.T((0,n.tupled)(c.A.diff)),h.T((function(e){return g.b.reduce(new Map,(function(e,i){return t(e,i)}),(function(e,i,n){return t(e,n,i)}),n.identity)(e)})),u.p((function(e){return(0,n.pipe)(Array.from(e.values()),m.Bq,(0,_.AU)(m.Im))})))};var x=i.pipe(u.p(C.Q.isSduiEvent),h.T(S.nK.fromSource(S.BG.CAPI))),F=(0,n.flow)(s.tI.Id.create,this._getByRawAlertId,p.map((function(e){return y.W.AlertId.from(e.id)})));this._sduiManager=new b.Z(x,F,R),this.alertIdResolver=F,this.state=this._sduiManager.state,this._subs.push(t.subscribe((function(e){return T._sduiManager.notifyAlertsChanged()})),this._toRemovedAlertIdsByClient(t).subscribe((function(e){return e.forEach((function(e,t){return T.pushRemovedAlerts([e,t])}))})),i.pipe(u.p(r.o.is("session_started")),u.p((function(e){return e.isNewSession}))).subscribe((function(e){return T._sduiManager.onSessionStarted()})),i.pipe(u.p(r.o.is("finish")),u.p((function(e){return 0===e.revision}))).subscribe((function(e){return T._sduiManager.onFirstCheckingFinished()})))}var t,i;return t=e,(i=[{key:"onAlertsRefEmpty",get:function(){return this._sduiManager.onAlertsRefEmpty}},{key:"pushRemovedRoot",value:function(e){this._sduiManager.pushRemovedRoot(e)}},{key:"pushRemovedAlerts",value:function(e){var t=R(e,2),i=t[0],n=t[1];this._sduiManager.pushRemovedAlerts([i,n])}},{key:"pushRemovedDenaliAlerts",value:function(e){var t=R(e,2),i=t[0],n=t[1];this._sduiManager.pushRemovedAlerts([i.map(y.W.AlertId.from),n])}},{key:"pushSwitchView",value:function(e){this._sduiManager.pushSwitchView(e)}},{key:"resolveStrongAlertRefAlerts",value:function(e){return this._sduiManager.resolveStrongAlertRefAlerts(e)}},{key:"flush",value:function(){this._sduiManager.flush()}},{key:"dispose",value:function(){this._subs.dispose(),this._sduiManager.dispose()}}])&&A(t.prototype,i),e}()},92026:(e,t,i)=>{i.d(t,{G:()=>d});var n=i(30040),s=i(91242),r=i(77396),o=i(69063);function a(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var d=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),c(this,"_capiSDUIClient",void 0),c(this,"_log",void 0),this._capiSDUIClient=t,this._log=o.Bx.Logging.getLogger("SDUIFeedbackServiceImpl")}var t,i;return t=e,(i=[{key:"sendUserAction",value:function(e,t){var i=this;this._log.debug("Sending user action",{componentId:e,userAction:t}),(0,n.pipe)(this._capiSDUIClient.sendUserAction(e,t),r.hq,(function(e){return e.catch((function(e){s.zN.isDroppedError(e)?i._log.debug("Stopped listening for sendUserAction message acknowledge",e):s.Xb.isNotConnectedError(e)?i._log.warn("Failed to sendUserAction as CAPI was not connected",e):i._log.error("Failed to sendUserAction",e)}))}))}}])&&a(t.prototype,i),e}()},41668:(e,t,i)=>{i.d(t,{s:()=>f});var n=i(69063),s=i(12486),r=i(85262),o=i(44297),a=i(59042),c=i(80837),d=i(89769),l=i(65621),h=i(15491),u=i(14018),_=i(30040);function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function g(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function m(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var f=function(){function e(t){var i=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),m(this,"_state",new Map),m(this,"_subs",new c.y.Keeper),m(this,"_log",n.Bx.Logging.getLogger("SDUIInlineManager",s.$.TRACE,s.I.Manager.getColor())),this._subs.push(t.pipe(d.Z(u.k.empty),l.J(),h.T((function(e){var t,i,n=(i=2,function(e){if(Array.isArray(e))return e}(t=e)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var n,s,r=[],o=!0,a=!1;try{for(i=i.call(e);!(o=(n=i.next()).done)&&(r.push(n.value),!t||r.length!==t);o=!0);}catch(e){a=!0,s=e}finally{try{o||null==i.return||i.return()}finally{if(a)throw s}}return r}}(t,i)||function(e,t){if(e){if("string"==typeof e)return p(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?p(e,t):void 0}}(t,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),s=n[0],r=n[1];return u.k.diff(s,r)})),h.T((function(e){return i._processSDUIItems(e)}))).subscribe())}var t,i;return t=e,(i=[{key:"getInlineItemForAlert",value:function(e){return o.fromNullable(this._state.get(e))}},{key:"_processSDUIItems",value:function(e){var t=this;(0,_.pipe)(e,a.b.forEach((function(e){v(e)&&(t._log.trace("inline item removed",{alertIds:e.alertIds,itemId:e.id}),e.alertIds.forEach((function(e){return t._state.delete(e)})))}),(function(e,i){v(i)&&(t._log.trace("inline item updated",{alertIds:i.alertIds,itemId:i.id}),i.alertIds.forEach((function(e){return t._state.set(e,i)})))}),(function(e){v(e)&&(t._log.trace("inline item added",{alertIds:e.alertIds,itemId:e.id}),e.alertIds.forEach((function(i){return t._state.set(i,e)})))})))}},{key:"dispose",value:function(){this._subs.dispose()}}])&&g(t.prototype,i),e}(),v=function(e){return(0,_.pipe)(r.cK.findFirst(e.content,"inlineCard"),o.isSome)}},39902:(e,t,i)=>{i.d(t,{$:()=>l});var n=i(50659),s=i(22773),r=i(42061),o=i(53651),a=i(8966),c=i(99331),d=i(74836);const l=n.forwardRef((function(e,t){var i,l;const{buttonProps:h,isPressed:u,ref:_,inProgress:p,variant:g}=(0,s.aC)(e,t),m=null!=(i=e.accessibilityLabel)?i:e.text,{isFocusVisible:f,focusProps:v}=(0,r.og)();let b=e.iconEnd,S=e.iconStart;"premium"===g&&(null!=e.iconEnd&&(b=a.p),null!=e.iconStart&&(S=a.p)),"pro"===g&&(b=void 0,null!=e.iconStart&&(S=c.c)),"enterprise"===g&&(b=void 0,S=void 0);const y="small"===e.size?"text-xsmall":"text-small";return n.createElement("button",{className:(0,s.uB)(e,u,p,f),tabIndex:null!=(l=e.tabIndex)?l:0,ref:_,...h,...v},null!=S&&n.createElement(o.I,{icon:S,accessibilityLabel:m,variant:"inherit"}),n.createElement(d.E,{as:"span",variant:y,weight:["primary","ghost","premium","pro","enterprise","critical"].includes(g)?"bold":"normal"},e.text),null!=b&&n.createElement(o.I,{icon:b,accessibilityLabel:m,variant:"inherit"}),null!=e.shortcut&&!["premium","critical","pro","enterprise"].includes(g)&&n.createElement(d.E,{variant:y,className:"gds-button-shortcut",as:"kbd"},e.shortcut))}))},20015:(e,t,i)=>{i.d(t,{R:()=>s});var n=i(50659);const s=(0,i(13970).w)("color",(({title:e,titleId:t,desc:i,descId:s,...r})=>n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",viewBox:"0 0 16 16","aria-hidden":"true",stroke:"transparent","aria-labelledby":t,"aria-describedby":s,...r},i?n.createElement("desc",{id:s},i):null,e?n.createElement("title",{id:t},e):null,n.createElement("path",{stroke:"#646B81",strokeLinecap:"round",d:"m2 3 5 5-5 5M9 3l5 5-5 5"}))))}}]);