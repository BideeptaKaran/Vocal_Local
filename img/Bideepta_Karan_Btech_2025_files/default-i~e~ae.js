"use strict";(self.webpackChunk_grammarly_denali_app=self.webpackChunk_grammarly_denali_app||[]).push([[8469],{59815:(e,t,r)=>{r.d(t,{Z:()=>i});var o,i,n=r(10334),s=r(17171),a=r(58889),l=r(30040),u=r(96797),c=r(80074),p=r(42902),d=r(5692),m=r(43308),g=r(78339),h=r(15491),f=r(95168),_=r(44297),E=r(22835),v=r(58193),w=r(69063),y=r(37107),U=r(86003),b=r(74194);!function(e){let t;!function(e){e.codec=u.NW({userAccount:b.bb.sharedCodec},"sharedState"),e.toPersistentState=e=>({userAccount:(0,s._)((0,n._)({},e.userAccount),{settings:y.tl.parse(y.Zb.read(e.userAccount.userProfile.id))})})}(t=e.Stored||(e.Stored={})),e.defaultPersistentState={userAccount:null},e.defaultState=e=>({authentication:e.userAccount?d.j.ok(e.userAccount):b.n6,userAccount:e.userAccount,online:!0})}(o||(o={})),function(e){var t=e.STATE_KEY="appState",r=e.QUERY_KEY="q";const i=U.u.getItemOfType(t,o.Stored.codec),n=U.u.setItemOfType(t,o.Stored.codec),s=U.u.getItemOfType(r,u.Yj),y=U.u.setItemOfType(r,u.Yj);let b;!function(e){const t=[{name:"page reload",active:()=>null!=performance&&performance.getEntriesByType("navigation").some((e=>"reload"===e.type))},{name:"external referrer",active:()=>!document.referrer.includes(location.origin)}];e.reasonToInvalidate=()=>(0,l.pipe)(t.find((e=>e.active())),_.fromNullable,_.map(E.Up("name")))}(b||(b={}));const S=(0,l.flow)(i,_.map(a.map(o.Stored.toPersistentState)),_.getOrElse((()=>a.right(o.defaultPersistentState))));function x(e){return null!==e&&d.j.isOk(e.subscription)}e.create=()=>{const e=w.Bx.Logging.getLogger("PersistentApp"),t=t=>{e.debug("Invalidating app state: ",t),U.u.clear()};(0,l.pipe)(b.reasonToInvalidate(),v.Mi(t));const r=(0,l.pipe)(S(),a.fold((t=>(t.forEach((({input:t,error:r})=>e.error("Error decoding persistent app state from session storage:",r,t))),U.u.clear(),o.defaultPersistentState)),(t=>(e.debug("Retrieved persistent app state from storage"),t)))),i=c.s.create(o.defaultState(r)),u=i.pipe(m.E("userAccount"),g.p(x),h.T((e=>({userAccount:E.cJ(e,"settings")}))),f.M((0,l.flow)(n,a.fold((t=>{e.error(t.message,t)}),(()=>{e.debug("App state persisted to session storage")}))))).subscribe(),d=(0,l.pipe)(location.search,_.fromPredicate((e=>e.startsWith("?"))),v.Mi(y),_.alt((0,l.flow)(s,_.chain(a.fold((t=>(t.forEach((({input:t,error:r})=>e.error("Error decoding persistent search query from session storage:",r,t))),_.none)),_.some)))),_.getOrElse((()=>"")));return{appState:i,query:new p.L(d),invalidate:t,dispose:()=>u.unsubscribe()}}}(i||(i={}))},82937:(e,t,r)=>{r.d(t,{h:()=>j});var o=r(10334),i=r(17171),n=r(69384),s=r(50659),a=r(30040),l=r(87574),u=r(19772),c=r(5692),p=r(35413),d=r(19711),m=r(83541),g=r(95168),h=r(15491),f=r(89769),_=r(78339),E=r(24946),v=r(44297),w=r(86562),y=r(29052);const U=e=>{const{isEligible:t,children:r}=e;return s.useEffect((()=>{if(t){var e;const t=document.createElement("script");t.type="text/javascript",t.innerHTML="(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-NPLPZQ89');",null===(e=document.querySelector("head"))||void 0===e||e.appendChild(t)}}),[t]),s.createElement(s.Fragment,null,r)};var b,S=r(11213),x=r(70932),C=r(16721),A=r(69063);!function(e){e.measure=function(){const e=A.Bx.Logging.getLogger("web_vitals"),t=A.Bx.TimeSeries.rootFemetrics;r.e(4233).then(r.bind(r,91849)).then((({onFCP:e,onFID:t,onLCP:r,onTTFB:o})=>{const i=new Promise((t=>e(t))),n=new Promise((e=>r(e))),s=new Promise((e=>t(e))),a=new Promise((e=>o(e)));return Promise.all([i,n,s,a])})).then((([r,o,i,n])=>{const s=window.location.href.includes("grammarly.com/ddocs/")?"editor":"myGrammarly";e.info("Web vitals",{fcp:r,lcp:o,fid:i,ttfb:n,page:s}),t.getTimer("webVitals_fcp").setContext({page:s}).recordTime(r.value),t.getTimer("webVitals_lcp").setContext({page:s}).recordTime(o.value),t.getTimer("webVitals_fid").setContext({page:s}).recordTime(i.value),t.getTimer("webVitals_ttfb").setContext({page:s}).recordTime(n.value)})).catch((t=>e.error("Couldn't measure web-vitals",t)))}}(b||(b={}));var T=r(74056),P=r(74194),k=r(22409);function j(e,t,r,n,a){return(l,u,c)=>(0,i._)((0,o._)({},u.route),{component:o=>s.createElement(F,{type:l,isPrivate:!0===u.route.private,modelFactory:e,telemetryContext:r,config:n,router:t,globalExperiment:a},(e=>c(e)(o)))})}function F(e){var{router:t,telemetryContext:r,config:l,children:u,globalExperiment:c=(0,a.constant)(v.none)}=e,p=(0,n._)(e,["router","telemetryContext","config","children","globalExperiment"]);return s.createElement(I,p,(e=>s.createElement(C.Y.ContextProvider,(0,i._)((0,o._)({gnarSpec:e.telemetry.gnarSpec},r),{sessionUuidGetter:()=>v.none}),!0===p.isPrivate?s.createElement("div",null,s.createElement(L,{authentication:e.authentication,onUserReady:()=>(0,a.pipe)(c(e,t),O(e),v.getOrElse((()=>s.createElement(U,{isEligible:"prod"===l.env&&e.userAccount.features.denali.isEligibleForGtm},u(e))))),config:l,model:e})):u(e))))}function I({type:e,modelFactory:t,children:o}){const i=p.v((()=>(0,a.pipe)(I.models.get(e),v.fromNullable,v.fold((()=>{switch(e){case"my-grammarly":return Promise.all([r.e(8928),r.e(6352),r.e(5504),r.e(4523)]).then(r.bind(r,68945)).then((({createMyGrammarlyAppModel:e})=>t(e)));case"editor":return Promise.all([r.e(2688),r.e(8928),r.e(6352),r.e(7555),r.e(4025),r.e(1084),r.e(5504),r.e(6669)]).then(r.bind(r,78196)).then((({createEditorAppModel:e})=>t(e)));case"anonymous-editor":return Promise.all([r.e(8928),r.e(5504),r.e(4643)]).then(r.bind(r,95357)).then((({createAnonymousEditorAppModel:e})=>t(e)));default:return(0,w.xb)(e)}}),(e=>Promise.resolve(e)))))).pipe(d.$(),m.shareReplay({refCount:!0,bufferSize:1}));return u.R.useSubscriptionTo(i.pipe(g.M((t=>I.models.set(e,t))))),s.createElement(l.F.Fragment,null,i.pipe(h.T(o),f.Z(s.createElement(k.y,{className:S.A.spinner}))))}function L({authentication:e,onUserReady:t,model:r}){const o=s.useContext(T.OH.Context),i=e.status.get();if(c.j.isIdle(i))throw(0,a.pipe)(e.ensureAuthenticated(),y.qE((e=>{e===P.lR.UnauthorizedError&&o.actions.showSigninView()})))();if(c.j.isTerminated(i)){if(c.j.isFatal(i))return s.createElement(x.l,null);if(c.j.isOk(i)){if(r.isReady.get())return t();throw r.isReady.pipe(_.p(Boolean),E.s(1)).toPromise()}return(0,w.xb)(i)}throw e.status.pipe(_.p(c.j.isTerminated),d.$()).toPromise()}I.models=new Map;const O=e=>(e.userAccount.features.trackWebVitals&&b.measure(),a.identity)},74194:(e,t,r)=>{r.d(t,{lR:()=>N,EL:()=>H,bb:()=>W,n6:()=>z});var o=r(83531),i=r(23988),n=r(10334),s=r(17171),a=r(89606),l=r(10047),u=r(83293),c=r(30040),p=r(63336),d=r(96797),m=r(21296),g=r(9777),h=r(99678),f=r(19285),_=r(63724),E=r(5692),v=r(85076),w=r(6987),y=r(7323),U=r(21216),b=r(19711),S=r(95168),x=r(15491),C=r(44297),A=r(29052),T=r(77396),P=r(58889),k=r(86562),j=r(10117),F=r(47370),I=r(28421),L=r(69063),O=r(21538);const R=["clientControls","blockedClients"];var N,B=r(98969),D=r(58687),M=r(58434),q=r(37107),G=r(40464);!function(e){e.CannotUseEditorError="CannotUseEditorError",e.UnknownNetworkError="UnknownNetworkError",e.UnauthorizedError="UserUnauthorizedError",e.UnknownClientError="UnknownClientError",e.UnknownServerError="UnknownServerError"}(N||(N={})),(N||(N={})).fromAjaxErr=function(e){return e instanceof g.GI?N.UnknownNetworkError:401===e.code||403===e.code?N.UnauthorizedError:e.code>=400||e.code<500?N.UnknownClientError:N.UnknownServerError};const z=E.j.defaultValue();var W,V;!function(e){e.sharedCodec=d.E$([M.x.sharedCodec,d.NW({clientControls:M.kz.codec})])}(W||(W={})),function(e){e.parseUserProfileJSON=function(e,t,r,o,i,a){var l;const u=new Set(e.groups.filter(Boolean)),c="Free"===e.type?D.ut.free:"Premium"===e.type?D.ut.premium:(()=>{throw new Error(`Unknown user type ${e.type}`)})();var d;return{userProfile:{isPaymentSandbox:Boolean(Boolean(e.customFields)&&e.customFields["sandbox.payments"]),id:e.id,confirmed:e.confirmed,email:e.email,newEmail:e.newEmail,fullName:e.name,isTest:e.isTest||!1,canUseEditor:"Premium"===e.type||e.freemium||!1,groups:u,type:c,role:(0,p.pipe)(e.customFields.frontend_role,C.fromNullable),roles:(0,p.pipe)(null!==(d=null===(l=e)||void 0===l?void 0:l.roles)&&void 0!==d?d:[]),loginType:e.loginType,registrationDate:(0,p.pipe)(e.registrationDate,C.fromNullable,C.map((e=>new Date(e)))),editorFeatures:e.editorFeatures,institutionInfo:(0,p.pipe)(C.fromNullable(e.institutionInfo),C.map((e=>(0,s._)((0,n._)({},e),{trueUpSchedule:i}))))},subscription:G.n6,settings:t,experiments:r,clientControls:o,entitlements:(0,p.pipe)(a,C.map(B.b.fromPassport))}}}(V||(V={}));class Z extends g.Hl{constructor(){super({code:403,status:"error",message:"User is anonymous"})}}class Y extends g.Hl{constructor(){super({code:0,status:"error",message:"User cannot use editor"})}}class H{navigateToSigninOrRefresh(){return(0,p.pipe)(this._getUserSession(),A.AU((()=>u.fromIO((()=>{this._environment.actions.showSigninView()}))),(()=>u.fromIO((()=>this._environment.actions.refresh())))))}ensureAuthenticated(){return E.j.isIdle(this._state.get())?(this._state.modify(E.j.begin),(0,p.pipe)(this._getUserSession(),T.qI((e=>(setTimeout((()=>{this._onAuthenticated(e,this._logoutRD),this._state.modify(E.j.success(e))}),0),e.userProfile.canUseEditor?A.pG(void 0):A.kb(new Y)))),A.qE(this._handleAuthError))):A.pG(void 0)}_getTrueUpSchedule(e){var t,r;const o=u.of(C.none),i=null===(t=e.roles)||void 0===t?void 0:t.map((e=>e.role)).includes(h.KJ.InstitutionRoleName.Admin);return"BUSINESS"!==(null===(r=e.institutionInfo)||void 0===r?void 0:r.organizationType)||!0!==i?o:(0,p.pipe)(A.TX((()=>this._institution.getTrueUpSchedule()),P.toError),A.cy((e=>A.pG({isTrueUpEligible:e.isEligible,overageSeats:e.overageSeats,nextTrueUpBillingDate:e.nextTrueUpBillingDate}))),A.qE((e=>this._log.warn("get true up data error: Failed to get true up data",e))),A.AU((0,c.constant)(o),(0,c.flow)(C.some,u.of)))}_getClientControls(e){const t=u.of(C.none);return Boolean(e.institutionInfo)?(0,p.pipe)(this._settingsRegistry.getMergedSettings({settings:R}),A.qE((e=>this._log.warn("client controls error: Failed to get client controls config",e))),A.AU((0,c.constant)(t),(0,c.flow)(C.map(O.q),u.of))):t}_getSpecialOffers(e){const t=u.of(void 0);return e?u.of(this._vitoClient.requestSpecialOffersEligibility(["free_trial_rollout","free_trial_new_users","free_trial_eu_uk"])):t}_getUserSession(){let e=1;const t=v.l(this._authApi.getUser(["sandbox.payments","frontend_role"]),[m.limitRetries(5),m.exponentialBackoff(5e3)],(t=>{this._log.error("authError: getUser failed",t,{attempt:e++});const r=N.fromAjaxErr(t);switch(r){case N.CannotUseEditorError:case N.UnauthorizedError:return!1;case N.UnknownNetworkError:case N.UnknownClientError:case N.UnknownServerError:return!0;default:return(0,k.xb)(r)}}));return(0,p.pipe)(t,w.n(j.AU({onInProgress:()=>y.t,onSuccess:e=>U.of(P.right(e)),onError:()=>y.t,onFatal:e=>U.of(P.left(e))})),b.$(),(e=>()=>e.toPromise()),A.Pm((e=>!e.anonymous),(()=>new Z)),A.cy((e=>(0,p.pipe)(a.C(u.ApplicativePar)(this._getUserMimicWithProps,this._getTrueUpSchedule(e),this._getClientControls(e),this._getTreatments,this._getPassport,this._getSpecialOffers(e.free)),A.M1,A.Tj((([t,r,o,,i])=>({trueUpSchedule:r,authData:e,dapiData:t,clientControls:o,passport:i})))))),A.Tj((({authData:e,dapiData:t,clientControls:r,trueUpSchedule:o,passport:i})=>{const n=q.tl.parse(t.properties,q.Zb.read(e.id));return(0,p.pipe)(q.tl.serialize(n),P.fold((()=>{this._log.warn("_getUserSession: Cannot serialize user settings",n)}),(t=>q.Zb.write(e.id,t)))),V.parseUserProfileJSON(e,n,t.experiments,r,o,i)})))}_authenticateOnPersistentSession(){const e=this._state.get();E.j.isOk(e)&&a.C(u.ApplicativePar)(this._getTreatments,this._getSpecialOffers(e.value.userProfile.type===D.ut.free))().finally((()=>this._onAuthenticated(e.value,this._logoutRD)))}_validateExperimentGroups(e){var t=this;return(0,o._)((function*(){try{const r=yield t._cookies.safeGetValue("experiment_groups");void 0===r?t._expLog.warn("'experiment_groups' has empty value",{groupsFromDapiResponse:e}):l.nZ(F.kK).equals(e,r.split("|"))||t._expLog.warn("'experiment_groups' and DAPI groups are unequal",{groupsFromDapiResponse:e,groupsFromCookies:r})}catch(e){t._expLog.warn("can not read 'experiment_groups' cookie",e)}}))()}constructor(e,t,r,o,n,s,a,l,d,h,w,y,U){(0,i._)(this,"_state",void 0),(0,i._)(this,"_authApi",void 0),(0,i._)(this,"_dapi",void 0),(0,i._)(this,"_institution",void 0),(0,i._)(this,"_experimentClient",void 0),(0,i._)(this,"_settingsRegistry",void 0),(0,i._)(this,"_passportClient",void 0),(0,i._)(this,"_onAuthenticated",void 0),(0,i._)(this,"_telemetry",void 0),(0,i._)(this,"_cookies",void 0),(0,i._)(this,"_environment",void 0),(0,i._)(this,"_vitoClient",void 0),(0,i._)(this,"_onAuthError",void 0),(0,i._)(this,"_log",void 0),(0,i._)(this,"status",void 0),(0,i._)(this,"_handleAuthError",void 0),(0,i._)(this,"_getTreatments",void 0),(0,i._)(this,"_getUserMimicWithProps",void 0),(0,i._)(this,"_getPassport",void 0),(0,i._)(this,"_logoutRD",void 0),(0,i._)(this,"_expLog",void 0),this._state=e,this._authApi=t,this._dapi=r,this._institution=o,this._experimentClient=n,this._settingsRegistry=s,this._passportClient=a,this._onAuthenticated=l,this._telemetry=d,this._cookies=h,this._environment=w,this._vitoClient=y,this._onAuthError=U,this._log=L.Bx.Logging.getLogger("model.authentication"),this.status=this._state.view((e=>E.j.map(e,(e=>e)))),this._handleAuthError=e=>{this._onAuthError();const t=e instanceof Y?N.CannotUseEditorError:N.fromAjaxErr(e);switch(t){case N.CannotUseEditorError:this._log.info("authError: Cannot use editor",e,t),this._state.modify(E.j.error(t));break;case N.UnauthorizedError:this._log.warn("authError: Bad user session",e,t),this._state.modify(E.j.error(t));break;case N.UnknownNetworkError:case N.UnknownClientError:case N.UnknownServerError:this._log.fatal("authError: Failed to get user session",e,t),this._state.modify(E.j.fatal(t));break;default:return(0,k.xb)(t)}return t},this._getTreatments=()=>this._experimentClient.fetchTreatments().catch((e=>{this._log.warn("Failed to fetch treatments",e)})),this._getUserMimicWithProps=(0,p.pipe)(this._telemetry.getContainerId,u.chain((e=>this._dapi.getMimicWithProps(e))),A.W6((e=>A.TX((()=>this._validateExperimentGroups(Array.from(e.experiments))),P.toError))),A.WL((e=>(this._log.warn("dapiError: Failed to get dapi props and mimic groups",e),u.of({experiments:new Set,properties:_.OA.of({})}))))),this._getPassport=(0,p.pipe)(A.TX((()=>this._passportClient.getPassport([f.t.Feature.BrandingSet])),P.toError),A.AU((e=>(this._log.warn("Failed to get a passport",e),u.of(C.none))),(0,c.flow)(C.some,u.of))),this._logoutRD=(0,p.pipe)(v.l(this._authApi.logout(),[m.limitRetries(5),m.exponentialBackoff(5e3)],J),S.M((e=>{this._log.info("logout state change",e),I.oJ(e)?(0,p.pipe)(this._environment.actions.afterLogout(),P.mapLeft((e=>this._log.error("env error during logout",e)))):I.BG(e)&&(e.error instanceof g.Hl&&401===e.error.code?this._environment.actions.exit("missing user session"):this._log.error("Logout error",e.error))})),x.T(j.qE(N.fromAjaxErr))),this._expLog=this._log.getLogger("validate_experiments"),this._authenticateOnPersistentSession()}}function J(e){const t=N.fromAjaxErr(e);return t===N.UnknownNetworkError||t===N.UnknownServerError}}}]);