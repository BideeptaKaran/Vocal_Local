"use strict";(self.webpackChunk_grammarly_denali_app=self.webpackChunk_grammarly_denali_app||[]).push([[7444],{65772:(e,n,t)=>{t.d(n,{G:()=>o});var i=t(83531),s=t(19147),r=t(23988),a=t(1059),o=function e(n,t){var o=this;(0,s._)(this,e),(0,r._)(this,"_innerWSHandler",void 0),(0,r._)(this,"accessToken",void 0),(0,r._)(this,"onConnecting",void 0),(0,r._)(this,"onConnect",void 0),(0,r._)(this,"onDisconnect",void 0),(0,r._)(this,"onMessage",void 0),(0,r._)(this,"connect",void 0),(0,r._)(this,"isDisconnected",void 0),this._innerWSHandler=n,this.accessToken=t,this.onConnecting=function(e){return o._innerWSHandler.onConnecting(e),o},this.onConnect=function(e){return o._innerWSHandler.onConnect(e),o},this.onDisconnect=function(e){return o._innerWSHandler.onDisconnect(e),o},this.onMessage=function(e){return o._innerWSHandler.onMessage(e),o};var c,u=this;this.connect=(c=(0,i._)((function(e){var n,t,i;return(0,a.YH)(this,(function(s){switch(s.label){case 0:return"function"!=typeof u.accessToken?[3,2]:[4,u.accessToken()];case 1:return t=s.sent(),[3,3];case 2:t=void 0,s.label=3;case 3:return void 0!==(n=t)&&((i=new URL(e)).searchParams.append("accessToken",n),e=i.toString()),[2,u._innerWSHandler.connect(e)]}}))})),function(e){return c.apply(this,arguments)}),this.isDisconnected=function(){return o._innerWSHandler.isDisconnected()}}},71937:(e,n,t)=>{t.d(n,{DG:()=>i,V$:()=>g,sV:()=>s});var i,s,r=t(83531),a=t(19147),o=t(6922),c=t(23988),u=t(1059),_=t(69063),d=t(12486),l=t(69545),h=t(52138);!function(e){e[e.DISCONNECTED=0]="DISCONNECTED",e[e.IDLE=1]="IDLE",e[e.CONNECTING=2]="CONNECTING",e[e.INITIALIZING=3]="INITIALIZING",e[e.CONNECTED=4]="CONNECTED",e[e.READY=5]="READY",e[e.WAIT_ACK=6]="WAIT_ACK",e[e.CLOSED=7]="CLOSED"}(i||(i={})),function(e){e[e.CONNECT=0]="CONNECT",e[e.CONNECTED=1]="CONNECTED",e[e.SCHEDULE_RECONNECT=2]="SCHEDULE_RECONNECT",e[e.DISCONNECT=3]="DISCONNECT",e[e.IDLE_DISCONNECT=4]="IDLE_DISCONNECT",e[e.CLOSE=5]="CLOSE",e[e.INITIALIZE=6]="INITIALIZE",e[e.INITIALIZED=7]="INITIALIZED",e[e.SEND=8]="SEND",e[e.ACK=9]="ACK",e[e.RESET=10]="RESET"}(s||(s={}));var g=function(){function e(n,t){var r=this;(0,a._)(this,e),(0,c._)(this,"_originalUrl",void 0),(0,c._)(this,"_log",void 0),(0,c._)(this,"_fsm",void 0),(0,c._)(this,"_conn",void 0),(0,c._)(this,"_timeout",void 0),(0,c._)(this,"_error",void 0),(0,c._)(this,"_msgCount",void 0),(0,c._)(this,"_initHandler",void 0),(0,c._)(this,"_initFailHandler",void 0),this._originalUrl=n,this._log=_.Bx.Logging.getLogger("coreclients.remote",d.$.DEBUG),this._msgCount=0,t.onConnecting((function(){return r._handleConnecting()})).onConnect((function(e){return r._handleConnect(e)})).onDisconnect((function(e){return r._msgCount=0,r._handleDisconnect(e)})).onMessage((function(e,n){r._msgCount++,r._handleMessage(n)})),this._fsm=new l.Z3("remote",i.DISCONNECTED,i.CLOSED).from(i.DISCONNECTED,i.IDLE).to(i.CONNECTING).on(s.CONNECT).from(i.CONNECTING).to(i.CONNECTED).on(s.CONNECTED).from(i.CONNECTED).to(i.INITIALIZING).on(s.INITIALIZE).from(i.INITIALIZING).to(i.READY).on(s.INITIALIZED).from(i.CONNECTED,i.CONNECTING,i.INITIALIZING,i.READY).to(i.DISCONNECTED).on(s.DISCONNECT).from(i.CONNECTED,i.CONNECTING,i.INITIALIZING,i.READY,i.DISCONNECTED).to(i.CLOSED).on(s.CLOSE),this._log.isEnabled(d.$.TRACE)&&this._fsm.verbose(i,s)}return(0,o._)(e,[{key:"getWsUrl",value:function(){return this._originalUrl}},{key:"init",value:function(e,n){this._log.debug("init"),this._initHandler=e,this._initFailHandler=n}},{key:"close",value:function(e,n){var t=this;return this._log.debug("close(".concat(i[this._fsm.current],")"),{code:e,reason:n}),this._fsm.event(s.CLOSE,{code:e,reason:n}).then((function(e){e&&clearTimeout(t._timeout)}))}},{key:"isClosed",value:function(){return this._fsm.is(i.CLOSED)}},{key:"_handleConnecting",value:function(){var e=this;return(0,r._)((function(){return(0,u.YH)(this,(function(n){switch(n.label){case 0:return e._log.debug("Connecting"),[4,e._fsm.event(s.CONNECT)];case 1:return n.sent()||e._log.error("Can not enter CONNECTING state",{fsmState:i[e._fsm.current]}),[2]}}))}))()}},{key:"_handleConnect",value:function(e){var n=this;return(0,r._)((function(){return(0,u.YH)(this,(function(t){switch(t.label){case 0:return n._log.debug("Connected"),[4,n._fsm.event(s.CONNECTED,e)];case 1:return t.sent()?(n._conn=e,[3,4]):[3,2];case 2:return n._log.error("Can not enter CONNECTED state",{fsmState:i[n._fsm.current]}),[4,e.close({reason:"Can not enter CONNECTED state",code:h.C.WsCodes.NORMAL_CLOSURE})];case 3:t.sent(),t.label=4;case 4:return[2]}}))}))()}},{key:"_handleDisconnect",value:function(e){var n=this;return(0,r._)((function(){var t;return(0,u.YH)(this,(function(r){switch(r.label){case 0:return n._log.debug("Disconnected",e.reason),n._disconnectHandler(e),t=n.isClosed()?d.$.WARN:d.$.ERROR,[4,n._fsm.event(s.DISCONNECT,e)];case 1:return r.sent()||n._log.log(t,"Can not enter DISCONNECTED state",{reason:e,fsmState:i[n._fsm.current]}),[2]}}))}))()}},{key:"_canSend",value:function(){return!this._fsm.is(i.DISCONNECTED,i.CONNECTING,i.CLOSED)}}]),e}()},92422:(e,n,t)=>{t.d(n,{b:()=>q,N:()=>V});var i,s=t(39695),r=t(83531),a=t(19147),o=t(6922),c=t(23988),u=t(29573),_=t(10334),d=t(17171),l=t(32557),h=t(1059),g=t(83293),f=t(30040),v=t(63336),p=t(83062),m=t(36840),C=t(29052),I=t(44297),E=t(86562),D=t(58889),N=t(55172),T=t(34717),y=t(12486),S=t(33060),k=t(88105),O=t(28986),b=t(49004),w=t(52138),R=t(91242),H=t(58526),A=t(36465);!function(e){var n=function e(n){(0,a._)(this,e),(0,c._)(this,"id",void 0),(0,c._)(this,"action",void 0),this.id=n};e.Base=n;var t=function(e){(0,u._)(t,e);var n=(0,l._)(t);function t(e,i,r,o,u,_){var d;return(0,a._)(this,t),d=n.call(this,e),(0,c._)((0,s._)(d),"id",void 0),(0,c._)((0,s._)(d),"cl",void 0),(0,c._)((0,s._)(d),"rev",void 0),(0,c._)((0,s._)(d),"doc_len",void 0),(0,c._)((0,s._)(d),"deltas",void 0),(0,c._)((0,s._)(d),"revAfterApply",void 0),(0,c._)((0,s._)(d),"op",void 0),d.id=e,d.cl=i,d.rev=r,d.doc_len=o,d.deltas=u,d.revAfterApply=_,d.op="patch",d}return t}(n);e.PatchMessage=t;var i=function(e){(0,u._)(t,e);var n=(0,l._)(t);function t(e,i){var r;return(0,a._)(this,t),r=n.call(this,e),(0,c._)((0,s._)(r),"id",void 0),(0,c._)((0,s._)(r),"vsn",void 0),(0,c._)((0,s._)(r),"op",void 0),r.id=e,r.vsn=i,r.op="vsn",r}return t}(n);e.VersionMessage=i;var r=function(e){(0,u._)(t,e);var n=(0,l._)(t);function t(e,i,r,o){var u;return(0,a._)(this,t),u=n.call(this,e),(0,c._)((0,s._)(u),"id",void 0),(0,c._)((0,s._)(u),"title",void 0),(0,c._)((0,s._)(u),"errors",void 0),(0,c._)((0,s._)(u),"extra_params",void 0),(0,c._)((0,s._)(u),"op",void 0),u.id=e,u.title=i,u.errors=r,u.extra_params=o,u.op="update_document_metadata",u}return t}(n);e.UpdateDocumentMetadata=r;var o=function(e){(0,u._)(t,e);var n=(0,l._)(t);function t(e){var i;return(0,a._)(this,t),i=n.call(this,e),(0,c._)((0,s._)(i),"id",void 0),(0,c._)((0,s._)(i),"op",void 0),i.id=e,i.op="proofit_turnaround_options",i}return t}(n);e.ProofitOptionsMessage=o;var _=function(e){(0,u._)(t,e);var n=(0,l._)(t);function t(e,i,r,o,u){var _,d=arguments.length>5&&void 0!==arguments[5]&&arguments[5];return(0,a._)(this,t),_=n.call(this,e),(0,c._)((0,s._)(_),"id",void 0),(0,c._)((0,s._)(_),"turnaround",void 0),(0,c._)((0,s._)(_),"clarity",void 0),(0,c._)((0,s._)(_),"userInputs",void 0),(0,c._)((0,s._)(_),"priceOfferId",void 0),(0,c._)((0,s._)(_),"payWithCredits",void 0),(0,c._)((0,s._)(_),"op",void 0),_.id=e,_.turnaround=i,_.clarity=r,_.userInputs=o,_.priceOfferId=u,_.payWithCredits=d,_.op="proofit_create_job",_}return t}(n);e.ProofitPlaceOrderMessage=_;var d=function(e){(0,u._)(t,e);var n=(0,l._)(t);function t(e,i,r,o,u){var _,d=arguments.length>5&&void 0!==arguments[5]&&arguments[5],l=arguments.length>6?arguments[6]:void 0,h=arguments.length>7?arguments[7]:void 0;return(0,a._)(this,t),_=n.call(this,e),(0,c._)((0,s._)(_),"id",void 0),(0,c._)((0,s._)(_),"turnaround",void 0),(0,c._)((0,s._)(_),"clarity",void 0),(0,c._)((0,s._)(_),"userInputs",void 0),(0,c._)((0,s._)(_),"priceOfferId",void 0),(0,c._)((0,s._)(_),"payWithCredits",void 0),(0,c._)((0,s._)(_),"nonce",void 0),(0,c._)((0,s._)(_),"billingZip",void 0),(0,c._)((0,s._)(_),"op",void 0),_.id=e,_.turnaround=i,_.clarity=r,_.userInputs=o,_.priceOfferId=u,_.payWithCredits=d,_.nonce=l,_.billingZip=h,_.op="proofit_create_job",_}return t}(n);e.ProofitPlacePaymentOrderMessage=d;var h=function(e){(0,u._)(t,e);var n=(0,l._)(t);function t(e){var i;return(0,a._)(this,t),i=n.call(this,e),(0,c._)((0,s._)(i),"id",void 0),(0,c._)((0,s._)(i),"op",void 0),i.id=e,i.op="proofit_statistics",i}return t}(n);e.ProofitStatisticsMessage=h;var g=function(e){(0,u._)(t,e);var n=(0,l._)(t);function t(e,i){var r;return(0,a._)(this,t),r=n.call(this,e),(0,c._)((0,s._)(r),"id",void 0),(0,c._)((0,s._)(r),"token",void 0),(0,c._)((0,s._)(r),"op",void 0),r.id=e,r.token=i,r.op="token_response",r}return t}(n);e.TokenResponse=g}(i||(i={}));var M,P=t(91817),L=t(56610);!function(e){e.isChange=function(e){return"change"===e.kind},e.isCmd=function(e){return"cmd"===e.kind},e.isMeta=function(e){return"meta"===e.kind}}(M||(M={}));var q,G=function(){function e(n,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];(0,a._)(this,e),(0,c._)(this,"_acceptHandler",void 0),(0,c._)(this,"_dropHandler",void 0),(0,c._)(this,"_changes",void 0),(0,c._)(this,"_staging",void 0),(0,c._)(this,"_queuedId",void 0),this._acceptHandler=n,this._dropHandler=t,this._changes=i,this._staging=!1,this._queuedId=0}return(0,o._)(e,[{key:"pushChanges",value:function(e){var n=this,t=this.isEmpty||this._staging&&1===this._changes.length?I.none:(0,v.pipe)(this._tail(),I.filter(M.isChange));return(0,v.pipe)(t,I.fold((function(){return n._enqueueChanges(b.zV.split(e,5e3))}),(function(t){var i=t.change.compose(e),s=(0,L._)(b.zV.split(i,5e3)),r=s[0],a=s.slice(1);if(n._replaceChange(n._changes.length-1,r),r.isEmpty){var o=n._changes.pop();setTimeout((function(){return n._acceptHandler(o)}),0)}return[t.id].concat(n._enqueueChanges(a))})))}},{key:"pushMeta",value:function(e){var n=this,t=this.isEmpty||this._staging&&1===this._changes.length?I.none:(0,v.pipe)(this._tail(),I.filter(M.isMeta));return(0,v.pipe)(t,I.fold((function(){var t=n._queuedId++;return n._changes.push({kind:"meta",meta:e,id:t}),t}),(function(n){return Object.assign(n.meta,e),n.id})))}},{key:"pushCommand",value:function(e){var n=this._queuedId++;return this._changes.push({kind:"cmd",cmd:e,id:n}),n}},{key:"isStaging",get:function(){return this._staging}},{key:"isEmpty",get:function(){return 0===this._changes.length}},{key:"size",get:function(){return this._changes.length}},{key:"poll",value:function(){var e=this;(0,E.V1)(!this._staging,"Should not be in staging mode");var n=I.fromNullable(this._changes[0]);return(0,v.pipe)(n,I.fold(m.Yi,(function(){return e._staging=!0}))),n}},{key:"pop",value:function(){(0,E.V1)(!this._staging,"Should not be in staging mode");var e=I.fromNullable(this._changes.shift());return(0,v.pipe)(e,I.fold(m.Yi,this._acceptHandler)),e}},{key:"unstage",value:function(){(0,E.V1)(this._staging,"Should be in staging mode"),(0,E.V1)(void 0!==this._changes[0],"Staging change should exist"),this._staging=!1}},{key:"ack",value:function(){this.unstage(),this.pop()}},{key:"transformChangeAgainstQueue",value:function(e){var n=this;return this._changes.reduce((function(e,t,i){if(M.isChange(t)){var s=t.change,r=s.transform(e,!1);return n._replaceChange(i,r),e.transform(s)}return e}),e)}},{key:"drop",value:function(e,n){if(!this.isEmpty){var t=(0,P._)(void 0===n?[this._changes,[]]:N.jB(this._changes,(function(e){return e.kind===n})),2),i=t[0],s=t[1];this._changes=s,i.length>0&&this._dropHandler({messages:i,reason:e})}}},{key:"toJSON",value:function(){return{changes:this._changes}}},{key:"_tail",value:function(){return I.fromNullable(this._changes[this._changes.length-1])}},{key:"_enqueueChanges",value:function(e){var n=this;return e.map((function(e){var t=n._queuedId++;return n._changes.push({kind:"change",change:e,id:t}),t}))}},{key:"_replaceChange",value:function(e,n){var t=this._changes[e];(0,E.V1)(M.isChange(t),"queued change should exist"),t.change=n}}]),e}(),W=t(71937),Q=t(32062),V=function(e){(0,u._)(t,e);var n=(0,l._)(t);function t(e,r,o){var u,_=arguments.length>3&&void 0!==arguments[3]?arguments[3]:q.Queue.create({}),d=arguments.length>4&&void 0!==arguments[4]?arguments[4]:500,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:15e3;return(0,a._)(this,t),u=n.call(this,e,r),(0,c._)((0,s._)(u),"_changesQueue",void 0),(0,c._)((0,s._)(u),"_sendDelay",void 0),(0,c._)((0,s._)(u),"_requestTimeout",void 0),(0,c._)((0,s._)(u),"_nextId",void 0),(0,c._)((0,s._)(u),"_revision",void 0),(0,c._)((0,s._)(u),"_clientId",void 0),(0,c._)((0,s._)(u),"_forceSend",void 0),(0,c._)((0,s._)(u),"_handler",void 0),(0,c._)((0,s._)(u),"_proofitPlansRequester",void 0),(0,c._)((0,s._)(u),"_proofitStatisticsRequester",void 0),(0,c._)((0,s._)(u),"_proofitCreateJobRequester",void 0),(0,c._)((0,s._)(u),"getProofitPlans",void 0),(0,c._)((0,s._)(u),"getProofitStatistics",void 0),(0,c._)((0,s._)(u),"_disconnectHandler",void 0),(0,c._)((0,s._)(u),"_resolvePendingFlushPromise",void 0),(0,c._)((0,s._)(u),"_flushPromise",void 0),u._changesQueue=_,u._sendDelay=d,u._requestTimeout=l,u._nextId=1,u._revision=-1,u._clientId=-1,u._forceSend=!1,u._proofitPlansRequester=new R.Wo(u._requestTimeout,"DOX.ProofitPlans"),u._proofitStatisticsRequester=new R.Wo(u._requestTimeout,"DOX.ProofitStatistics"),u._proofitCreateJobRequester=new R.Wo(u._requestTimeout,"DOX.ProofitCreateJob"),u.getProofitPlans=u._startRequestWatch(u._proofitPlansRequester,u._sendInbandCommand((function(e){return new i.ProofitOptionsMessage(e)}))),u.getProofitStatistics=u._startRequestWatch(u._proofitStatisticsRequester,u._sendInbandCommand((function(e){return new i.ProofitStatisticsMessage(e)}))),u._disconnectHandler=function(){u._changesQueue.isStaging&&(u._log.warn("Got disconnect while trying send changes"),u._changesQueue.unstage()),[u._proofitCreateJobRequester,u._proofitPlansRequester,u._proofitStatisticsRequester].forEach((function(e){return e.clear("disconnect")}))},u._resolvePendingFlushPromise=function(e){return(0,f.constVoid)()},u._handler=new q.DefaultHandler(o),u._fsm.from(W.DG.READY).to(W.DG.WAIT_ACK).on(W.sV.SEND).from(W.DG.WAIT_ACK).to(W.DG.READY).on(W.sV.ACK,W.sV.RESET).from(W.DG.WAIT_ACK).to(W.DG.DISCONNECTED).on(W.sV.DISCONNECT).from(W.DG.WAIT_ACK).to(W.DG.CLOSED).on(W.sV.CLOSE).on(W.DG.READY,(function(e){return u._trySendAfterTimeout()})).on(W.DG.CLOSED,(function(e){var n=Boolean(e.args)?e.args:null,t=n?new H.v0({code:n.code,status:A.h.CLOSED_ERROR.status,message:Boolean(n.reason)?n.reason:A.h.CLOSED_ERROR.message}):A.h.CLOSED_ERROR;u._failInit(t),u._changesQueue.drop("close")})).on(W.DG.DISCONNECTED,(function(){u._changesQueue.drop("disconnect","cmd")})),(0,m.hJ)("doxReset",(function(e){if(void 0===e)throw new Error("provide text!");u._handleResetMessage({op:"reset",id:u._nextId++,doc:(new O.R).insert(e),vsn:u._revision+10,clientId:u._clientId})})),(0,m.hJ)("doxState",(0,s._)(u)),(0,m.hJ)("closeDoxSocket",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,n=arguments.length>1?arguments[1]:void 0;u._conn._ws.close(e,n)})),u}return(0,o._)(t,[{key:"_isFirstConnect",get:function(){return null!=this._initHandler}},{key:"_startRequestWatch",value:function(e,n){return(0,v.pipe)(n,C.AU((function(e){return C.kb(e)}),(function(n){return function(){return e.watchRequest(n)}})))}},{key:"isInitialRevision",get:function(){return 1===this._revision}},{key:"fsmState",get:function(){return W.DG[this._fsm.current]}},{key:"placeProofitOrder",value:function(e,n){var t=p.c.PlanType[e.turnaround],s=e.tier===p.c.PlanTier.Clarity,r={dialect:I.toUndefined(e.userInputs.dialect),quotationType:I.toUndefined(e.userInputs.quotationType),spaceType:I.toUndefined(e.userInputs.spaceType),noteToEditor:I.toUndefined(e.userInputs.noteToEditor)},a=e.priceOfferId,o=e.payWithCredits,c=(0,v.pipe)(n,I.fold((function(){return function(e){return new i.ProofitPlaceOrderMessage(e,t,s,r,a,o)}}),(function(e){if(e.kind===S.b.creditCard){var n=e;return function(e){return new i.ProofitPlacePaymentOrderMessage(e,t,s,r,a,o,n.nonce,n.postalCode)}}if(e.kind===S.b.paypal){var c=e;return function(e){return new i.ProofitPlacePaymentOrderMessage(e,t,s,r,a,o,c.nonce)}}return(0,E.xb)(e)})));return this._startRequestWatch(this._proofitCreateJobRequester,this._sendInbandCommand(c))}},{key:"pushChanges",value:function(e){var n=this;return C.oF((function(){return n._pushChanges(e)}))}},{key:"updateMetadata",value:function(e){var n=this;return C.oF((function(){return n._updateMetadata(e)}))}},{key:"getWsUrl",value:function(){if(-1===this._revision)return this._originalUrl;var e=new URL(this._originalUrl);return e.searchParams.append("sinceVersion",String(this._revision)),e.toString()}},{key:"_handleMessage",value:function(e){var n=this;return(0,r._)((function(){var t;return(0,h.YH)(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,n._messageHandler(e)];case 1:return i.sent(),[3,3];case 2:return t=i.sent(),n._log.warn("Fail on processing incoming message",t),n._failInit(t),n._conn.close({code:w.C.WsCodes.CLIENT_MALFUNCTION,reason:"Unexpected failure on: ".concat((0,E.Cb)(t)?t.message:"")}),[3,3];case 3:return[2]}}))}))()}},{key:"_messageHandler",value:function(e){var n=this;return(0,r._)((function(){return(0,h.YH)(this,(function(t){switch(t.label){case 0:switch(n._log.isEnabled(y.$.TRACE)&&n._log.trace("Message <<<",{message:JSON.stringify(e)}),e.op){case"init":return[3,1];case"patch":return[3,3];case"reset":return[3,9];case"vsn":return[3,11];case"mongodb_change":return[3,12];case"document_metadata_changed":return[3,13];case"proofit_turnaround_options":return[3,14];case"proofit_create_job":return[3,15];case"proofit_statistics":return[3,16];case"token_request":return[3,17]}return[3,19];case 1:return[4,n._handleInitMessage(e)];case 2:return t.sent(),[3,20];case 3:return n._fsm.is(W.DG.READY)||n._fsm.is(W.DG.WAIT_ACK)&&n._clientId===e.cl?[4,n._handlePatchMessage(e)]:[3,5];case 4:return t.sent(),[3,8];case 5:return n._fsm.is(W.DG.WAIT_ACK)?(n._log.warn("got change while waiting ack for other change"),[4,n._handlePatchMessage(e)]):[3,7];case 6:return t.sent(),[3,8];case 7:n._log.warn("got unexpected patch message",{fsmState:W.DG[n._fsm.current]}),t.label=8;case 8:return[3,20];case 9:return[4,n._handleResetMessage(e)];case 10:return t.sent(),[3,20];case 11:case 12:return[3,20];case 13:return n._handleMetaChangeMessage(e),[3,20];case 14:return(0,v.pipe)(p.c.processOptions((0,f.unsafeCoerce)(e)),D.fold((function(t){return n._proofitPlansRequester.onError(e.id,t)}),(function(t){return n._proofitPlansRequester.onValue(e.id,t)}))),[3,20];case 15:return n._proofitCreateJobRequester.onValue(e.id,p.c.parseCreateJobResult(e)),[3,20];case 16:return n._proofitStatisticsRequester.onValue(e.id,p.c.processStatistics(e)),[3,20];case 17:return[4,n._handleUpdateTokenRequest()];case 18:return t.sent(),[3,20];case 19:e.error||(n._log.warn("Unexpected message",{message:e}),n._failInit(e)),t.label=20;case 20:return[2]}}))}))()}},{key:"_handleInitMessage",value:function(e){var n=this;return(0,r._)((function(){var t,s,r,a,o;return(0,h.YH)(this,(function(c){switch(c.label){case 0:return[4,n._fsm.event(W.sV.INITIALIZE)];case 1:return c.sent()?(t=void 0!==e.deltas?e.deltas:[]).length>0?(n._log.debug("Got changes on init. Skipping reset"),s=N.qI(t.map((function(e){return e.deltas}))),r=t[0].doc_len,a=t[0].rev,[4,n._handlePatchMessage(new i.PatchMessage(-1,-1,a,r,s,e.vsn),e.doc_len)]):[3,3]:[3,5];case 2:c.sent(),c.label=3;case 3:return o=new O.R(e.doc),n._initHandler?(n._log.trace("calling _initHandler"),n._initHandler({initialDelta:b.lY.unsafeRes(o),remoteDocument:n,meta:q.Meta.parse(e)}),n._initHandler=null,n._initFailHandler=null,n._clear(e)):0===t.length&&e.vsn!==n._revision?(n._log.debug("Remote has unknown revision, goto reset"),n._handleResetMessage({id:-1,op:"reset",clientId:e.clientId,vsn:e.vsn,doc:o})):n._clear(e),n._log.trace("Init complete, going to INITIALIZED"),[4,n._fsm.event(W.sV.INITIALIZED)];case 4:return c.sent(),[3,5];case 5:return[2]}}))}))()}},{key:"inSync",get:function(){return this._changesQueue.isEmpty&&!this._changesQueue.isStaging}},{key:"isStable",value:function(e){return void 0!==e&&void 0===e.error&&this._msgCount>5}},{key:"_handlePatchMessage",value:function(e,n){var t=this;return(0,r._)((function(){var s,r,a,o,c;return(0,h.YH)(this,(function(u){switch(u.label){case 0:return(s=e.cl===t._clientId)?(t._log.trace("got patch from same client"),[4,t._fsm.event(W.sV.ACK)]):[3,2];case 1:return u.sent()?(t._log.trace("got ack for patch"),t._changesQueue.ack()):t._log.debug("got patch message from same client, but we are in unexpected state",{state:W.DG[t._fsm.current]}),[3,3];case 2:t._log.trace("got patch from other client"),(0,R.vA)(t._revision,e.rev,"incoming patch should be on known revision"),t._handler.changeHandler(t,b.lY.flush()),r=k.E.squash(e.deltas),a=b.lY.delta(new O.R(r),e.doc_len),void 0!==n&&(0,R.vA)(n,a.length+a.prevLen,"validated doc_len should match"),t._log.isEnabled(y.$.TRACE)&&!t._changesQueue.isEmpty&&t._log.trace("received incoming change, while has outgoing changes",JSON.stringify(a)),o=t._changesQueue.transformChangeAgainstQueue(a),a.prevLen!==o.prevLen&&(t._log.debug("incoming delta changed prev_len after transform on queue",{was:a.prevLen,now:o.prevLen}),t._log.trace("incoming delta transformed to",o)),t._handler.changeHandler(t,o),u.label=3;case 3:t._revision=s?e.rev:void 0===e.revAfterApply?e.rev+1:e.revAfterApply,u.label=4;case 4:return u.trys.push([4,6,,7]),[4,t._conn.send(new i.VersionMessage(t._nextId++,e.rev))];case 5:return u.sent(),[3,7];case 6:return c=u.sent(),t._log.debug("fail onsend vsn ack",c),[3,7];case 7:return[2]}}))}))()}},{key:"_handleResetMessage",value:function(e){var n=this;return(0,r._)((function(){var t;return(0,h.YH)(this,(function(i){switch(i.label){case 0:return n._log.warn("Got RESET message. currently in ".concat(W.DG[n._fsm.current])),(t=n._fsm.is(W.DG.READY))?[3,2]:[4,n._fsm.event(W.sV.RESET)];case 1:t=i.sent(),i.label=2;case 2:return t?(n._changesQueue.isStaging&&(n._log.debug("We got reset while trying send changed"),n._changesQueue.unstage()),n._changesQueue.drop("got reset"),n._clear(e),n._handler.changeHandler(n,b.lY.unsafeRes(new O.R(e.doc)))):n._log.warn("Can not enter reset state, currently in ".concat(W.DG[n._fsm.current])),[2]}}))}))()}},{key:"_handleMetaChangeMessage",value:function(e){this._changesQueue.drop("got incoming meta","meta");var n=q.Meta.parse(e);this._handler.metadataChangeHandler(this,n)}},{key:"_handleUpdateTokenRequest",value:function(){var e=this;this._log.debug("_handleUpdateTokenRequest");var n=g.of((0,f.constVoid)());return(0,v.pipe)(this._handler.updateTokenHandler,C.cy(I.fold((function(){return C.pG("Token is missing")}),(function(n){return(0,v.pipe)(e._sendInbandCommand((function(e){return new i.TokenResponse(e,n)})),C.Tj((function(){return"Token updated"})))}))),C.AU((function(t){return e._log.warn("Fail on update token request",t),n}),(function(t){return e._log.debug(t),n})))()}},{key:"_failInit",value:function(e){this._initFailHandler&&(this._log.trace("_failInit(".concat(W.DG[this._fsm.current],")")),this._initFailHandler(e),this._initHandler=null,this._initFailHandler=null)}},{key:"_clear",value:function(e){var n=e.vsn,t=e.clientId;this._log.trace("_clear: resetting client id ".concat(this._clientId," -> ").concat(t,", revision ").concat(this._revision," -> ").concat(n)),this._nextId=1,this._clientId=t,this._revision=n}},{key:"flush",value:function(){var e=this;if(this._log.trace("flush(".concat(W.DG[this._fsm.current],")")),this._changesQueue.isEmpty)return this._resolvePendingFlushPromise(),Promise.resolve();if(!this._flushPromise){var n,t=function(){e._flushPromise=void 0,e._forceSend=!1,e._resolvePendingFlushPromise=f.constVoid,n&&clearTimeout(n)};this._flushPromise=new Promise((function(t,i){e._forceSend=!0,e._resolvePendingFlushPromise=t,n=window.setTimeout((function(){return i(new R.MU("flush takes too long"))}),4e3)})).then(t,(function(e){throw t(),e})),Boolean(this._timeout)&&(clearTimeout(this._timeout),this._timeout=void 0,this._trySendAfterTimeout())}return this._flushPromise}},{key:"_trySendAfterTimeout",value:function(){var e=this;Boolean(this._timeout)||(this._timeout=window.setTimeout((function(){e._timeout=void 0,e._fsm.is(W.DG.READY)?e._changesQueue.isEmpty||e._changesQueue.isStaging?(e._changesQueue.isEmpty&&e._resolvePendingFlushPromise(),e._trySendAfterTimeout()):e._send().catch((function(n){return e._log.warn("unexpected error onsend",n)})):e._log.trace("_trySendAfterTimeout: not in READY, stopping send loop")}),this._changesQueue.size>1||this._forceSend?this._changesQueue.isStaging?250:0:this._sendDelay))}},{key:"_send",value:function(){var e=this;return(0,r._)((function(){var n;return(0,h.YH)(this,(function(t){switch(t.label){case 0:return[4,e._fsm.event(W.sV.SEND)];case 1:return t.sent()?(n=e._changesQueue.poll(),[4,(0,v.pipe)(n,I.map((i=(0,r._)((function(n){var t,i,s;return(0,h.YH)(this,(function(r){switch(r.label){case 0:t=M.isChange(n),i=e._createMessage(n),e._log.isEnabled(y.$.TRACE)&&e._log.trace("Message >>>",{message:JSON.stringify(i)}),r.label=1;case 1:return r.trys.push([1,5,,6]),[4,e._conn.send(i)];case 2:return r.sent(),t?[3,4]:[4,e._fsm.event(W.sV.ACK)];case 3:r.sent()?e._changesQueue.ack():e._log.debug("can not do ack for non change msg because we are in unexpected state",{state:W.DG[e._fsm.current]}),r.label=4;case 4:return[3,6];case 5:return s=r.sent(),e._log.error("Got error on ws send: ".concat(JSON.stringify({error:s,connectionState:e._conn.state,fsmState:W.DG[e._fsm.current],queueSize:e._changesQueue.size,messageKind:n.kind},void 0,2))),[3,6];case 6:return[2]}}))})),function(e){return i.apply(this,arguments)})),I.getOrElse((function(){return Promise.resolve()})))]):[3,3];case 2:return t.sent(),[3,4];case 3:e._log.warn("we can not send"),t.label=4;case 4:return[2]}var i}))}))()}},{key:"_updateMetadata",value:function(e){return this._log.trace("_updateMetadata"),this._canSend()?D.right(this._changesQueue.pushMeta(e)):(this._log.debug("updateMetadata: cannot send, rejecting changes"),this._isFirstConnect?D.left({error:new R.Xb("Cannot send commands as WS connection is down"),queueId:I.none}):D.left({error:new R.Xb("Cannot send commands as WS connection is down"),queueId:I.some(this._changesQueue.pushMeta(e))}))}},{key:"_pushChanges",value:function(e){return this._log.trace("pushChanges: ".concat(e.kind)),b.lY.isDelta(e)?this._canSend()?D.right(this._changesQueue.pushChanges(e)):(this._log.debug("pushChanges: cannot send, rejecting changes"),this._isFirstConnect?D.left({error:new R.Xb("Cannot send commands as WS connection is down"),queueIds:I.none}):D.left({error:new R.Xb("Cannot send commands as WS connection is down"),queueIds:I.some(this._changesQueue.pushChanges(e))})):b.lY.isReset(e)?D.left({error:new Error("Invalid change. Reset changes are not supported by dox"),queueIds:I.none}):D.right([])}},{key:"_sendInbandCommand",value:function(e){var n=this;return C.oF((function(){var t=e(n._nextId++);if(n._log.trace("_sendInbandCommand:",t.op),!n._canSend())return n._log.warn("_sendInbandCommand: cannot send, rejecting command",t.op),D.left(new R.Xb("Cannot send commands as WS connection is down"));var i=n._changesQueue.isEmpty;return n._changesQueue.pushCommand(t),i&&n._fsm.is(W.DG.READY)&&(n._log.trace("Q.isEmpty, sending command immidiately",t),n._send()),D.right(t.id)}))}},{key:"_createMessage",value:function(e){switch(e.kind){case"change":return this._createPatchMessage(e.change);case"meta":return this._createUpdateMetaMessage(e.meta);case"cmd":return e.cmd;default:return(0,E.xb)(e)}}},{key:"_createPatchMessage",value:function(e){return new i.PatchMessage(this._nextId++,this._clientId,this._revision,e.prevLen,[e.delta])}},{key:"_createUpdateMetaMessage",value:function(e){var n=e.title,t=e.errors,s=e.settings;return new i.UpdateDocumentMetadata(this._nextId++,n,t,void 0!==s?s.toJSON():void 0)}}],[{key:"getWsDocumentUrl",value:function(e,n){var t=void 0===n?"/documents/ws":"/documents/".concat(n,"/ws");return"".concat(e).concat(t)}}]),t}(W.V$);!function(e){var n,t;(e.Meta||(e.Meta={})).parse=function(e){var n=e.title,t=e.errors,i=e.extra_params,s=e.proofit,r={title:n,errors:t,settings:Q.O.Holder.fromJSON(i),proofit:p.c.fromRaw(s)};return"init"===e.op?(0,d._)((0,_._)({},r),{isDemoDocument:Boolean(e.demo),createdAt:(0,v.pipe)(T.Local.parseDate(e.created_at),D.getOrElse((function(){return null}))),originalFilename:e.orig_filename}):r},e.DefaultHandler=function e(n){(0,a._)(this,e),(0,c._)(this,"_handler",void 0),(0,c._)(this,"changeHandler",void 0),(0,c._)(this,"metadataChangeHandler",void 0),(0,c._)(this,"connectHandler",void 0),(0,c._)(this,"disconnectHandler",void 0),(0,c._)(this,"updateTokenHandler",void 0),this._handler=n,this.changeHandler=this._handler.changeHandler||f.constVoid,this.metadataChangeHandler=this._handler.metadataChangeHandler||f.constVoid,this.connectHandler=this._handler.connectHandler||f.constVoid,this.disconnectHandler=this._handler.disconnectHandler||f.constVoid,this.updateTokenHandler=this._handler.updateTokenHandler||C.pG(I.none)},n=e.Queue||(e.Queue={}),t=function e(n){(0,a._)(this,e),(0,c._)(this,"_handler",void 0),(0,c._)(this,"acceptedMsgHandler",void 0),(0,c._)(this,"droppedMsgsHandler",void 0),this._handler=n,this.acceptedMsgHandler=this._handler.acceptedMsgHandler||function(){},this.droppedMsgsHandler=this._handler.droppedMsgsHandler||function(){}},n.DefaultHandler=t,n.create=function(e){var n=new t(e),i=n.acceptedMsgHandler,s=n.droppedMsgsHandler;return new G(i,s)}}(q||(q={}))}}]);